<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python 进阶 | Yan&#39;s Blog Home</title>
    <meta name="description" content="Personal blog site">
    
    
    <link rel="preload" href="/assets/css/0.styles.659f981c.css" as="style"><link rel="preload" href="/assets/js/app.2ba1140b.js" as="script"><link rel="preload" href="/assets/js/2.858e58ff.js" as="script"><link rel="preload" href="/assets/js/152.b64ef399.js" as="script"><link rel="prefetch" href="/assets/js/10.5dcc1f52.js"><link rel="prefetch" href="/assets/js/100.0327e00b.js"><link rel="prefetch" href="/assets/js/101.404f187c.js"><link rel="prefetch" href="/assets/js/102.d78878ec.js"><link rel="prefetch" href="/assets/js/103.a682f6f1.js"><link rel="prefetch" href="/assets/js/104.d831bcb5.js"><link rel="prefetch" href="/assets/js/105.afbf1884.js"><link rel="prefetch" href="/assets/js/106.8e9709d3.js"><link rel="prefetch" href="/assets/js/107.9712aa22.js"><link rel="prefetch" href="/assets/js/108.4158fdb6.js"><link rel="prefetch" href="/assets/js/109.ae61a303.js"><link rel="prefetch" href="/assets/js/11.34e3d90e.js"><link rel="prefetch" href="/assets/js/110.0abce6c9.js"><link rel="prefetch" href="/assets/js/111.b5c958e5.js"><link rel="prefetch" href="/assets/js/112.fdacfaf6.js"><link rel="prefetch" href="/assets/js/113.9d95243d.js"><link rel="prefetch" href="/assets/js/114.f759f9b9.js"><link rel="prefetch" href="/assets/js/115.1b1f9f3d.js"><link rel="prefetch" href="/assets/js/116.1e5e62e4.js"><link rel="prefetch" href="/assets/js/117.952db9d4.js"><link rel="prefetch" href="/assets/js/118.ed9df468.js"><link rel="prefetch" href="/assets/js/119.f19ee9e0.js"><link rel="prefetch" href="/assets/js/12.cd237cda.js"><link rel="prefetch" href="/assets/js/120.24dbecef.js"><link rel="prefetch" href="/assets/js/121.0aa2d47c.js"><link rel="prefetch" href="/assets/js/122.5205ca42.js"><link rel="prefetch" href="/assets/js/123.25aa20a6.js"><link rel="prefetch" href="/assets/js/124.420b2a92.js"><link rel="prefetch" href="/assets/js/125.091331f4.js"><link rel="prefetch" href="/assets/js/126.471b335f.js"><link rel="prefetch" href="/assets/js/127.60ffdb36.js"><link rel="prefetch" href="/assets/js/128.9c5c36ef.js"><link rel="prefetch" href="/assets/js/129.36fd802b.js"><link rel="prefetch" href="/assets/js/13.de2ffe9f.js"><link rel="prefetch" href="/assets/js/130.822de8a4.js"><link rel="prefetch" href="/assets/js/131.697750e2.js"><link rel="prefetch" href="/assets/js/132.fd5faa78.js"><link rel="prefetch" href="/assets/js/133.cf327ef4.js"><link rel="prefetch" href="/assets/js/134.6cdb8690.js"><link rel="prefetch" href="/assets/js/135.906c8800.js"><link rel="prefetch" href="/assets/js/136.43585d13.js"><link rel="prefetch" href="/assets/js/137.3c7ddb41.js"><link rel="prefetch" href="/assets/js/138.e3274ead.js"><link rel="prefetch" href="/assets/js/139.7fa38b58.js"><link rel="prefetch" href="/assets/js/14.9d6406e7.js"><link rel="prefetch" href="/assets/js/140.1b026dad.js"><link rel="prefetch" href="/assets/js/141.c1adfec5.js"><link rel="prefetch" href="/assets/js/142.ed2a4a22.js"><link rel="prefetch" href="/assets/js/143.af96e2f9.js"><link rel="prefetch" href="/assets/js/144.923a7d38.js"><link rel="prefetch" href="/assets/js/145.d88163de.js"><link rel="prefetch" href="/assets/js/146.2134dd3e.js"><link rel="prefetch" href="/assets/js/147.9925c468.js"><link rel="prefetch" href="/assets/js/148.109297cc.js"><link rel="prefetch" href="/assets/js/149.ae529d47.js"><link rel="prefetch" href="/assets/js/15.fe3428fa.js"><link rel="prefetch" href="/assets/js/150.6bf9657f.js"><link rel="prefetch" href="/assets/js/151.603cf1f9.js"><link rel="prefetch" href="/assets/js/153.fd5cde7c.js"><link rel="prefetch" href="/assets/js/154.8cedd5d3.js"><link rel="prefetch" href="/assets/js/155.042308eb.js"><link rel="prefetch" href="/assets/js/156.1f58dd5a.js"><link rel="prefetch" href="/assets/js/157.69e07481.js"><link rel="prefetch" href="/assets/js/158.40b656df.js"><link rel="prefetch" href="/assets/js/159.823c56a4.js"><link rel="prefetch" href="/assets/js/16.7976352c.js"><link rel="prefetch" href="/assets/js/160.93aba24e.js"><link rel="prefetch" href="/assets/js/161.3ae7729a.js"><link rel="prefetch" href="/assets/js/162.8092cc22.js"><link rel="prefetch" href="/assets/js/163.3c82e51b.js"><link rel="prefetch" href="/assets/js/164.d358ee7b.js"><link rel="prefetch" href="/assets/js/165.60d778eb.js"><link rel="prefetch" href="/assets/js/166.54d7340a.js"><link rel="prefetch" href="/assets/js/167.5fd6aaa3.js"><link rel="prefetch" href="/assets/js/168.205929f8.js"><link rel="prefetch" href="/assets/js/169.873b90b1.js"><link rel="prefetch" href="/assets/js/17.72e8ffa6.js"><link rel="prefetch" href="/assets/js/170.68c49359.js"><link rel="prefetch" href="/assets/js/171.d8f93304.js"><link rel="prefetch" href="/assets/js/172.6b496cc7.js"><link rel="prefetch" href="/assets/js/173.f276a0ce.js"><link rel="prefetch" href="/assets/js/174.09cb41e2.js"><link rel="prefetch" href="/assets/js/175.c77ce8d9.js"><link rel="prefetch" href="/assets/js/176.01ab9f3f.js"><link rel="prefetch" href="/assets/js/177.2f91a2a4.js"><link rel="prefetch" href="/assets/js/178.5f0a0527.js"><link rel="prefetch" href="/assets/js/179.0d14e948.js"><link rel="prefetch" href="/assets/js/18.8264b169.js"><link rel="prefetch" href="/assets/js/180.9a15f295.js"><link rel="prefetch" href="/assets/js/181.d5bcbada.js"><link rel="prefetch" href="/assets/js/182.571b87a8.js"><link rel="prefetch" href="/assets/js/183.b87f5a38.js"><link rel="prefetch" href="/assets/js/184.90ecbd35.js"><link rel="prefetch" href="/assets/js/185.3a38f733.js"><link rel="prefetch" href="/assets/js/186.881a0fab.js"><link rel="prefetch" href="/assets/js/187.17663dea.js"><link rel="prefetch" href="/assets/js/188.471fcd9b.js"><link rel="prefetch" href="/assets/js/189.6d486653.js"><link rel="prefetch" href="/assets/js/19.e6227b20.js"><link rel="prefetch" href="/assets/js/190.357b4cc8.js"><link rel="prefetch" href="/assets/js/191.ccf9ae83.js"><link rel="prefetch" href="/assets/js/192.3ee45cf5.js"><link rel="prefetch" href="/assets/js/193.2fbcbc68.js"><link rel="prefetch" href="/assets/js/194.61d0acd9.js"><link rel="prefetch" href="/assets/js/195.33b772c3.js"><link rel="prefetch" href="/assets/js/196.7d35848a.js"><link rel="prefetch" href="/assets/js/197.4b958d27.js"><link rel="prefetch" href="/assets/js/198.dfbfba98.js"><link rel="prefetch" href="/assets/js/199.f6c7aacb.js"><link rel="prefetch" href="/assets/js/20.65ad9b00.js"><link rel="prefetch" href="/assets/js/200.6a05302e.js"><link rel="prefetch" href="/assets/js/201.be446c97.js"><link rel="prefetch" href="/assets/js/202.d058ca1d.js"><link rel="prefetch" href="/assets/js/203.ef2b609c.js"><link rel="prefetch" href="/assets/js/204.dab38ee5.js"><link rel="prefetch" href="/assets/js/21.300f7dfb.js"><link rel="prefetch" href="/assets/js/22.0ed457bc.js"><link rel="prefetch" href="/assets/js/23.9cf0f43d.js"><link rel="prefetch" href="/assets/js/24.f151ffcb.js"><link rel="prefetch" href="/assets/js/25.680a763b.js"><link rel="prefetch" href="/assets/js/26.6a5f804d.js"><link rel="prefetch" href="/assets/js/27.98408441.js"><link rel="prefetch" href="/assets/js/28.acbefbd1.js"><link rel="prefetch" href="/assets/js/29.fbd2340a.js"><link rel="prefetch" href="/assets/js/3.753236a7.js"><link rel="prefetch" href="/assets/js/30.30b44255.js"><link rel="prefetch" href="/assets/js/31.510d262b.js"><link rel="prefetch" href="/assets/js/32.c204bc79.js"><link rel="prefetch" href="/assets/js/33.5fa66039.js"><link rel="prefetch" href="/assets/js/34.6db47b26.js"><link rel="prefetch" href="/assets/js/35.fcb88dd5.js"><link rel="prefetch" href="/assets/js/36.e294e99d.js"><link rel="prefetch" href="/assets/js/37.fe541556.js"><link rel="prefetch" href="/assets/js/38.94af8189.js"><link rel="prefetch" href="/assets/js/39.e7017f9b.js"><link rel="prefetch" href="/assets/js/4.1c3159e6.js"><link rel="prefetch" href="/assets/js/40.b7a1deeb.js"><link rel="prefetch" href="/assets/js/41.ae4d7d1e.js"><link rel="prefetch" href="/assets/js/42.5dc5c7f6.js"><link rel="prefetch" href="/assets/js/43.73610732.js"><link rel="prefetch" href="/assets/js/44.2b0e19f3.js"><link rel="prefetch" href="/assets/js/45.903efdc0.js"><link rel="prefetch" href="/assets/js/46.0684656f.js"><link rel="prefetch" href="/assets/js/47.6425b35e.js"><link rel="prefetch" href="/assets/js/48.43663ba9.js"><link rel="prefetch" href="/assets/js/49.34841bc0.js"><link rel="prefetch" href="/assets/js/5.d3774f5f.js"><link rel="prefetch" href="/assets/js/50.48ce1d7e.js"><link rel="prefetch" href="/assets/js/51.1820aa29.js"><link rel="prefetch" href="/assets/js/52.5317c537.js"><link rel="prefetch" href="/assets/js/53.71b86df9.js"><link rel="prefetch" href="/assets/js/54.31ed2a5e.js"><link rel="prefetch" href="/assets/js/55.4f9933ab.js"><link rel="prefetch" href="/assets/js/56.beb74e07.js"><link rel="prefetch" href="/assets/js/57.705bc19e.js"><link rel="prefetch" href="/assets/js/58.f5fd656b.js"><link rel="prefetch" href="/assets/js/59.cc8ae217.js"><link rel="prefetch" href="/assets/js/6.f082ca37.js"><link rel="prefetch" href="/assets/js/60.fc3cf484.js"><link rel="prefetch" href="/assets/js/61.b5032b43.js"><link rel="prefetch" href="/assets/js/62.64d7637a.js"><link rel="prefetch" href="/assets/js/63.2a71075b.js"><link rel="prefetch" href="/assets/js/64.21eb4820.js"><link rel="prefetch" href="/assets/js/65.11535a8c.js"><link rel="prefetch" href="/assets/js/66.d9c62638.js"><link rel="prefetch" href="/assets/js/67.5782c958.js"><link rel="prefetch" href="/assets/js/68.35886dae.js"><link rel="prefetch" href="/assets/js/69.934aa057.js"><link rel="prefetch" href="/assets/js/7.9a79fd87.js"><link rel="prefetch" href="/assets/js/70.53c7c7a2.js"><link rel="prefetch" href="/assets/js/71.0e82b1c6.js"><link rel="prefetch" href="/assets/js/72.1da0eaf9.js"><link rel="prefetch" href="/assets/js/73.3dabc9cd.js"><link rel="prefetch" href="/assets/js/74.b2ae43f6.js"><link rel="prefetch" href="/assets/js/75.55bf2044.js"><link rel="prefetch" href="/assets/js/76.2f88e50b.js"><link rel="prefetch" href="/assets/js/77.d916e87e.js"><link rel="prefetch" href="/assets/js/78.0e80a77d.js"><link rel="prefetch" href="/assets/js/79.03bce65e.js"><link rel="prefetch" href="/assets/js/8.60d5a8a9.js"><link rel="prefetch" href="/assets/js/80.96678f59.js"><link rel="prefetch" href="/assets/js/81.75ffa4d3.js"><link rel="prefetch" href="/assets/js/82.41c1aeb7.js"><link rel="prefetch" href="/assets/js/83.16d5e455.js"><link rel="prefetch" href="/assets/js/84.195ca01f.js"><link rel="prefetch" href="/assets/js/85.d850d4dd.js"><link rel="prefetch" href="/assets/js/86.32d87d56.js"><link rel="prefetch" href="/assets/js/87.5f97a4f6.js"><link rel="prefetch" href="/assets/js/88.f5b0bbdb.js"><link rel="prefetch" href="/assets/js/89.9f9150f5.js"><link rel="prefetch" href="/assets/js/9.74db15a0.js"><link rel="prefetch" href="/assets/js/90.f69286ce.js"><link rel="prefetch" href="/assets/js/91.c9995055.js"><link rel="prefetch" href="/assets/js/92.e992da4f.js"><link rel="prefetch" href="/assets/js/93.14137340.js"><link rel="prefetch" href="/assets/js/94.c8228a63.js"><link rel="prefetch" href="/assets/js/95.bbb7ce03.js"><link rel="prefetch" href="/assets/js/96.ce87793d.js"><link rel="prefetch" href="/assets/js/97.4fdd8a0b.js"><link rel="prefetch" href="/assets/js/98.74cfc635.js"><link rel="prefetch" href="/assets/js/99.abdd1b46.js">
    <link rel="stylesheet" href="/assets/css/0.styles.659f981c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yan's Blog Home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Python</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DevLanguage/Python/" class="sidebar-link">Python</a></li><li><a href="/DevLanguage/Python/PythonBasic.html" class="sidebar-link">Python 基础</a></li><li><a href="/DevLanguage/Python/PythonAdvanced.html" class="active sidebar-link">Python 进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#args-和-kwargs" class="sidebar-link">args 和 *kwargs</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#调试-debugging" class="sidebar-link">调试 Debugging</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#从命令行运行" class="sidebar-link">从命令行运行</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#从脚本内部运行" class="sidebar-link">从脚本内部运行</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#命令列表" class="sidebar-link">命令列表</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#生成器-generators" class="sidebar-link">生成器 Generators</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#可迭代对象-iterable" class="sidebar-link">可迭代对象(Iterable)</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#迭代器-iterator" class="sidebar-link">迭代器(Iterator)</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#迭代-iteration" class="sidebar-link">迭代(Iteration)</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#生成器-generators-2" class="sidebar-link">生成器(Generators)</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#map，filter-和-reduce" class="sidebar-link">Map，Filter 和 Reduce</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#map" class="sidebar-link">Map</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#filter" class="sidebar-link">Filter</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#reduce" class="sidebar-link">Reduce</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#set-数据结构" class="sidebar-link">set 数据结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#交集" class="sidebar-link">交集</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#差集" class="sidebar-link">差集</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#三元运算符" class="sidebar-link">三元运算符</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#装饰器" class="sidebar-link">装饰器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#一切皆对象" class="sidebar-link">一切皆对象</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#在函数中定义函数" class="sidebar-link">在函数中定义函数</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#从函数中返回函数" class="sidebar-link">从函数中返回函数</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#将函数作为参数传给另一个函数" class="sidebar-link">将函数作为参数传给另一个函数</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#你的第一个装饰器" class="sidebar-link">你的第一个装饰器</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#使用场景" class="sidebar-link">使用场景</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#带参数的装饰器" class="sidebar-link">带参数的装饰器</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#global和return" class="sidebar-link">Global和Return</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#多个return值" class="sidebar-link">多个return值</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#对象变动-mutation" class="sidebar-link">对象变动 Mutation</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#slots魔法" class="sidebar-link">slots魔法</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#虚拟环境-virtualenv" class="sidebar-link">虚拟环境 Virtualenv</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#你听说过virtualenv吗？" class="sidebar-link">你听说过virtualenv吗？</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#那么，什么是virtualenv" class="sidebar-link">那么，什么是virtualenv?</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#用什么方式解决？" class="sidebar-link">用什么方式解决？</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#福利" class="sidebar-link">福利</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#容器-collections" class="sidebar-link">容器 Collections</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#容器-collections-2" class="sidebar-link">容器(Collections)</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#defaultdict" class="sidebar-link">defaultdict</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#counter" class="sidebar-link">counter</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#deque" class="sidebar-link">deque</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#namedtuple" class="sidebar-link">namedtuple</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#enum-enum-python-3-4" class="sidebar-link">enum.Enum (Python 3.4+)</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#枚举-enumerate" class="sidebar-link">枚举 Enumerate</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#对象自省" class="sidebar-link">对象自省</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#dir" class="sidebar-link">dir</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#type和id" class="sidebar-link">type和id</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#inspect模块" class="sidebar-link">inspect模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#推导式-comprehension" class="sidebar-link">推导式 Comprehension</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#列表推导式" class="sidebar-link">列表推导式</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#字典推导式" class="sidebar-link">字典推导式</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#集合推导式" class="sidebar-link">集合推导式</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#异常" class="sidebar-link">异常</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#处理多个异常" class="sidebar-link">处理多个异常</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#lambda表达式" class="sidebar-link">lambda表达式</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#一行式" class="sidebar-link">一行式</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#for-else" class="sidebar-link">For - Else</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#else语句" class="sidebar-link">else语句</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#使用c扩展" class="sidebar-link">使用C扩展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#ctypes" class="sidebar-link">CTypes</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#swig" class="sidebar-link">SWIG</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#python-c-api" class="sidebar-link">Python/C API</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#open函数" class="sidebar-link">open函数</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#目标python2-3" class="sidebar-link">目标Python2+3</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#协程" class="sidebar-link">协程</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#函数缓存" class="sidebar-link">函数缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#python-3-2" class="sidebar-link">Python 3.2+</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#python-2" class="sidebar-link">Python 2+</a></li></ul></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#上下文管理器" class="sidebar-link">上下文管理器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#基于类的实现" class="sidebar-link">基于类的实现</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#处理异常" class="sidebar-link">处理异常</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Python/PythonAdvanced.html#基于生成器的实现" class="sidebar-link">基于生成器的实现</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python 爬虫</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/index/" class="sidebar-link">&lt; 首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="python-进阶"><a href="#python-进阶" class="header-anchor">#</a> Python 进阶</h1> <div class="custom-block tip"><p class="custom-block-title">此文为转载 （通常一篇文章会参考多处，也会添加自己的理解，引用地址如有遗漏，请指出）</p> <ul><li>https://eastlakeside.gitbook.io/interpy-zh/</li></ul></div> <p>相对于基本语法，这里转载一个python进阶的教程（翻译自<code>Intermediate Python</code>）</p> <h2 id="args-和-kwargs"><a href="#args-和-kwargs" class="header-anchor">#</a> *args 和 **kwargs</h2> <p><strong>不定长参数</strong>, 其实并不是必须写成<code>*args</code> 和<code>**kwargs</code>。 只有变量前面的 <code>*</code>(星号)才是必须的. 你也可以写成<code>*var</code> 和<code>**vars</code>. 而写成<code>*args</code> 和<code>**kwargs</code>只是一个通俗的命名约定</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 加了星号（*）的变量存放所有未命名的变量参数，如果在函数调用时没有指定参数，它就是一个空元祖</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> args<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
func<span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">,</span><span class="token string">'test2'</span><span class="token punctuation">,</span> <span class="token string">'test3'</span><span class="token punctuation">)</span>

<span class="token comment"># **代表键值对的参数字段， 和*代表意义类似</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
func2<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> z<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment"># 通常写法 - 接收任意参数</span>
<span class="token keyword">def</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token operator">*</span>args <span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="调试-debugging"><a href="#调试-debugging" class="header-anchor">#</a> 调试 Debugging</h2> <p>利用好调试，能大大提高你捕捉代码Bug的。大部分新人忽略了Python debugger(<code>pdb</code>)的重要性。 在这个章节我只会告诉你一些重要的命令，你可以从官方文档中学习到更多。</p> <blockquote><p>译者注，参考：https://docs.python.org/2/library/pdb.html Or https://docs.python.org/3/library/pdb.html</p></blockquote> <h3 id="从命令行运行"><a href="#从命令行运行" class="header-anchor">#</a> 从命令行运行</h3> <p>你可以在命令行使用Python debugger运行一个脚本， 举个例子：</p> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>$ python -m pdb my_script.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这会触发debugger在脚本第一行指令处停止执行。这在脚本很短时会很有帮助。你可以通过(Pdb)模式接着查看变量信息，并且逐行调试。</p> <h3 id="从脚本内部运行"><a href="#从脚本内部运行" class="header-anchor">#</a> 从脚本内部运行</h3> <p>同时，你也可以在脚本内部设置断点，这样就可以在某些特定点查看变量信息和各种执行时信息了。这里将使用<code>pdb.set_trace()</code>方法来实现。举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pdb

<span class="token keyword">def</span> <span class="token function">make_bread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pdb<span class="token punctuation">.</span>set_trace<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;I don't have time&quot;</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>make_bread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>试下保存上面的脚本后运行之。你会在运行时马上进入debugger模式。现在是时候了解下debugger模式下的一些命令了。</p> <h3 id="命令列表"><a href="#命令列表" class="header-anchor">#</a> 命令列表</h3> <ul><li><code>c</code>: 继续执行</li> <li><code>w</code>: 显示当前正在执行的代码行的上下文信息</li> <li><code>a</code>: 打印当前函数的参数列表</li> <li><code>s</code>: 执行当前代码行，并停在第一个能停的地方（相当于单步进入）</li> <li><code>n</code>: 继续执行到当前函数的下一行，或者当前行直接返回（单步跳过）</li></ul> <p>单步跳过（<code>n</code>ext）和单步进入（<code>s</code>tep）的区别在于， 单步进入会进入当前行调用的函数内部并停在里面， 而单步跳过会（几乎）全速执行完当前行调用的函数，并停在当前函数的下一行。pdb真的是一个很方便的功能，上面仅列举少量用法，更多的命令强烈推荐你去看官方文档。</p> <h2 id="生成器-generators"><a href="#生成器-generators" class="header-anchor">#</a> 生成器 Generators</h2> <h3 id="可迭代对象-iterable"><a href="#可迭代对象-iterable" class="header-anchor">#</a> 可迭代对象(Iterable)</h3> <p>Python中任意的对象，只要它定义了可以返回一个迭代器的<code>__iter__</code>方法，或者定义了可以支持下标索引的<code>__getitem__</code>方法(这些双下划线方法会在其他章节中全面解释)，那么它就是一个可迭代对象。简单说，可迭代对象就是能提供迭代器的任意对象。那迭代器又是什么呢？</p> <h3 id="迭代器-iterator"><a href="#迭代器-iterator" class="header-anchor">#</a> 迭代器(Iterator)</h3> <p>任意对象，只要定义了<code>next</code>(Python2) 或者<code>__next__</code>方法，它就是一个迭代器。就这么简单。现在我们来理解迭代(iteration)</p> <h3 id="迭代-iteration"><a href="#迭代-iteration" class="header-anchor">#</a> 迭代(Iteration)</h3> <p>用简单的话讲，它就是从某个地方（比如一个列表）取出一个元素的过程。当我们使用一个循环来遍历某个东西时，这个过程本身就叫迭代。现在既然我们有了这些术语的基本理解，那我们开始理解生成器吧。</p> <h3 id="生成器-generators-2"><a href="#生成器-generators-2" class="header-anchor">#</a> 生成器(Generators)</h3> <p>生成器也是一种迭代器，但是你只能对其迭代一次。这是因为它们并没有把所有的值存在内存中，而是在运行时生成值。你通过遍历来使用它们，要么用一个“for”循环，要么将它们传递给任意可以进行迭代的函数和结构。大多数时候生成器是以函数来实现的。然而，它们并不返回一个值，而是<code>yield</code>一个值。这里有个生成器函数的简单例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">generator_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> i

<span class="token keyword">for</span> item <span class="token keyword">in</span> generator_function<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>

<span class="token comment"># Output: 0</span>
<span class="token comment"># 1</span>
<span class="token comment"># 2</span>
<span class="token comment"># 3</span>
<span class="token comment"># 4</span>
<span class="token comment"># 5</span>
<span class="token comment"># 6</span>
<span class="token comment"># 7</span>
<span class="token comment"># 8</span>
<span class="token comment"># 9</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这个案例并不是非常实用。生成器最佳应用场景是：你不想同一时间将所有计算出来的大量结果集分配到内存当中，特别是结果集里还包含循环。</p> <blockquote><p>译者注：这样做会消耗大量资源</p></blockquote> <p>许多Python 2里的标准库函数都会返回列表，而Python 3都修改成了返回生成器，因为生成器占用更少的资源。下面是一个计算斐波那契数列的生成器：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># generator version</span>
<span class="token keyword">def</span> <span class="token function">fibon</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> b <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> a
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>函数使用方法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> x <span class="token keyword">in</span> fibon<span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>用这种方式，我们可以不用担心它会使用大量资源。然而，之前如果我们这样来实现的话：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">fibon</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> b <span class="token operator">=</span> <span class="token number">1</span>
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b
    <span class="token keyword">return</span> result
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这也许会在计算很大的输入参数时，用尽所有的资源。我们已经讨论过生成器使用一次迭代，但我们并没有测试过。在测试前你需要再知道一个Python内置函数：<code>next()</code>。它允许我们获取一个序列的下一个元素。那我们来验证下我们的理解：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">generator_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> i


gen <span class="token operator">=</span> generator_function<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 2</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: Traceback (most recent call last):</span>
<span class="token comment">#            File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="token comment">#         StopIteration</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们可以看到，在<code>yield</code>掉所有的值后，<code>next()</code>触发了一个<code>StopIteration</code>的异常。基本上这个异常告诉我们，所有的值都已经被<code>yield</code>完了。你也许会奇怪，为什么我们在使用<code>for</code>循环时没有这个异常呢？啊哈，答案很简单。<code>for</code>循环会自动捕捉到这个异常并停止调用<code>next()</code>。你知不知道Python中一些内置数据类型也支持迭代哦？我们这就去看看：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>my_string <span class="token operator">=</span> <span class="token string">&quot;Yasoob&quot;</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>my_string<span class="token punctuation">)</span>
<span class="token comment"># Output: Traceback (most recent call last):</span>
<span class="token comment">#      File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="token comment">#    TypeError: str object is not an iterator</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>好吧，这不是我们预期的。这个异常说那个<code>str</code>对象不是一个迭代器。对，就是这样！它是一个可迭代对象，而不是一个迭代器。这意味着它支持迭代，但我们不能直接对其进行迭代操作。那我们怎样才能对它实施迭代呢？是时候学习下另一个内置函数，<code>iter</code>。它将根据一个可迭代对象返回一个迭代器对象。这里是我们如何使用它：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>my_string <span class="token operator">=</span> <span class="token string">&quot;Yasoob&quot;</span>
my_iter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_string<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>my_iter<span class="token punctuation">)</span>
<span class="token comment"># Output: 'Y'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在好多啦。我肯定你已经爱上了学习生成器。一定要记住，想要完全掌握这个概念，你只有使用它。确保你按照这个模式，并在生成器对你有意义的任何时候都使用它。你绝对不会失望的！</p> <h2 id="map，filter-和-reduce"><a href="#map，filter-和-reduce" class="header-anchor">#</a> Map，Filter 和 Reduce</h2> <p>Map，Filter 和 Reduce 三个函数能为函数式编程提供便利。我们会通过实例一个一个讨论并理解它们。</p> <h3 id="map"><a href="#map" class="header-anchor">#</a> Map</h3> <p><code>Map</code>会将一个函数映射到一个输入列表的所有元素上。这是它的规范：</p> <p><strong>规范</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">map</span><span class="token punctuation">(</span>function_to_apply<span class="token punctuation">,</span> list_of_inputs<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>大多数时候，我们要把列表中所有元素一个个地传递给一个函数，并收集输出。比方说：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
squared <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> items<span class="token punctuation">:</span>
    squared<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>Map</code>可以让我们用一种简单而漂亮得多的方式来实现。就是这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
squared <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>大多数时候，我们使用匿名函数(lambdas)来配合<code>map</code>, 所以我在上面也是这么做的。 不仅用于一列表的输入， 我们甚至可以用于一列表的函数！</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">multiply</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>x<span class="token punctuation">)</span>


funcs <span class="token operator">=</span> <span class="token punctuation">[</span>multiply<span class="token punctuation">,</span> add<span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    value <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> funcs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 译者注：上面print时，加了list转换，是为了python2/3的兼容性</span>
    <span class="token comment">#        在python2中map直接返回列表，但在python3中返回迭代器</span>
    <span class="token comment">#        因此为了兼容python3, 需要list转换一下</span>


<span class="token comment"># Output:</span>
<span class="token comment"># [0, 0]</span>
<span class="token comment"># [1, 2]</span>
<span class="token comment"># [4, 4]</span>
<span class="token comment"># [9, 6]</span>
<span class="token comment"># [16, 8]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="filter"><a href="#filter" class="header-anchor">#</a> Filter</h3> <p>顾名思义，<code>filter</code>过滤列表中的元素，并且返回一个由所有符合要求的元素所构成的列表，<code>符合要求</code>即函数映射到该元素时返回值为True. 这里是一个简短的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>number_list <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
less_than_zero <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> number_list<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>less_than_zero<span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token comment"># 译者注：上面print时，加了list转换，是为了python2/3的兼容性</span>
<span class="token comment">#        在python2中filter直接返回列表，但在python3中返回迭代器</span>
<span class="token comment">#        因此为了兼容python3, 需要list转换一下</span>


<span class="token comment"># Output: [-5, -4, -3, -2, -1]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个<code>filter</code>类似于一个<code>for</code>循环，但它是一个内置函数，并且更快。<br>注意：如果<code>map</code>和<code>filter</code>对你来说看起来并不优雅的话，那么你可以看看另外一章：列表/字典/元组推导式。</p> <blockquote><p>译者注：大部分情况下推导式的可读性更好</p></blockquote> <h3 id="reduce"><a href="#reduce" class="header-anchor">#</a> Reduce</h3> <p>当需要对一个列表进行一些计算并返回结果时，<code>Reduce</code> 是个非常有用的函数。举个例子，当你需要计算一个整数列表的乘积时。<br>通常在 python 中你可能会使用基本的 for 循环来完成这个任务。<br>现在我们来试试 reduce：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>
product <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>

<span class="token comment"># Output: 24</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="set-数据结构"><a href="#set-数据结构" class="header-anchor">#</a> set 数据结构</h2> <p><code>set</code>(集合)是一个非常有用的数据结构。它与列表(<code>list</code>)的行为类似，区别在于<code>set</code>不能包含重复的值。 这在很多情况下非常有用。例如你可能想检查列表中是否包含重复的元素，你有两个选择，第一个需要使用<code>for</code>循环，就像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>some_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">]</span>

duplicates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> value <span class="token keyword">in</span> some_list<span class="token punctuation">:</span>
    <span class="token keyword">if</span> some_list<span class="token punctuation">.</span>count<span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> value <span class="token keyword">not</span> <span class="token keyword">in</span> duplicates<span class="token punctuation">:</span>
            duplicates<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>duplicates<span class="token punctuation">)</span>
<span class="token comment">### 输出: ['b', 'n']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>但还有一种更简单更优雅的解决方案，那就是使用<code>集合(sets)</code>，你直接这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>some_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">]</span>
duplicates <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> some_list <span class="token keyword">if</span> some_list<span class="token punctuation">.</span>count<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>duplicates<span class="token punctuation">)</span>
<span class="token comment">### 输出: set(['b', 'n'])</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>集合还有一些其它方法，下面我们介绍其中一部分。</p> <h3 id="交集"><a href="#交集" class="header-anchor">#</a> 交集</h3> <p>你可以对比两个集合的交集（两个集合中都有的数据），如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>valid <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'yellow'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>input_set<span class="token punctuation">.</span>intersection<span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">### 输出: set(['red'])</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="差集"><a href="#差集" class="header-anchor">#</a> 差集</h3> <p>你可以用差集(difference)找出无效的数据，相当于用一个集合减去另一个集合的数据，例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>valid <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'yellow'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>input_set<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">### 输出: set(['brown'])</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>你也可以用<code>{}</code>符号来创建集合，如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>a_set <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">}</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>a_set<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">### 输出: &lt;type 'set'&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>集合还有一些其它方法，我会建议访问官方文档并做个快速阅读。</p> <h2 id="三元运算符"><a href="#三元运算符" class="header-anchor">#</a> 三元运算符</h2> <p>三元运算符通常在Python里被称为条件表达式，这些表达式基于真(true)/假(false)的条件判断，在Python 2.4以上才有了三元操作。下面是一个伪代码和例子：</p> <p><strong>伪代码:</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#如果条件为真，返回真 否则返回假</span>
condition_is_true <span class="token keyword">if</span> condition <span class="token keyword">else</span> condition_is_false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>例子:</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>is_fat <span class="token operator">=</span> <span class="token boolean">True</span>
state <span class="token operator">=</span> <span class="token string">&quot;fat&quot;</span> <span class="token keyword">if</span> is_fat <span class="token keyword">else</span> <span class="token string">&quot;not fat&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>它允许用简单的一行快速判断，而不是使用复杂的多行<code>if</code>语句。 这在大多数时候非常有用，而且可以使代码简单可维护。<br>另一个晦涩一点的用法比较少见，它使用了元组，请继续看：</p> <p><strong>伪代码:</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#(返回假，返回真)[真或假]</span>
<span class="token punctuation">(</span>if_test_is_false<span class="token punctuation">,</span> if_test_is_true<span class="token punctuation">)</span><span class="token punctuation">[</span>test<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>例子:</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>fat <span class="token operator">=</span> <span class="token boolean">True</span>
fitness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;skinny&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span>fat<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Ali is&quot;</span><span class="token punctuation">,</span> fitness<span class="token punctuation">)</span>
<span class="token comment">#输出: Ali is fat</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这之所以能正常工作，是因为在Python中，True等于1，而False等于0，这就相当于在元组中使用0和1来选取数据。<br>上面的例子没有被广泛使用，而且Python玩家一般不喜欢那样，因为没有Python味儿(Pythonic)。这样的用法很容易把真正的数据与True/False弄混。<br>另外一个不使用元组条件表达式的缘故是因为在元组中会把两个条件都执行，而 <code>if-else</code> 的条件表达式不会这样。例如:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>condition <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token keyword">if</span> condition <span class="token keyword">else</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">#输出: 2</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span>condition<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#输出ZeroDivisionError异常</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这是因为在元组中是先建数据，然后用True(1)/False(0)来索引到数据。 而<code>if-else</code>条件表达式遵循普通的<code>if-else</code>逻辑树， 因此，如果逻辑中的条件异常，或者是重计算型（计算较久）的情况下，最好尽量避免使用元组条件表达式。</p> <h2 id="装饰器"><a href="#装饰器" class="header-anchor">#</a> 装饰器</h2> <p>装饰器(Decorators)是Python的一个重要部分。简单地说：他们是修改其他函数的功能的函数。他们有助于让我们的代码更简短，也更Pythonic（Python范儿）。大多数初学者不知道在哪儿使用它们，所以我将要分享下，哪些区域里装饰器可以让你的代码更简洁。</p> <p>首先，让我们讨论下如何写你自己的装饰器。<br>这可能是最难掌握的概念之一。我们会每次只讨论一个步骤，这样你能完全理解它。</p> <h3 id="一切皆对象"><a href="#一切皆对象" class="header-anchor">#</a> 一切皆对象</h3> <p>首先我们来理解下Python中的函数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;yasoob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hi &quot;</span> <span class="token operator">+</span> name

<span class="token keyword">print</span><span class="token punctuation">(</span>hi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># output: 'hi yasoob'</span>

<span class="token comment"># 我们甚至可以将一个函数赋值给一个变量，比如</span>
greet <span class="token operator">=</span> hi
<span class="token comment"># 我们这里没有在使用小括号，因为我们并不是在调用hi函数</span>
<span class="token comment"># 而是在将它放在greet变量里头。我们尝试运行下这个</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>greet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># output: 'hi yasoob'</span>

<span class="token comment"># 如果我们删掉旧的hi函数，看看会发生什么！</span>
<span class="token keyword">del</span> hi
<span class="token keyword">print</span><span class="token punctuation">(</span>hi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: NameError</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>greet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: 'hi yasoob'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="在函数中定义函数"><a href="#在函数中定义函数" class="header-anchor">#</a> 在函数中定义函数</h3> <p>刚才那些就是函数的基本知识了。我们来让你的知识更进一步。在Python中我们可以在一个函数中定义另一个函数：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;yasoob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;now you are inside the hi() function&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;now you are in the greet() function&quot;</span>

    <span class="token keyword">def</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;now you are in the welcome() function&quot;</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>greet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>welcome<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;now you are back in the hi() function&quot;</span><span class="token punctuation">)</span>

hi<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#output:now you are inside the hi() function</span>
<span class="token comment">#       now you are in the greet() function</span>
<span class="token comment">#       now you are in the welcome() function</span>
<span class="token comment">#       now you are back in the hi() function</span>


<span class="token comment"># 上面展示了无论何时你调用hi(), greet()和welcome()将会同时被调用。</span>
<span class="token comment"># 然后greet()和welcome()函数在hi()函数之外是不能访问的，比如：</span>

greet<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: NameError: name 'greet' is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>那现在我们知道了可以在函数中定义另外的函数。也就是说：我们可以创建嵌套的函数。现在你需要再多学一点，就是函数也能返回函数。</p> <h3 id="从函数中返回函数"><a href="#从函数中返回函数" class="header-anchor">#</a> 从函数中返回函数</h3> <p>其实并不需要在一个函数里去执行另一个函数，我们也可以将其作为输出返回出来：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;yasoob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;now you are in the greet() function&quot;</span>

    <span class="token keyword">def</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;now you are in the welcome() function&quot;</span>

    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;yasoob&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> greet
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> welcome

a <span class="token operator">=</span> hi<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment">#outputs: &lt;function greet at 0x7f2143c01500&gt;</span>

<span class="token comment">#上面清晰地展示了`a`现在指向到hi()函数中的greet()函数</span>
<span class="token comment">#现在试试这个</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: now you are in the greet() function</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>再次看看这个代码。在<code>if/else</code>语句中我们返回<code>greet</code>和<code>welcome</code>，而不是<code>greet()</code>和<code>welcome()</code>。为什么那样？这是因为当你把一对小括号放在后面，这个函数就会执行；然而如果你不放括号在它后面，那它可以被到处传递，并且可以赋值给别的变量而不去执行它。</p> <p>你明白了吗？让我再稍微多解释点细节。</p> <p>当我们写下<code>a = hi()</code>，<code>hi()</code>会被执行，而由于<code>name</code>参数默认是<em>yasoob</em>，所以函数<code>greet</code>被返回了。如果我们把语句改为<code>a = hi(name = &quot;ali&quot;)</code>，那么<code>welcome</code>函数将被返回。我们还可以打印出<code>hi()()</code>，这会输出<em>now you are in the greet() function</em>。</p> <h3 id="将函数作为参数传给另一个函数"><a href="#将函数作为参数传给另一个函数" class="header-anchor">#</a> 将函数作为参数传给另一个函数</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hi yasoob!&quot;</span>

<span class="token keyword">def</span> <span class="token function">doSomethingBeforeHi</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am doing some boring work before executing hi()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

doSomethingBeforeHi<span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
<span class="token comment">#outputs:I am doing some boring work before executing hi()</span>
<span class="token comment">#        hi yasoob!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>现在你已经具备所有必需知识，来进一步学习装饰器真正是什么了。装饰器让你在一个函数的前后去执行代码。</p> <h3 id="你的第一个装饰器"><a href="#你的第一个装饰器" class="header-anchor">#</a> 你的第一个装饰器</h3> <p>在上一个例子里，其实我们已经创建了一个装饰器！现在我们修改下上一个装饰器，并编写一个稍微更有用点的程序：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">a_new_decorator</span><span class="token punctuation">(</span>a_func<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">wrapTheFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am doing some boring work before executing a_func()&quot;</span><span class="token punctuation">)</span>

        a_func<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am doing some boring work after executing a_func()&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> wrapTheFunction

<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am the function which needs some decoration to remove my foul smell&quot;</span><span class="token punctuation">)</span>

a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: &quot;I am the function which needs some decoration to remove my foul smell&quot;</span>

a_function_requiring_decoration <span class="token operator">=</span> a_new_decorator<span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">)</span>
<span class="token comment">#now a_function_requiring_decoration is wrapped by wrapTheFunction()</span>

a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs:I am doing some boring work before executing a_func()</span>
<span class="token comment">#        I am the function which needs some decoration to remove my foul smell</span>
<span class="token comment">#        I am doing some boring work after executing a_func()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>你看明白了吗？我们刚刚应用了之前学习到的原理。这正是python中装饰器做的事情！它们封装一个函数，并且用这样或者那样的方式来修改它的行为。现在你也许疑惑，我们在代码里并没有使用@符号？那只是一个简短的方式来生成一个被装饰的函数。这里是我们如何使用@来运行之前的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@a_new_decorator</span>
<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Hey you! Decorate me!&quot;&quot;&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am the function which needs some decoration to &quot;</span>
          <span class="token string">&quot;remove my foul smell&quot;</span><span class="token punctuation">)</span>

a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: I am doing some boring work before executing a_func()</span>
<span class="token comment">#         I am the function which needs some decoration to remove my foul smell</span>
<span class="token comment">#         I am doing some boring work after executing a_func()</span>

<span class="token comment">#the @a_new_decorator is just a short way of saying:</span>
a_function_requiring_decoration <span class="token operator">=</span> a_new_decorator<span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>希望你现在对Python装饰器的工作原理有一个基本的理解。如果我们运行如下代码会存在一个问题：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># Output: wrapTheFunction</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这并不是我们想要的！Ouput输出应该是“a_function_requiring_decoration”。这里的函数被warpTheFunction替代了。它重写了我们函数的名字和注释文档(docstring)。幸运的是Python提供给我们一个简单的函数来解决这个问题，那就是functools.wraps。我们修改上一个例子来使用functools.wraps：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">def</span> <span class="token function">a_new_decorator</span><span class="token punctuation">(</span>a_func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @wraps<span class="token punctuation">(</span>a_func<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">wrapTheFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am doing some boring work before executing a_func()&quot;</span><span class="token punctuation">)</span>
        a_func<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am doing some boring work after executing a_func()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapTheFunction

@a_new_decorator
<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Hey yo! Decorate me!&quot;&quot;&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am the function which needs some decoration to &quot;</span>
          <span class="token string">&quot;remove my foul smell&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># Output: a_function_requiring_decoration</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>现在好多了。我们接下来学习装饰器的一些常用场景。蓝本规范:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
<span class="token keyword">def</span> <span class="token function">decorator_name</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @wraps<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decorated</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> can_run<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Function will not run&quot;</span>
        <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> decorated

@decorator_name
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;Function is running&quot;</span><span class="token punctuation">)</span>

can_run <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: Function is running</span>

can_run <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: Function will not run</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>注意：@wraps接受一个函数来进行装饰，并加入了复制函数名称、注释文档、参数列表等等的功能。这可以让我们在装饰器里面访问在装饰之前的函数的属性。</p> <h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <p>现在我们来看一下装饰器在哪些地方特别耀眼，以及使用它可以让一些事情管理起来变得更简单。</p> <h4 id="授权"><a href="#授权" class="header-anchor">#</a> 授权</h4> <p>装饰器能有助于检查某个人是否被授权去使用一个web应用的端点(endpoint)。它们被大量使用于Flask和Django web框架中。这里是一个例子来使用基于装饰器的授权：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">def</span> <span class="token function">requires_auth</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @wraps<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decorated</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        auth <span class="token operator">=</span> request<span class="token punctuation">.</span>authorization
        <span class="token keyword">if</span> <span class="token keyword">not</span> auth <span class="token keyword">or</span> <span class="token keyword">not</span> check_auth<span class="token punctuation">(</span>auth<span class="token punctuation">.</span>username<span class="token punctuation">,</span> auth<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            authenticate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> decorated
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h4> <p>日志是装饰器运用的另一个亮点。这是个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">def</span> <span class="token function">logit</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">with_logging</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">&quot; was called&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> with_logging

@logit
<span class="token keyword">def</span> <span class="token function">addition_func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token triple-quoted-string string">&quot;&quot;&quot;Do some math.&quot;&quot;&quot;</span>
   <span class="token keyword">return</span> x <span class="token operator">+</span> x


result <span class="token operator">=</span> addition_func<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment"># Output: addition_func was called</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>我敢肯定你已经在思考装饰器的一个其他聪明用法了。</p> <h3 id="带参数的装饰器"><a href="#带参数的装饰器" class="header-anchor">#</a> 带参数的装饰器</h3> <p>来想想这个问题，难道<code>@wraps</code>不也是个装饰器吗？但是，它接收一个参数，就像任何普通的函数能做的那样。那么，为什么我们不也那样做呢？</p> <p>这是因为，当你使用<code>@my_decorator</code>语法时，你是在应用一个以单个函数作为参数的一个包裹函数。记住，Python里每个东西都是一个对象，而且这包括函数！记住了这些，我们可以编写一下能返回一个包裹函数的函数。</p> <h4 id="在函数中嵌入装饰器"><a href="#在函数中嵌入装饰器" class="header-anchor">#</a> 在函数中嵌入装饰器</h4> <p>我们回到日志的例子，并创建一个包裹函数，能让我们指定一个用于输出的日志文件。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">def</span> <span class="token function">logit</span><span class="token punctuation">(</span>logfile<span class="token operator">=</span><span class="token string">'out.log'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">logging_decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">wrapped_function</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            log_string <span class="token operator">=</span> func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">&quot; was called&quot;</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>log_string<span class="token punctuation">)</span>
            <span class="token comment"># 打开logfile，并写入内容</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>logfile<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
                <span class="token comment"># 现在将日志打到指定的logfile</span>
                opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>log_string <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> wrapped_function
    <span class="token keyword">return</span> logging_decorator

@logit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">myfunc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

myfunc1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Output: myfunc1 was called</span>
<span class="token comment"># 现在一个叫做 out.log 的文件出现了，里面的内容就是上面的字符串</span>

<span class="token decorator annotation punctuation">@logit</span><span class="token punctuation">(</span>logfile<span class="token operator">=</span><span class="token string">'func2.log'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">myfunc2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

myfunc2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Output: myfunc2 was called</span>
<span class="token comment"># 现在一个叫做 func2.log 的文件出现了，里面的内容就是上面的字符串</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="装饰器类"><a href="#装饰器类" class="header-anchor">#</a> 装饰器类</h4> <p>现在我们有了能用于正式环境的<code>logit</code>装饰器，但当我们的应用的某些部分还比较脆弱时，异常也许是需要更紧急关注的事情。比方说有时你只想打日志到一个文件。而有时你想把引起你注意的问题发送到一个email，同时也保留日志，留个记录。这是一个使用继承的场景，但目前为止我们只看到过用来构建装饰器的函数。</p> <p>幸运的是，类也可以用来构建装饰器。那我们现在以一个类而不是一个函数的方式，来重新构建<code>logit</code>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">class</span> <span class="token class-name">logit</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> logfile<span class="token operator">=</span><span class="token string">'out.log'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logfile <span class="token operator">=</span> logfile

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">wrapped_function</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            log_string <span class="token operator">=</span> func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">&quot; was called&quot;</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>log_string<span class="token punctuation">)</span>
            <span class="token comment"># 打开logfile并写入</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>logfile<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
                <span class="token comment"># 现在将日志打到指定的文件</span>
                opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>log_string <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token comment"># 现在，发送一个通知</span>
            self<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> wrapped_function

    <span class="token keyword">def</span> <span class="token function">notify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># logit只打日志，不做别的</span>
        <span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这个实现有一个附加优势，在于比嵌套函数的方式更加整洁，而且包裹一个函数还是使用跟以前一样的语法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@logit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">myfunc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在，我们给<code>logit</code>创建子类，来添加email的功能(虽然email这个话题不会在这里展开)。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">email_logit</span><span class="token punctuation">(</span>logit<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    一个logit的实现版本，可以在函数调用时发送email给管理员
    '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'admin@myproject.com'</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>email <span class="token operator">=</span> email
        <span class="token builtin">super</span><span class="token punctuation">(</span>email_logit<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">notify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 发送一封email到self.email</span>
        <span class="token comment"># 这里就不做实现了</span>
        <span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>从现在起，<code>@email_logit</code>将会和<code>@logit</code>产生同样的效果，但是在打日志的基础上，还会多发送一封邮件给管理员。</p> <h2 id="global和return"><a href="#global和return" class="header-anchor">#</a> Global和Return</h2> <p>你也许遇到过, python中一些函数在最尾部有一个<code>return</code>关键字。你知道它是干嘛吗？它和其他语言的<code>return</code>类似。我们来检查下这个小函数：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> value1 <span class="token operator">+</span> value2

result <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment"># Output: 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面这个函数将两个值作为输入，然后输出它们相加之和。我们也可以这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span>value2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2

add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment"># Output: 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>那首先我们来谈谈第一段也就是包含<code>return</code>关键字的代码。那个函数把值赋给了调用它的变量（也就是例子中的result变量）。 大多数境况下，你并不需要使用<code>global</code>关键字。然而我们也来检查下另外一段也就是包含<code>global</code>关键字的代码。 那个函数生成了一个<code>global</code>（全局）变量result。</p> <p><code>global</code>在这的意思是什么？<code>global</code>变量意味着我们可以在函数以外的区域都能访问这个变量。让我们通过一个例子来证明它：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 首先，是没有使用global变量</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2

add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

<span class="token comment"># Oh 糟了，我们遇到异常了。为什么会这样？</span>
<span class="token comment"># python解释器报错说没有一个叫result的变量。</span>
<span class="token comment"># 这是因为result变量只能在创建它的函数内部才允许访问，除非它是全局的(global)。</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span>
    result
NameError<span class="token punctuation">:</span> name <span class="token string">'result'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined

<span class="token comment"># 现在我们运行相同的代码，不过是在将result变量设为global之后</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2

add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如我们所愿，在第二次运行时没有异常了。在实际的编程时，你应该试着避开<code>global</code>关键字，它只会让生活变得艰难，因为它引入了多余的变量到全局作用域了。</p> <h3 id="多个return值"><a href="#多个return值" class="header-anchor">#</a> 多个return值</h3> <p>那如果你想从一个函数里返回两个变量而不是一个呢？ 新手们有若干种方法。最著名的方法，是使用<code>global</code>关键字。让我们看下这个没用的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> name
    <span class="token keyword">global</span> age
    name <span class="token operator">=</span> <span class="token string">&quot;Danny&quot;</span>
    age <span class="token operator">=</span> <span class="token number">30</span>

profile<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token comment"># Output: Danny</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span>
<span class="token comment"># Output: 30</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>注意:</strong> 不要试着使用上述方法。重要的事情说三遍，不要试着使用上述方法！</p> <p>有些人试着在函数结束时，返回一个包含多个值的<code>tuple</code>(元组)，<code>list</code>(列表)或者<code>dict</code>(字典),来解决这个问题。这是一种可行的方式，而且使用起来像一个黑魔法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">&quot;Danny&quot;</span>
    age <span class="token operator">=</span> <span class="token number">30</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>

profile_data <span class="token operator">=</span> profile<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># Output: Danny</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 30</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>或者按照更常见的惯例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">&quot;Danny&quot;</span>
    age <span class="token operator">=</span> <span class="token number">30</span>
    <span class="token keyword">return</span> name<span class="token punctuation">,</span> age
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这是一种比列表和字典更好的方式。不要使用<code>global</code>关键字，除非你知道你正在做什么。<code>global</code>也许在某些场景下是一个更好的选择（但其中大多数情况都不是）。</p> <h2 id="对象变动-mutation"><a href="#对象变动-mutation" class="header-anchor">#</a> 对象变动 Mutation</h2> <p>Python中可变(<strong>mutable</strong>)与不可变(<strong>immutable</strong>)的数据类型让新手很是头痛。简单的说，可变(mutable)意味着&quot;可以被改动&quot;，而不可变(immutable)的意思是“常量(constant)”。想把脑筋转动起来吗？考虑下这个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hi'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token comment"># Output: ['hi']</span>

bar <span class="token operator">=</span> foo
bar <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token string">'bye'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token comment"># Output: ['hi', 'bye']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>刚刚发生了什么？我们预期的不是那样！我们期望看到是这样的：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hi'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token comment"># Output: ['hi']</span>

bar <span class="token operator">=</span> foo
bar <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token string">'bye'</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token comment"># Output: ['hi']</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
<span class="token comment"># Output: ['hi', 'bye']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这不是一个bug。这是对象可变性(<strong>mutability</strong>)在作怪。每当你将一个变量赋值为另一个可变类型的变量时，对这个数据的任意改动会同时反映到这两个变量上去。新变量只不过是老变量的一个别名而已。这个情况只是针对可变数据类型。下面的函数和可变数据类型让你一下就明白了：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add_to</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    target<span class="token punctuation">.</span>append<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target

add_to<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [1]</span>

add_to<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [1, 2]</span>

add_to<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [1, 2, 3]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>你可能预期它表现的不是这样子。你可能希望，当你调用<code>add_to</code>时，有一个新的列表被创建，就像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add_to</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    target<span class="token punctuation">.</span>append<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target

add_to<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [1]</span>

add_to<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [2]</span>

add_to<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [3]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>啊哈！这次又没有达到预期，是列表的可变性在作怪。在Python中当函数被定义时，默认参数只会运算一次，而不是每次被调用时都会重新运算。你应该永远不要定义可变类型的默认参数，除非你知道你正在做什么。你应该像这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add_to</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> target <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    target<span class="token punctuation">.</span>append<span class="token punctuation">(</span>element<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在每当你在调用这个函数不传入<code>target</code>参数的时候，一个新的列表会被创建。举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>add_to<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [42]</span>

add_to<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [42]</span>

add_to<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [42]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="slots魔法"><a href="#slots魔法" class="header-anchor">#</a> slots魔法</h2> <p>在Python中，每个类都有实例属性。默认情况下Python用一个字典来保存一个对象的实例属性。这非常有用，因为它允许我们在运行时去设置任意的新属性。</p> <p>然而，对于有着已知属性的小类来说，它可能是个瓶颈。这个字典浪费了很多内存。Python不能在对象创建时直接分配一个固定量的内存来保存所有的属性。因此如果你创建许多对象（我指的是成千上万个），它会消耗掉很多内存。 不过还是有一个方法来规避这个问题。这个方法需要使用<code>__slots__</code>来告诉Python不要使用字典，而且只给一个固定集合的属性分配空间。</p> <p>这里是一个使用与不使用<code>__slots__</code>的例子：</p> <ul><li><p>不使用 <code>__slots__</code>:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
      self<span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier
      self<span class="token punctuation">.</span>set_up<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment"># ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>使用 <code>__slots__</code>:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  __slots__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'identifier'</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
      self<span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier
      self<span class="token punctuation">.</span>set_up<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment"># ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul> <p>第二段代码会为你的内存减轻负担。通过这个技巧，有些人已经看到内存占用率几乎40%~50%的减少。稍微备注一下，你也许需要试一下PyPy。它已经默认地做了所有这些优化。</p> <p>以下你可以看到一个例子，它用IPython来展示在有与没有<code>__slots__</code>情况下的精确内存占用，感谢 https://github.com/ianozsvald/ipython_memory_usage</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>Python <span class="token number">3.4</span><span class="token number">.3</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Jun  <span class="token number">6</span> <span class="token number">2015</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">)</span>
Type <span class="token string">&quot;copyright&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;credits&quot;</span> <span class="token keyword">or</span> <span class="token string">&quot;license&quot;</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>

IPython <span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span><span class="token operator">-</span> An enhanced Interactive Python<span class="token punctuation">.</span>
?         <span class="token operator">-</span><span class="token operator">&gt;</span> Introduction <span class="token keyword">and</span> overview of IPython's features<span class="token punctuation">.</span>
<span class="token operator">%</span>quickref <span class="token operator">-</span><span class="token operator">&gt;</span> Quick reference<span class="token punctuation">.</span>
<span class="token builtin">help</span>      <span class="token operator">-</span><span class="token operator">&gt;</span> Python's own <span class="token builtin">help</span> system<span class="token punctuation">.</span>
<span class="token builtin">object</span>?   <span class="token operator">-</span><span class="token operator">&gt;</span> Details about <span class="token string">'object'</span><span class="token punctuation">,</span> use <span class="token string">'object??'</span> <span class="token keyword">for</span> extra details<span class="token punctuation">.</span>

In <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">import</span> ipython_memory_usage<span class="token punctuation">.</span>ipython_memory_usage <span class="token keyword">as</span> imu

In <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span> imu<span class="token punctuation">.</span>start_watching_memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
In <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> used <span class="token number">0.0000</span> MiB RAM <span class="token keyword">in</span> <span class="token number">5.</span>31s<span class="token punctuation">,</span> peaked <span class="token number">0.00</span> MiB above current<span class="token punctuation">,</span> total RAM usage <span class="token number">15.57</span> MiB

In <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">%</span>cat slots<span class="token punctuation">.</span>py
<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        __slots__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'identifier'</span><span class="token punctuation">]</span>
        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
                self<span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier

num <span class="token operator">=</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">256</span>
x <span class="token operator">=</span> <span class="token punctuation">[</span>MyClass<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">]</span>
In <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> used <span class="token number">0.2305</span> MiB RAM <span class="token keyword">in</span> <span class="token number">0.</span>12s<span class="token punctuation">,</span> peaked <span class="token number">0.00</span> MiB above current<span class="token punctuation">,</span> total RAM usage <span class="token number">15.80</span> MiB

In <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">from</span> slots <span class="token keyword">import</span> <span class="token operator">*</span>
In <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> used <span class="token number">9.3008</span> MiB RAM <span class="token keyword">in</span> <span class="token number">0.</span>72s<span class="token punctuation">,</span> peaked <span class="token number">0.00</span> MiB above current<span class="token punctuation">,</span> total RAM usage <span class="token number">25.10</span> MiB

In <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">%</span>cat noslots<span class="token punctuation">.</span>py
<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
                self<span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier

num <span class="token operator">=</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">256</span>
x <span class="token operator">=</span> <span class="token punctuation">[</span>MyClass<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">]</span>
In <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> used <span class="token number">0.1758</span> MiB RAM <span class="token keyword">in</span> <span class="token number">0.</span>12s<span class="token punctuation">,</span> peaked <span class="token number">0.00</span> MiB above current<span class="token punctuation">,</span> total RAM usage <span class="token number">25.28</span> MiB

In <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">from</span> noslots <span class="token keyword">import</span> <span class="token operator">*</span>
In <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> used <span class="token number">22.6680</span> MiB RAM <span class="token keyword">in</span> <span class="token number">0.</span>80s<span class="token punctuation">,</span> peaked <span class="token number">0.00</span> MiB above current<span class="token punctuation">,</span> total RAM usage <span class="token number">47.95</span> MiB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h2 id="虚拟环境-virtualenv"><a href="#虚拟环境-virtualenv" class="header-anchor">#</a> 虚拟环境 Virtualenv</h2> <h3 id="你听说过virtualenv吗？"><a href="#你听说过virtualenv吗？" class="header-anchor">#</a> 你听说过<code>virtualenv</code>吗？</h3> <p>如果你是一位初学者，你可能没有听说过<code>virtualenv</code>；但如果你是位经验丰富的程序员，那么它可能是你的工具集的重要组成部分。</p> <h3 id="那么，什么是virtualenv"><a href="#那么，什么是virtualenv" class="header-anchor">#</a> 那么，什么是<code>virtualenv</code>?</h3> <p><code>Virtualenv</code> 是一个工具，它能够帮我们创建一个独立(隔离)的Python环境。想象你有一个应用程序，依赖于版本为2的第三方模块，但另一个程序依赖的版本是3，请问你如何使用和开发这些应用程序？</p> <p>如果你把一切都安装到了<code>/usr/lib/python2.7/site-packages</code>（或者其它平台的标准位置），那很容易出现某个模块被升级而你却不知道的情况。</p> <p>在另一种情况下，想象你有一个已经开发完成的程序，但是你不想更新它所依赖的第三方模块版本；但你已经开始另一个程序，需要这些第三方模块的版本。</p> <h3 id="用什么方式解决？"><a href="#用什么方式解决？" class="header-anchor">#</a> 用什么方式解决？</h3> <p>使用<code>virtualenv</code>！针对每个程序创建独立（隔离）的Python环境，而不是在全局安装所依赖的模块。</p> <p>要安装它，只需要在命令行中输入以下命令：</p> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>$ pip install virtualenv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最重要的命令是：</p> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>$ virtualenv myproject
$ source myproject/bin/activate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行第一个命令在<code>myproject</code>文件夹创建一个隔离的virtualenv环境，第二个命令激活这个隔离的环境(<code>virtualenv</code>)。</p> <p>在创建virtualenv时，你必须做出决定：这个virtualenv是使用系统全局的模块呢？还是只使用这个virtualenv内的模块。 默认情况下，virtualenv不会使用系统全局模块。</p> <p>如果你想让你的virtualenv使用系统全局模块，请使用<code>--system-site-packages</code>参数创建你的virtualenv，例如：</p> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>virtualenv --system-site-packages mycoolproject
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用以下命令可以退出这个virtualenv:</p> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>$ deactivate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行之后将恢复使用你系统全局的Python模块。</p> <h3 id="福利"><a href="#福利" class="header-anchor">#</a> 福利</h3> <p>你可以使用<code>smartcd</code>来帮助你管理你的环境，当你切换目录时，它可以帮助你激活（activate）和退出（deactivate）你的virtualenv。我已经用了很多次，很喜欢它。你可以在github(https://github.com/cxreg/smartcd) 上找到更多关于它的资料。</p> <p>这只是一个virtualenv的简短介绍，你可以在 http://docs.python-guide.org/en/latest/dev/virtualenvs/ 找到更多信息。</p> <h2 id="容器-collections"><a href="#容器-collections" class="header-anchor">#</a> 容器 Collections</h2> <h3 id="容器-collections-2"><a href="#容器-collections-2" class="header-anchor">#</a> 容器(<code>Collections</code>)</h3> <p>Python附带一个模块，它包含许多容器数据类型，名字叫作<code>collections</code>。我们将讨论它的作用和用法。我们将讨论的是：</p> <ul><li>defaultdict</li> <li>counter</li> <li>deque</li> <li>namedtuple</li> <li>enum.Enum (包含在Python 3.4以上)</li></ul> <h3 id="defaultdict"><a href="#defaultdict" class="header-anchor">#</a> defaultdict</h3> <p>我个人使用<code>defaultdict</code>较多，与<code>dict</code>类型不同，你不需要检查<strong>key</strong>是否存在，所以我们能这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict

colours <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token string">'Yasoob'</span><span class="token punctuation">,</span> <span class="token string">'Yellow'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ali'</span><span class="token punctuation">,</span> <span class="token string">'Blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Arham'</span><span class="token punctuation">,</span> <span class="token string">'Green'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ali'</span><span class="token punctuation">,</span> <span class="token string">'Black'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Yasoob'</span><span class="token punctuation">,</span> <span class="token string">'Red'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ahmed'</span><span class="token punctuation">,</span> <span class="token string">'Silver'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

favourite_colours <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> name<span class="token punctuation">,</span> colour <span class="token keyword">in</span> colours<span class="token punctuation">:</span>
    favourite_colours<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>colour<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>favourite_colours<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>运行输出</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># defaultdict(&lt;type 'list'&gt;,</span>
<span class="token comment">#    {'Arham': ['Green'],</span>
<span class="token comment">#     'Yasoob': ['Yellow', 'Red'],</span>
<span class="token comment">#     'Ahmed': ['Silver'],</span>
<span class="token comment">#     'Ali': ['Blue', 'Black']</span>
<span class="token comment"># })</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>另一种重要的是例子就是：当你在一个字典中对一个键进行嵌套赋值时，如果这个键不存在，会触发<code>keyError</code>异常。 <code>defaultdict</code>允许我们用一个聪明的方式绕过这个问题。 首先我分享一个使用<code>dict</code>触发<code>KeyError</code>的例子，然后提供一个使用<code>defaultdict</code>的解决方案。</p> <p><strong>问题</strong>：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>some_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
some_dict<span class="token punctuation">[</span><span class="token string">'colours'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'favourite'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;yellow&quot;</span>

<span class="token comment">## 异常输出：KeyError: 'colours'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>解决方案</strong>：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> collections
tree <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> collections<span class="token punctuation">.</span>defaultdict<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
some_dict <span class="token operator">=</span> tree<span class="token punctuation">(</span><span class="token punctuation">)</span>
some_dict<span class="token punctuation">[</span><span class="token string">'colours'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'favourite'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;yellow&quot;</span>

<span class="token comment">## 运行正常</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>你可以用<code>json.dumps</code>打印出<code>some_dict</code>，例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> json
<span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>some_dict<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: {&quot;colours&quot;: {&quot;favourite&quot;: &quot;yellow&quot;}}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="counter"><a href="#counter" class="header-anchor">#</a> counter</h3> <p>Counter是一个计数器，它可以帮助我们针对某项数据进行计数。比如它可以用来计算每个人喜欢多少种颜色：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter

colours <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token string">'Yasoob'</span><span class="token punctuation">,</span> <span class="token string">'Yellow'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ali'</span><span class="token punctuation">,</span> <span class="token string">'Blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Arham'</span><span class="token punctuation">,</span> <span class="token string">'Green'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ali'</span><span class="token punctuation">,</span> <span class="token string">'Black'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Yasoob'</span><span class="token punctuation">,</span> <span class="token string">'Red'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Ahmed'</span><span class="token punctuation">,</span> <span class="token string">'Silver'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

favs <span class="token operator">=</span> Counter<span class="token punctuation">(</span>name <span class="token keyword">for</span> name<span class="token punctuation">,</span> colour <span class="token keyword">in</span> colours<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>favs<span class="token punctuation">)</span>

<span class="token comment">## 输出:</span>
<span class="token comment">## Counter({</span>
<span class="token comment">##     'Yasoob': 2,</span>
<span class="token comment">##     'Ali': 2,</span>
<span class="token comment">##     'Arham': 1,</span>
<span class="token comment">##     'Ahmed': 1</span>
<span class="token comment">##  })</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>我们也可以在利用它统计一个文件，例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    line_count <span class="token operator">=</span> Counter<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>line_count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="deque"><a href="#deque" class="header-anchor">#</a> deque</h3> <p>deque提供了一个双端队列，你可以从头/尾两端添加或删除元素。要想使用它，首先我们要从<code>collections</code>中导入<code>deque</code>模块：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> deque
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在，你可以创建一个<code>deque</code>对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它的用法就像python的<code>list</code>，并且提供了类似的方法，例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
d<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
d<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
d<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: 3</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: '1'</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: '3'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>你可以从两端取出(pop)数据：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: 5</span>

d<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: 0</span>

d<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: 4</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>

<span class="token comment">## 输出: deque([1, 2, 3])</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们也可以限制这个列表的大小，当超出你设定的限制时，数据会从对队列另一端被挤出去(pop)。 最好的解释是给出一个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>d <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在当你插入30条数据时，最左边一端的数据将从队列中删除。你还可以从任一端扩展这个队列中的数据：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
d<span class="token punctuation">.</span>extendleft<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
d<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>

<span class="token comment">## 输出: deque([0, 1, 2, 3, 4, 5, 6, 7, 8])</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="namedtuple"><a href="#namedtuple" class="header-anchor">#</a> namedtuple</h3> <p>您可能已经熟悉元组。 一个元组是一个不可变的列表，你可以存储一个数据的序列，它和命名元组(<code>namedtuples</code>)非常像，但有几个关键的不同。 主要相似点是都不像列表，你不能修改元组中的数据。为了获取元组中的数据，你需要使用整数作为索引：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>man <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Ali'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: Ali</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>嗯，那<code>namedtuples</code>是什么呢？它把元组变成一个针对简单任务的容器。你不必使用整数索引来访问一个<code>namedtuples</code>的数据。你可以像字典(<code>dict</code>)一样访问<code>namedtuples</code>，但<code>namedtuples</code>是不可变的。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Animal <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> <span class="token string">'name age type'</span><span class="token punctuation">)</span>
perry <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;perry&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>perry<span class="token punctuation">)</span>

<span class="token comment">## 输出: Animal(name='perry', age=31, type='cat')</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>perry<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment">## 输出: 'perry'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>现在你可以看到，我们可以用名字来访问<code>namedtuple</code>中的数据。我们再继续分析它。一个命名元组(<code>namedtuple</code>)有两个必需的参数。它们是元组名称和字段名称。</p> <p>在上面的例子中，我们的元组名称是<code>Animal</code>，字段名称是'name'，'age'和'type'。 <code>namedtuple</code>让你的元组变得<strong>自文档</strong>了。你只要看一眼就很容易理解代码是做什么的。 你也不必使用整数索引来访问一个命名元组，这让你的代码更易于维护。 而且，**<code>namedtuple</code>**<strong>的每个实例没有对象字典</strong>，所以它们很轻量，与普通的元组比，并不需要更多的内存。这使得它们比字典更快。</p> <p>然而，要记住它是一个元组，属性值在<code>namedtuple</code>中是不可变的，所以下面的代码不能工作：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Animal <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> <span class="token string">'name age type'</span><span class="token punctuation">)</span>
perry <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;perry&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">)</span>
perry<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">42</span>

<span class="token comment">## 输出:</span>
<span class="token comment">## Traceback (most recent call last):</span>
<span class="token comment">##     File &quot;&quot;, line 1, in</span>
<span class="token comment">## AttributeError: can't set attribute</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>你应该使用命名元组来让代码<strong>自文档</strong>，<strong>它们向后兼容于普通的元组</strong>，这意味着你可以既使用整数索引，也可以使用名称来访问<code>namedtuple</code>：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Animal <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> <span class="token string">'name age type'</span><span class="token punctuation">)</span>
perry <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;perry&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>perry<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: perry</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最后，你可以将一个命名元组转换为字典，方法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Animal <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> <span class="token string">'name age type'</span><span class="token punctuation">)</span>
perry <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Perry&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>perry<span class="token punctuation">.</span>_asdict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">## 输出: OrderedDict([('name', 'Perry'), ('age', 31), ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="enum-enum-python-3-4"><a href="#enum-enum-python-3-4" class="header-anchor">#</a> enum.Enum (Python 3.4+)</h3> <p>另一个有用的容器是枚举对象，它属于<code>enum</code>模块，存在于Python 3.4以上版本中（同时作为一个独立的PyPI包<code>enum34</code>供老版本使用）。Enums(枚举类型)基本上是一种组织各种东西的方式。</p> <p>让我们回顾一下上一个'Animal'命名元组的例子。 它有一个type字段，问题是，type是一个字符串。 那么问题来了，万一程序员输入了<code>Cat</code>，因为他按到了Shift键，或者输入了'CAT'，甚至'kitten'？</p> <p>枚举可以帮助我们避免这个问题，通过不使用字符串。考虑以下这个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum

<span class="token keyword">class</span> <span class="token class-name">Species</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cat <span class="token operator">=</span> <span class="token number">1</span>
    dog <span class="token operator">=</span> <span class="token number">2</span>
    horse <span class="token operator">=</span> <span class="token number">3</span>
    aardvark <span class="token operator">=</span> <span class="token number">4</span>
    butterfly <span class="token operator">=</span> <span class="token number">5</span>
    owl <span class="token operator">=</span> <span class="token number">6</span>
    platypus <span class="token operator">=</span> <span class="token number">7</span>
    dragon <span class="token operator">=</span> <span class="token number">8</span>
    unicorn <span class="token operator">=</span> <span class="token number">9</span>
    <span class="token comment"># 依次类推</span>

    <span class="token comment"># 但我们并不想关心同一物种的年龄，所以我们可以使用一个别名</span>
    kitten <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># (译者注：幼小的猫咪)</span>
    puppy <span class="token operator">=</span> <span class="token number">2</span>   <span class="token comment"># (译者注：幼小的狗狗)</span>

Animal <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> <span class="token string">'name age type'</span><span class="token punctuation">)</span>
perry <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Perry&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>Species<span class="token punctuation">.</span>cat<span class="token punctuation">)</span>
drogon <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Drogon&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>Species<span class="token punctuation">.</span>dragon<span class="token punctuation">)</span>
tom <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Tom&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>Species<span class="token punctuation">.</span>cat<span class="token punctuation">)</span>
charlie <span class="token operator">=</span> Animal<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Charlie&quot;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>Species<span class="token punctuation">.</span>kitten<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>现在，我们进行一些测试：</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> charlie<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> tom<span class="token punctuation">.</span><span class="token builtin">type</span>
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> charlie<span class="token punctuation">.</span><span class="token builtin">type</span>
<span class="token operator">&lt;</span>Species<span class="token punctuation">.</span>cat<span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样就没那么容易错误，我们必须更明确，而且我们应该只使用定义后的枚举类型。</p> <p>有三种方法访问枚举数据，例如以下方法都可以获取到'cat'的值：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>Species<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Species<span class="token punctuation">[</span><span class="token string">'cat'</span><span class="token punctuation">]</span>
Species<span class="token punctuation">.</span>cat
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这只是一个快速浏览<code>collections</code>模块的介绍，建议你阅读本文最后的官方文档。</p> <h3 id="枚举-enumerate"><a href="#枚举-enumerate" class="header-anchor">#</a> 枚举 Enumerate</h3> <p>枚举(<code>enumerate</code>)是Python内置函数。它的用处很难在简单的一行中说明，但是大多数的新人，甚至一些高级程序员都没有意识到它。它允许我们遍历数据并自动计数，</p> <p>下面是一个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> counter<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>some_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>不只如此，<code>enumerate</code>也接受一些可选参数，这使它更有用。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>my_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'grapes'</span><span class="token punctuation">,</span> <span class="token string">'pear'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> c<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>my_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

<span class="token comment"># 输出:</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'apple'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'grapes'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'pear'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面这个可选参数允许我们定制从哪个数字开始枚举。 你还可以用来创建包含索引的元组列表， 例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>my_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'grapes'</span><span class="token punctuation">,</span> <span class="token string">'pear'</span><span class="token punctuation">]</span>
counter_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>my_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>counter_list<span class="token punctuation">)</span>
<span class="token comment"># 输出: [(1, 'apple'), (2, 'banana'), (3, 'grapes'), (4, 'pear')]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="对象自省"><a href="#对象自省" class="header-anchor">#</a> 对象自省</h2> <p>自省(introspection)，在计算机编程领域里，是指在运行时来判断一个对象的类型的能力。它是Python的强项之一。Python中所有一切都是一个对象，而且我们可以仔细勘察那些对象。Python还包含了许多内置函数和模块来帮助我们。</p> <h3 id="dir"><a href="#dir" class="header-anchor">#</a> dir</h3> <p>在这个小节里我们会学习到<code>dir</code>以及它在自省方面如何给我们提供便利。它是用于自省的最重要的函数之一。它返回一个列表，列出了一个对象所拥有的属性和方法。这里是一个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>my_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token builtin">dir</span><span class="token punctuation">(</span>my_list<span class="token punctuation">)</span>
<span class="token comment"># Output: ['__add__', '__class__', '__contains__', '__delattr__', '__delitem__',</span>
<span class="token comment"># '__delslice__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__',</span>
<span class="token comment"># '__getitem__', '__getslice__', '__gt__', '__hash__', '__iadd__', '__imul__',</span>
<span class="token comment"># '__init__', '__iter__', '__le__', '__len__', '__lt__', '__mul__', '__ne__',</span>
<span class="token comment"># '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__reversed__', '__rmul__',</span>
<span class="token comment"># '__setattr__', '__setitem__', '__setslice__', '__sizeof__', '__str__',</span>
<span class="token comment"># '__subclasshook__', 'append', 'count', 'extend', 'index', 'insert', 'pop',</span>
<span class="token comment"># 'remove', 'reverse', 'sort']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上面的自省给了我们一个列表对象的所有方法的名字。当你没法回忆起一个方法的名字，这会非常有帮助。如果我们运行<code>dir()</code>而不传入参数，那么它会返回当前作用域的所有名字。</p> <h3 id="type和id"><a href="#type和id" class="header-anchor">#</a> type和id</h3> <p><code>type</code>函数返回一个对象的类型。举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;type 'str'&gt;</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;type 'list'&gt;</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;type 'dict'&gt;</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;type 'type'&gt;</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;type 'int'&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>id()</code>函数返回任意不同种类对象的唯一ID，举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>name <span class="token operator">=</span> <span class="token string">&quot;Yasoob&quot;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 139972439030304</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="inspect模块"><a href="#inspect模块" class="header-anchor">#</a> inspect模块</h3> <p><code>inspect</code>模块也提供了许多有用的函数，来获取活跃对象的信息。比方说，你可以查看一个对象的成员，只需运行：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> inspect
<span class="token keyword">print</span><span class="token punctuation">(</span>inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [('__add__', &lt;slot wrapper '__add__' of ... ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>还有好多个其他方法也能有助于自省。如果你愿意，你可以去探索它们。</p> <h2 id="推导式-comprehension"><a href="#推导式-comprehension" class="header-anchor">#</a> 推导式 Comprehension</h2> <p>推导式（又称解析式）是Python的一种独有特性，如果我被迫离开了它，我会非常想念。推导式是可以从一个数据序列构建另一个新的数据序列的结构体。 共有三种推导，在Python2和3中都有支持：</p> <ul><li>列表(<code>list</code>)推导式</li> <li>字典(<code>dict</code>)推导式</li> <li>集合(<code>set</code>)推导式</li></ul> <p>我们将一一进行讨论。一旦你知道了使用列表推导式的诀窍，你就能轻易使用任意一种推导式了。</p> <h3 id="列表推导式"><a href="#列表推导式" class="header-anchor">#</a> 列表推导式</h3> <p>列表推导式（又称列表解析式）提供了一种简明扼要的方法来创建列表。 它的结构是在一个中括号里包含一个表达式，然后是一个<code>for</code>语句，然后是0个或多个<code>for</code>或者<code>if</code>语句。那个表达式可以是任意的，意思是你可以在列表中放入任意类型的对象。返回结果将是一个新的列表，在这个以<code>if</code>和<code>for</code>语句为上下文的表达式运行完成之后产生。</p> <h4 id="规范"><a href="#规范" class="header-anchor">#</a> 规范</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>variable <span class="token operator">=</span> <span class="token punctuation">[</span>out_exp <span class="token keyword">for</span> out_exp <span class="token keyword">in</span> input_list <span class="token keyword">if</span> out_exp <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里是另外一个简明例子:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>multiples <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token keyword">is</span> <span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>multiples<span class="token punctuation">)</span>
<span class="token comment"># Output: [0, 3, 6, 9, 12, 15, 18, 21, 24, 27]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这将对快速生成列表非常有用。 有些人甚至更喜欢使用它而不是<code>filter</code>函数。 列表推导式在有些情况下超赞，特别是当你需要使用<code>for</code>循环来生成一个新列表。举个例子，你通常会这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>squared <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    squared<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你可以使用列表推导式来简化它，就像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>squared <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="字典推导式"><a href="#字典推导式" class="header-anchor">#</a> 字典推导式</h3> <p>字典推导和列表推导的使用方法是类似的。这里有个我最近发现的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>mcase <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Z'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>

mcase_frequency <span class="token operator">=</span> <span class="token punctuation">{</span>
    k<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> mcase<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> mcase<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> mcase<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># mcase_frequency == {'a': 17, 'z': 3, 'b': 34}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在上面的例子中我们把同一个字母但不同大小写的值合并起来了。就我个人来说没有大量使用字典推导式。你还可以快速对换一个字典的键和值：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span>v<span class="token punctuation">:</span> k <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> some_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="集合推导式"><a href="#集合推导式" class="header-anchor">#</a> 集合推导式</h3> <p>它们跟列表推导式也是类似的。 唯一的区别在于它们使用大括号<code>{}</code>。 举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>squared <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>squared<span class="token punctuation">)</span>
<span class="token comment"># Output: {1, 4}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="异常"><a href="#异常" class="header-anchor">#</a> 异常</h2> <p>异常处理是一种艺术，一旦你掌握，会授予你无穷的力量。我将要向你展示我们能处理异常的一些方式。</p> <p>最基本的术语里我们知道了<code>try/except</code>从句。可能触发异常产生的代码会放到<code>try</code>语句块里，而处理异常的代码会在<code>except</code>语句块里实现。这是一个简单的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'An IOError occurred. {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的例子里，我们仅仅在处理一个<code>IOError</code>的异常。大部分初学者还不知道的是，我们可以处理多个异常。</p> <h3 id="处理多个异常"><a href="#处理多个异常" class="header-anchor">#</a> 处理多个异常</h3> <p>我们可以使用三种方法来处理多个异常。</p> <p>第一种方法需要把所有可能发生的异常放到一个元组里。像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> <span class="token punctuation">(</span>IOError<span class="token punctuation">,</span> EOFError<span class="token punctuation">)</span> <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;An error occurred. {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>另外一种方式是对每个单独的异常在单独的<code>except</code>语句块中处理。我们想要多少个<code>except</code>语句块都可以。这里是个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> EOFError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;An EOF error occurred.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> e
<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;An error occurred.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> e
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面这个方式中，如果异常没有被第一个<code>except</code>语句块处理，那么它也许被下一个语句块处理，或者根本不会被处理。</p> <p>现在，最后一种方式会捕获<strong>所有</strong>异常：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
    <span class="token comment"># 打印一些异常日志，如果你想要的话</span>
    <span class="token keyword">raise</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当你不知道你的程序会抛出什么样的异常时，上面的方式可能非常有帮助。</p> <h4 id="finally从句"><a href="#finally从句" class="header-anchor">#</a> finally从句</h4> <p>我们把我们的主程序代码包裹进了<code>try</code>从句。然后我们把一些代码包裹进一个<code>except</code>从句，它会在<code>try</code>从句中的代码触发异常时执行。</p> <p>在下面的例子中，我们还会使用第三个从句，那就是<code>finally</code>从句。包裹到<code>finally</code>从句中的代码不管异常是否触发都将会被执行。这可以被用来在脚本执行之后做清理工作。这里是个简单的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'An IOError occurred. {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;This would be printed whether or not an exception occurred!&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># Output: An IOError occurred. No such file or directory</span>
<span class="token comment"># This would be printed whether or not an exception occurred!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="try-else从句"><a href="#try-else从句" class="header-anchor">#</a> try/else从句</h4> <p>我们常常想在没有触发异常的时候执行一些代码。这可以很轻松地通过一个<code>else</code>从句来达到。</p> <p>有人也许问了：如果你只是想让一些代码在没有触发异常的情况下执行，为啥你不直接把代码放在<code>try</code>里面呢？ 回答是，那样的话这段代码中的任意异常都还是会被<code>try</code>捕获，而你并不一定想要那样。</p> <p>大多数人并不使用<code>else</code>从句，而且坦率地讲我自己也没有大范围使用。这里是个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'I am sure no exception is going to occur!'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'exception'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里的代码只会在try语句里没有触发异常时运行,</span>
    <span class="token comment"># 但是这里的异常将 *不会* 被捕获</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This would only run if no exception occurs. And an error here '</span>
          <span class="token string">'would NOT be caught.'</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This would be printed in every case.'</span><span class="token punctuation">)</span>

<span class="token comment"># Output: I am sure no exception is going to occur!</span>
<span class="token comment"># This would only run if no exception occurs.</span>
<span class="token comment"># This would be printed in every case.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>else</code>从句只会在没有异常的情况下执行，而且它会在<code>finally</code>语句之前执行。</p> <h2 id="lambda表达式"><a href="#lambda表达式" class="header-anchor">#</a> lambda表达式</h2> <p><code>lambda</code>表达式是一行函数。 它们在其他语言中也被称为匿名函数。如果你不想在程序中对一个函数使用两次，你也许会想用lambda表达式，它们和普通的函数完全一样。</p> <p><strong>原型</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">lambda</span> 参数<span class="token punctuation">:</span>操作<span class="token punctuation">(</span>参数<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>例子</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    add <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">+</span> y

    <span class="token keyword">print</span><span class="token punctuation">(</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Output: 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这还有一些lambda表达式的应用案例，可以在一些特殊情况下使用：</p> <p><strong>列表排序</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    a<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token comment"># Output: [(13, -3), (4, 1), (1, 2), (9, 10)]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>列表并行排序</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    data <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>list1<span class="token punctuation">,</span> list2<span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    list1<span class="token punctuation">,</span> list2 <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> t<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="一行式"><a href="#一行式" class="header-anchor">#</a> 一行式</h2> <p>本章节,我将向大家展示一些一行式的Python命令，这些程序将对你非常有帮助。</p> <p><strong>简易Web Server</strong></p> <p>你是否想过通过网络快速共享文件？好消息，Python为你提供了这样的功能。进入到你要共享文件的目录下并在命令行中运行下面的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token comment"># Python 2</span>
    python <span class="token operator">-</span>m SimpleHTTPServer

    <span class="token comment"># Python 3</span>
    python <span class="token operator">-</span>m http<span class="token punctuation">.</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>漂亮的打印</strong></p> <p>你可以在Python REPL漂亮的打印出列表和字典。这里是相关的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">from</span> pprint <span class="token keyword">import</span> pprint

    my_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Yasoob'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token string">'undefined'</span><span class="token punctuation">,</span> <span class="token string">'personality'</span><span class="token punctuation">:</span> <span class="token string">'awesome'</span><span class="token punctuation">}</span>
    pprint<span class="token punctuation">(</span>my_dict<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这种方法在字典上更为有效。此外，如果你想快速漂亮的从文件打印出json数据，那么你可以这么做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    cat <span class="token builtin">file</span><span class="token punctuation">.</span>json <span class="token operator">|</span> python <span class="token operator">-</span>m json<span class="token punctuation">.</span>tool
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>脚本性能分析</strong> 这可能在定位你的脚本中的性能瓶颈时，会非常奏效：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    python <span class="token operator">-</span>m cProfile my_script<span class="token punctuation">.</span>py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>备注：<code>cProfile</code>是一个比<code>profile</code>更快的实现，因为它是用c写的</p> <p><strong>CSV转换为json</strong></p> <p>在命令行执行这条指令</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    python <span class="token operator">-</span>c <span class="token string">&quot;import csv,json;print json.dumps(list(csv.reader(open('csv_file.csv'))))&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>确保更换<code>csv_file.csv</code>为你想要转换的csv文件</p> <p><strong>列表辗平</strong></p> <p>您可以通过使用<code>itertools</code>包中的<code>itertools.chain.from_iterable</code>轻松快速的辗平一个列表。下面是一个简单的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    a_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>itertools<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>from_iterable<span class="token punctuation">(</span>a_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Output: [1, 2, 3, 4, 5, 6]</span>

    <span class="token comment"># or</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token operator">*</span>a_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Output: [1, 2, 3, 4, 5, 6]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>一行式的构造器</strong></p> <p>避免类初始化时大量重复的赋值语句</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span>k<span class="token punctuation">:</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> k <span class="token operator">!=</span> <span class="token string">'self'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>更多的一行方法请参考[Python官方文档](https://wiki.python.org/moin/Powerful Python One-Liners)。</p> <h2 id="for-else"><a href="#for-else" class="header-anchor">#</a> For - Else</h2> <p>循环是任何语言的一个必备要素。同样地，<code>for</code>循环就是Python的一个重要组成部分。然而还有一些东西是初学者并不知道的。我们将一个个讨论一下。</p> <p>我们先从已经知道的开始。我们知道可以像这样使用<code>for</code>循环：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>fruits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'mango'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> fruit <span class="token keyword">in</span> fruits<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>fruit<span class="token punctuation">.</span>capitalize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Output: Apple</span>
<span class="token comment">#         Banana</span>
<span class="token comment">#         Mango</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这是一个<code>for</code>循环非常基础的结构。现在我们继续看看，Python的<code>for</code>循环的一些鲜为人所知的特性。</p> <h3 id="else语句"><a href="#else语句" class="header-anchor">#</a> else语句</h3> <p><code>for</code>循环还有一个<code>else</code>从句，我们大多数人并不熟悉。这个<code>else</code>从句会在循环正常结束时执行。这意味着，循环没有遇到任何<code>break</code>. 一旦你掌握了何时何地使用它，它真的会非常有用。我自己对它真是相见恨晚。</p> <p>有个常见的构造是跑一个循环，并查找一个元素。如果这个元素被找到了，我们使用<code>break</code>来中断这个循环。有两个场景会让循环停下来。</p> <ul><li>第一个是当一个元素被找到，<code>break</code>被触发。</li> <li>第二个场景是循环结束。</li></ul> <p>现在我们也许想知道其中哪一个，才是导致循环完成的原因。一个方法是先设置一个标记，然后在循环结束时打上标记。另一个是使用<code>else</code>从句。这就是<code>for/else</code>循环的基本结构：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> item <span class="token keyword">in</span> container<span class="token punctuation">:</span>
    <span class="token keyword">if</span> search_something<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Found it!</span>
        process<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># Didn't find anything..</span>
    not_found_in_container<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>考虑下这个简单的案例，它是我从官方文档里拿来的：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> n <span class="token operator">%</span> x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">'equals'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> n <span class="token operator">/</span> x<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>它会找出2到10之间的数字的因子。现在是趣味环节了。我们可以加上一个附加的else语句块，来抓住质数，并且告诉我们：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> n <span class="token operator">%</span> x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">'equals'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> n <span class="token operator">/</span> x<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># loop fell through without finding a factor</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">'is a prime number'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="使用c扩展"><a href="#使用c扩展" class="header-anchor">#</a> 使用C扩展</h2> <p>CPython还为开发者实现了一个有趣的特性，使用Python可以轻松调用C代码</p> <p>开发者有三种方法可以在自己的Python代码中来调用C编写的函数-<code>ctypes</code>，<code>SWIG</code>，<code>Python/C API</code>。每种方式也都有各自的利弊。首先，我们要明确为什么要在Python中调用C？</p> <p>常见原因如下：</p> <ul><li>你要提升代码的运行速度，而且你知道C要比Python快50倍以上</li> <li>C语言中有很多传统类库，而且有些正是你想要的，但你又不想用Python去重写它们</li> <li>想对从内存到文件接口这样的底层资源进行访问</li> <li>不需要理由，就是想这样做</li></ul> <h3 id="ctypes"><a href="#ctypes" class="header-anchor">#</a> CTypes</h3> <p>Python中的<a href="https://docs.python.org/2/library/ctypes.html" target="_self" rel="noopener noreferrer">ctypes模块</a>可能是Python调用C方法中最简单的一种。ctypes模块提供了和C语言兼容的数据类型和函数来加载dll文件，因此在调用时不需对源文件做任何的修改。也正是如此奠定了这种方法的简单性。</p> <p>示例如下</p> <p>实现两数求和的C代码，保存为<code>add.c</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span>sample C <span class="token builtin">file</span> to add <span class="token number">2</span> numbers <span class="token operator">-</span> <span class="token builtin">int</span> <span class="token keyword">and</span> floats

<span class="token comment">#include &lt;stdio.h&gt;</span>

<span class="token builtin">int</span> add_int<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">float</span> add_float<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token builtin">int</span> add_int<span class="token punctuation">(</span><span class="token builtin">int</span> num1<span class="token punctuation">,</span> <span class="token builtin">int</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token builtin">float</span> add_float<span class="token punctuation">(</span><span class="token builtin">float</span> num1<span class="token punctuation">,</span> <span class="token builtin">float</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>接下来将C文件编译为<code>.so</code>文件(windows下为DLL)。下面操作会生成adder.so文件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#For Linux</span>
$  gcc <span class="token operator">-</span>shared <span class="token operator">-</span>Wl<span class="token punctuation">,</span><span class="token operator">-</span>soname<span class="token punctuation">,</span>adder <span class="token operator">-</span>o adder<span class="token punctuation">.</span>so <span class="token operator">-</span>fPIC add<span class="token punctuation">.</span>c

<span class="token comment">#For Mac</span>
$ gcc <span class="token operator">-</span>shared <span class="token operator">-</span>Wl<span class="token punctuation">,</span><span class="token operator">-</span>install_name<span class="token punctuation">,</span>adder<span class="token punctuation">.</span>so <span class="token operator">-</span>o adder<span class="token punctuation">.</span>so <span class="token operator">-</span>fPIC add<span class="token punctuation">.</span>c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在在你的Python代码中来调用它</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment">#load the shared object file</span>
adder <span class="token operator">=</span> CDLL<span class="token punctuation">(</span><span class="token string">'./adder.so'</span><span class="token punctuation">)</span>

<span class="token comment">#Find sum of integers</span>
res_int <span class="token operator">=</span> adder<span class="token punctuation">.</span>add_int<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">&quot;Sum of 4 and 5 = &quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res_int<span class="token punctuation">)</span>

<span class="token comment">#Find sum of floats</span>
a <span class="token operator">=</span> c_float<span class="token punctuation">(</span><span class="token number">5.5</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> c_float<span class="token punctuation">(</span><span class="token number">4.1</span><span class="token punctuation">)</span>

add_float <span class="token operator">=</span> adder<span class="token punctuation">.</span>add_float
add_float<span class="token punctuation">.</span>restype <span class="token operator">=</span> c_float
<span class="token keyword">print</span> <span class="token string">&quot;Sum of 5.5 and 4.1 = &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>add_float<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>Sum of <span class="token number">4</span> <span class="token keyword">and</span> <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">9</span>
Sum of <span class="token number">5.5</span> <span class="token keyword">and</span> <span class="token number">4.1</span> <span class="token operator">=</span>  <span class="token number">9.60000038147</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在这个例子中，C文件是自解释的，它包含两个函数，分别实现了整形求和和浮点型求和。</p> <p>在Python文件中，一开始先导入ctypes模块，然后使用CDLL函数来加载我们创建的库文件。这样我们就可以通过变量<code>adder</code>来使用C类库中的函数了。当<code>adder.add_int()</code>被调用时，内部将发起一个对C函数<code>add_int</code>的调用。ctypes接口允许我们在调用C函数时使用原生Python中默认的字符串型和整型。</p> <p>而对于其他类似布尔型和浮点型这样的类型，必须要使用正确的ctype类型才可以。如向<code>adder.add_float()</code>函数传参时, 我们要先将Python中的十进制值转化为c_float类型，然后才能传送给C函数。这种方法虽然简单，清晰，但是却很受限。例如，并不能在C中对对象进行操作。</p> <h3 id="swig"><a href="#swig" class="header-anchor">#</a> SWIG</h3> <p>SWIG是Simplified Wrapper and Interface Generator的缩写。是Python中调用C代码的另一种方法。在这个方法中，开发人员必须编写一个额外的接口文件来作为SWIG(终端工具)的入口。</p> <p>Python开发者一般不会采用这种方法，因为大多数情况它会带来不必要的复杂。而当你有一个C/C++代码库需要被多种语言调用时，这将是个非常不错的选择。</p> <p>示例如下(来自<a href="http://www.swig.org/tutorial.html" target="_self" rel="noopener noreferrer">SWIG官网</a>)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>```C
<span class="token comment">#include &lt;time.h&gt;</span>
double My_variable <span class="token operator">=</span> <span class="token number">3.0</span><span class="token punctuation">;</span>

<span class="token builtin">int</span> fact<span class="token punctuation">(</span><span class="token builtin">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> n<span class="token operator">*</span>fact<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token builtin">int</span> my_mod<span class="token punctuation">(</span><span class="token builtin">int</span> x<span class="token punctuation">,</span> <span class="token builtin">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">%</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

char <span class="token operator">*</span>get_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    time_t ltime<span class="token punctuation">;</span>
    time<span class="token punctuation">(</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctime<span class="token punctuation">(</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>编译它</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>unix <span class="token operator">%</span> swig <span class="token operator">-</span>python example<span class="token punctuation">.</span>i
unix <span class="token operator">%</span> gcc <span class="token operator">-</span>c example<span class="token punctuation">.</span>c example_wrap<span class="token punctuation">.</span>c \
    <span class="token operator">-</span>I<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>include<span class="token operator">/</span>python2<span class="token punctuation">.</span><span class="token number">1</span>
unix <span class="token operator">%</span> ld <span class="token operator">-</span>shared example<span class="token punctuation">.</span>o example_wrap<span class="token punctuation">.</span>o <span class="token operator">-</span>o _example<span class="token punctuation">.</span>so
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后，Python的输出</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> example
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> example<span class="token punctuation">.</span>fact<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token number">120</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> example<span class="token punctuation">.</span>my_mod<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> example<span class="token punctuation">.</span>get_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'Sun Feb 11 23:01:07 1996'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们可以看到，使用SWIG确实达到了同样的效果，虽然下了更多的工夫，但如果你的目标是多语言还是很值得的。</p> <h3 id="python-c-api"><a href="#python-c-api" class="header-anchor">#</a> Python/C API</h3> <p><a href="https://docs.python.org/2/c-api/" target="_self" rel="noopener noreferrer">Python/C API</a>可能是被最广泛使用的方法。它不仅简单，而且可以在C代码中操作你的Python对象。</p> <p>这种方法需要以特定的方式来编写C代码以供Python去调用它。所有的Python对象都被表示为一种叫做PyObject的结构体，并且<code>Python.h</code>头文件中提供了各种操作它的函数。例如，如果PyObject表示为PyListType(列表类型)时，那么我们便可以使用<code>PyList_Size()</code>函数来获取该结构的长度，类似Python中的<code>len(list)</code>函数。大部分对Python原生对象的基础函数和操作在<code>Python.h</code>头文件中都能找到。</p> <p>示例</p> <p>编写一个C扩展，添加所有元素到一个Python列表(所有元素都是数字)。来看一下我们要实现的效果，这里演示了用Python调用C扩展的代码</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#Though it looks like an ordinary python import, the addList module is implemented in C</span>
<span class="token keyword">import</span> addList

l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">&quot;Sum of List - &quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span>  <span class="token builtin">str</span><span class="token punctuation">(</span>addList<span class="token punctuation">.</span>add<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面的代码和普通的Python文件并没有什么分别，导入并使用了另一个叫做<code>addList</code>的Python模块。唯一差别就是这个模块并不是用Python编写的，而是C。</p> <p>接下来我们看看如何用C编写<code>addList</code>模块，这可能看起来有点让人难以接受，但是一旦你了解了这之中的各种组成，你就可以一往无前了。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span>Python<span class="token punctuation">.</span>h has <span class="token builtin">all</span> the required function definitions to manipulate the Python objects
<span class="token comment">#include &lt;Python.h&gt;</span>

<span class="token operator">//</span>This <span class="token keyword">is</span> the function that <span class="token keyword">is</span> called <span class="token keyword">from</span> your python code
static PyObject<span class="token operator">*</span> addList_add<span class="token punctuation">(</span>PyObject<span class="token operator">*</span> self<span class="token punctuation">,</span> PyObject<span class="token operator">*</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>

    PyObject <span class="token operator">*</span> listObj<span class="token punctuation">;</span>

    <span class="token operator">//</span>The <span class="token builtin">input</span> arguments come <span class="token keyword">as</span> a <span class="token builtin">tuple</span><span class="token punctuation">,</span> we parse the args to get the various variables
    <span class="token operator">//</span>In this case it's only one <span class="token builtin">list</span> variable<span class="token punctuation">,</span> which will now be referenced by listObj
    <span class="token keyword">if</span> <span class="token punctuation">(</span>! PyArg_ParseTuple<span class="token punctuation">(</span> args<span class="token punctuation">,</span> <span class="token string">&quot;O&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>listObj <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>

    <span class="token operator">//</span>length of the <span class="token builtin">list</span>
    <span class="token builtin">long</span> length <span class="token operator">=</span> PyList_Size<span class="token punctuation">(</span>listObj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">//</span>iterate over <span class="token builtin">all</span> the elements
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> <span class="token builtin">sum</span> <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">//</span>get an element out of the <span class="token builtin">list</span> <span class="token operator">-</span> the element <span class="token keyword">is</span> also a python objects
        PyObject<span class="token operator">*</span> temp <span class="token operator">=</span> PyList_GetItem<span class="token punctuation">(</span>listObj<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">//</span>we know that <span class="token builtin">object</span> represents an integer <span class="token operator">-</span> so convert it into C <span class="token builtin">long</span>
        <span class="token builtin">long</span> elem <span class="token operator">=</span> PyInt_AsLong<span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">sum</span> <span class="token operator">+=</span> elem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">//</span>value returned back to python code <span class="token operator">-</span> another python <span class="token builtin">object</span>
    <span class="token operator">//</span>build value here converts the C <span class="token builtin">long</span> to a python integer
    <span class="token keyword">return</span> Py_BuildValue<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token operator">//</span>This <span class="token keyword">is</span> the docstring that corresponds to our <span class="token string">'add'</span> function<span class="token punctuation">.</span>
static char addList_docs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token string">&quot;add(  ): add all elements of the list\n&quot;</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">*</span> This table contains the relavent info mapping <span class="token operator">-</span>
   <span class="token operator">&lt;</span>function<span class="token operator">-</span>name <span class="token keyword">in</span> python module<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>actual<span class="token operator">-</span>function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
   <span class="token operator">&lt;</span><span class="token builtin">type</span><span class="token operator">-</span>of<span class="token operator">-</span>args the function expects<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>docstring associated <span class="token keyword">with</span> the function<span class="token operator">&gt;</span>
 <span class="token operator">*</span><span class="token operator">/</span>
static PyMethodDef addList_funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyCFunction<span class="token punctuation">)</span>addList_add<span class="token punctuation">,</span> METH_VARARGS<span class="token punctuation">,</span> addList_docs<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>NULL<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NULL<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">*</span>
   addList <span class="token keyword">is</span> the module name<span class="token punctuation">,</span> <span class="token keyword">and</span> this <span class="token keyword">is</span> the initialization block of the module<span class="token punctuation">.</span>
   <span class="token operator">&lt;</span>desired module name<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>the<span class="token operator">-</span>info<span class="token operator">-</span>table<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>module's<span class="token operator">-</span>docstring<span class="token operator">&gt;</span>
 <span class="token operator">*</span><span class="token operator">/</span>
PyMODINIT_FUNC initaddList<span class="token punctuation">(</span>void<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Py_InitModule3<span class="token punctuation">(</span><span class="token string">&quot;addList&quot;</span><span class="token punctuation">,</span> addList_funcs<span class="token punctuation">,</span>
            <span class="token string">&quot;Add all ze lists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>逐步解释</p> <ul><li><code>Python.h</code>头文件中包含了所有需要的类型(Python对象类型的表示)和函数定义(对Python对象的操作)</li> <li>接下来我们编写将要在Python调用的函数, 函数传统的命名方式由{模块名}_{函数名}组成，所以我们将其命名为<code>addList_add</code></li> <li>然后填写想在模块内实现函数的相关信息表，每行一个函数，以空行作为结束</li> <li>最后的模块初始化块签名为<code>PyMODINIT_FUNC init{模块名}</code>。</li></ul> <p>函数<code>addList_add</code>接受的参数类型为PyObject类型结构(同时也表示为元组类型，因为Python中万物皆为对象，所以我们先用PyObject来定义)。传入的参数则通过<code>PyArg_ParseTuple()</code>来解析。第一个参数是被解析的参数变量。第二个参数是一个字符串，告诉我们如何去解析元组中每一个元素。字符串的第n个字母正是代表着元组中第n个参数的类型。例如，&quot;i&quot;代表整形，&quot;s&quot;代表字符串类型, &quot;O&quot;则代表一个Python对象。接下来的参数都是你想要通过<code>PyArg_ParseTuple()</code>函数解析并保存的元素。这样参数的数量和模块中函数期待得到的参数数量就可以保持一致，并保证了位置的完整性。例如，我们想传入一个字符串，一个整数和一个Python列表，可以这样去写</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">int</span> n<span class="token punctuation">;</span>
char <span class="token operator">*</span>s<span class="token punctuation">;</span>
PyObject<span class="token operator">*</span> <span class="token builtin">list</span><span class="token punctuation">;</span>
PyArg_ParseTuple<span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;siO&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在这种情况下，我们只需要提取一个列表对象，并将它存储在<code>listObj</code>变量中。然后用列表对象中的<code>PyList_Size()</code>函数来获取它的长度。就像Python中调用<code>len(list)</code>。</p> <p>现在我们通过循环列表，使用<code>PyList_GetItem(list, index)</code>函数来获取每个元素。这将返回一个<code>PyObject*</code>对象。既然Python对象也能表示<code>PyIntType</code>，我们只要使用<code>PyInt_AsLong(PyObj *)</code>函数便可获得我们所需要的值。我们对每个元素都这样处理，最后再得到它们的总和。</p> <p>总和将被转化为一个Python对象并通过<code>Py_BuildValue()</code>返回给Python代码，这里的i表示我们要返回一个Python整形对象。</p> <p>现在我们已经编写完C模块了。将下列代码保存为<code>setup.py</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#build the modules</span>

<span class="token keyword">from</span> distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup<span class="token punctuation">,</span> Extension

setup<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'addList'</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token string">'1.0'</span><span class="token punctuation">,</span>  \
      ext_modules<span class="token operator">=</span><span class="token punctuation">[</span>Extension<span class="token punctuation">(</span><span class="token string">'addList'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'adder.c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>并且运行</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python setup<span class="token punctuation">.</span>py install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在应该已经将我们的C文件编译安装到我们的Python模块中了。在一番辛苦后，让我们来验证下我们的模块是否有效</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#module that talks to the C code</span>
<span class="token keyword">import</span> addList

l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">&quot;Sum of List - &quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span>  <span class="token builtin">str</span><span class="token punctuation">(</span>addList<span class="token punctuation">.</span>add<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>输出结果如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>Sum of List <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如你所见，我们已经使用Python.h API成功开发出了我们第一个Python C扩展。这种方法看似复杂，但你一旦习惯，它将变的非常有效。</p> <p>Python调用C代码的另一种方式便是使用<a href="http://cython.org/" target="_self" rel="noopener noreferrer">Cython</a>让Python编译的更快。但是Cython和传统的Python比起来可以将它理解为另一种语言，所以我们就不在这里过多描述了。</p> <h2 id="open函数"><a href="#open函数" class="header-anchor">#</a> open函数</h2> <p><a href="http://docs.python.org/dev/library/functions.html#open" target="_self" rel="noopener noreferrer">open</a> 函数可以打开一个文件。超级简单吧？大多数时候，我们看到它这样被使用：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'photo.jpg'</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">)</span>
jpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我现在写这篇文章的原因，是大部分时间我看到<code>open</code>被这样使用。有<strong>三个</strong>错误存在于上面的代码中。你能把它们全指出来吗？如不能，请读下去。在这篇文章的结尾，你会知道上面的代码错在哪里，而且，更重要的是，你能在自己的代码里避免这些错误。现在我们从基础开始：<br><code>open</code>的返回值是一个文件句柄，从操作系统托付给你的Python程序。一旦你处理完文件，你会想要归还这个文件句柄，只有这样你的程序不会超出一次能打开的文件句柄的数量上限。<br>显式地调用<code>close</code>关闭了这个文件句柄，但前提是只有在read成功的情况下。如果有任意异常正好在<code>f = open(...)</code>之后产生，<code>f.close()</code>将不会被调用（取决于Python解释器的做法，文件句柄可能还是会被归还，但那是另外的话题了）。为了确保不管异常是否触发，文件都能关闭，我们将其包裹成一个<code>with</code>语句:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'photo.jpg'</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    jpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>open</code>的第一个参数是文件名。第二个(<code>mode</code> 打开模式)决定了这个文件如何被打开。</p> <ul><li>如果你想读取文件，传入<code>r</code></li> <li>如果你想读取并写入文件，传入<code>r+</code></li> <li>如果你想覆盖写入文件，传入<code>w</code></li> <li>如果你想在文件末尾附加内容，传入<code>a</code></li></ul> <p>虽然有若干个其他的有效的<code>mode</code>字符串，但有可能你将永远不会使用它们。<code>mode</code>很重要，不仅因为它改变了行为，而且它可能导致权限错误。举个例子，我们要是在一个写保护的目录里打开一个jpg文件， <code>open(.., 'r+')</code>就失败了。<code>mode</code>可能包含一个扩展字符；让我们还可以以二进制方式打开文件(你将得到字节串)或者文本模式(字符串)</p> <p>一般来说，如果文件格式是由人写的，那么它更可能是文本模式。jpg图像文件一般不是人写的（而且其实不是人直接可读的），因此你应该以二进制模式来打开它们，方法是在<code>mode</code>字符串后加一个<code>b</code>(你可以看看开头的例子里，正确的方式应该是<code>rb</code>)。 如果你以文本模式打开一些东西（比如，加一个<code>t</code>,或者就用<code>r/r+/w/a</code>），你还必须知道要使用哪种编码。对于计算机来说，所有的文件都是字节，而不是字符。</p> <p>可惜，在Pyhon 2.x版本里，<code>open</code>不支持显示地指定编码。然而，<a href="http://docs.python.org/2/library/io.html#io.open" target="_self" rel="noopener noreferrer">io.open</a>函数在Python 2.x中和3.x(其中它是<code>open</code>的别名)中都有提供，它能做正确的事。你可以传入<code>encoding</code>这个关键字参数来传入编码。 如果你不传入任意编码，一个系统 - 以及Python -指定的默认选项将被选中。你也许被诱惑去依赖这个默认选项，但这个默认选项经常是错误的，或者默认编码实际上不能表达文件里的所有字符（这将经常发生在Python 2.x和/或Windows）。 所以去挑选一个编码吧。<code>utf-8</code>是一个非常好的编码。当你写入一个文件，你可以选一个你喜欢的编码（或者最终读你文件的程序所喜欢的编码）。</p> <p>那你怎么找出正在读的文件是用哪种编码写的呢？好吧，不幸的是，并没有一个十分简单的方式来检测编码。在不同的编码中，同样的字节可以表示不同，但同样有效的字符。因此，你必须依赖一个元数据（比如，在HTTP头信息里）来找出编码。越来越多的是，文件格式将编码定义成<code>UTF-8</code>。</p> <p>有了这些基础知识，我们来写一个程序，读取一个文件，检测它是否是JPG（提示：这些文件头部以字节<code>FF D8</code>开始），把对输入文件的描述写入一个文本文件。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> io

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'photo.jpg'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> inf<span class="token punctuation">:</span>
    jpgdata <span class="token operator">=</span> inf<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> jpgdata<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'\xff\xd8'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> <span class="token string">u'This is a JPEG file (%d bytes long)\n'</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> <span class="token string">u'This is a random file (%d bytes long)\n'</span>

<span class="token keyword">with</span> io<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'summary.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> outf<span class="token punctuation">:</span>
    outf<span class="token punctuation">.</span>write<span class="token punctuation">(</span>text <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>jpgdata<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我敢肯定，现在你会正确地使用<code>open</code>啦！</p> <h2 id="目标python2-3"><a href="#目标python2-3" class="header-anchor">#</a> 目标Python2+3</h2> <p>很多时候你可能希望你开发的程序能够同时兼容Python2+和Python3+。</p> <p>试想你有一个非常出名的Python模块被很多开发者使用着，但并不是所有人都只使用Python2或者Python3。这时候你有两个办法。第一个办法是开发两个模块，针对Python2一个，针对Python3一个。还有一个办法就是调整你现在的代码使其同时兼容Python2和Python3。</p> <p>本节中，我将介绍一些技巧，让你的脚本同时兼容Python2和Python3。</p> <p><strong>Future模块导入</strong></p> <p>第一种也是最重要的方法，就是导入<code>__future__</code>模块。它可以帮你在Python2中导入Python3的功能。这有一组例子：上下文管理器是Python2.6+引入的新特性，如果你想在Python2.5中使用它可以这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> with_statement
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在Python3中<code>print</code>已经变为一个函数。如果你想在Python2中使用它可以通过<code>__future__</code>导入：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">print</span>
<span class="token comment"># Output:</span>

<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">print</span><span class="token punctuation">)</span>
<span class="token comment"># Output: &lt;built-in function print&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>模块重命名</strong></p> <p>首先，告诉我你是如何在你的脚本中导入模块的。大多时候我们会这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> foo 
<span class="token comment"># or</span>
<span class="token keyword">from</span> foo <span class="token keyword">import</span> bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你知道么，其实你也可以这样做：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> foo <span class="token keyword">as</span> foo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样做可以起到和上面代码同样的功能，但最重要的是它能让你的脚本同时兼容Python2和Python3。现在我们来看下面的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">as</span> urllib_request  <span class="token comment"># for Python 3</span>
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    <span class="token keyword">import</span> urllib2 <span class="token keyword">as</span> urllib_request  <span class="token comment"># for Python 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>让我来稍微解释一下上面的代码。 我们将模块导入代码包装在<code>try/except</code>语句中。我们是这样做是因为在Python 2中并没有<code>urllib.request</code>模块。这将引起一个<code>ImportError</code>异常。而在Python2中<code>urllib.request</code>的功能则是由<code>urllib2</code>提供的。所以,当我们试图在Python2中导入<code>urllib.request</code>模块的时候，一旦我们捕获到<code>ImportError</code>我们将通过导入<code>urllib2</code>模块来代替它。</p> <p>最后，你要了解<code>as</code>关键字的作用。它将导入的模块映射到<code>urllib.request</code>，所以我们通过<code>urllib_request</code>这个别名就可以使用<code>urllib2</code>中的所有类和方法了。</p> <p><strong>过期的Python2内置功能</strong></p> <p>另一个需要了解的事情就是Python2中有12个内置功能在Python3中已经被移除了。要确保在Python2代码中不要出现这些功能来保证对Python3的兼容。这有一个强制让你放弃12内置功能的方法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> future<span class="token punctuation">.</span>builtins<span class="token punctuation">.</span>disabled <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在，只要你尝试在Python3中使用这些被遗弃的模块时，就会抛出一个<code>NameError</code>异常如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> future<span class="token punctuation">.</span>builtins<span class="token punctuation">.</span>disabled <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Output: NameError: obsolete Python 2 builtin apply is disabled</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>标准库向下兼容的外部支持</strong></p> <p>有一些包在非官方的支持下为Python2提供了Python3的功能。例如，我们有：</p> <ul><li>enum <code>pip install enum34</code></li> <li>singledispatch <code>pip install singledispatch</code></li> <li>pathlib <code>pip install pathlib</code></li></ul> <p>想更多了解，在Python文档中有一个<a href="https://docs.python.org/3/howto/pyporting.html" target="_self" rel="noopener noreferrer">全面的指南</a>可以帮助你让你的代码同时兼容Python2和Python3。</p> <h2 id="协程"><a href="#协程" class="header-anchor">#</a> 协程</h2> <p>Python中的协程和生成器很相似但又稍有不同。主要区别在于：</p> <ul><li>生成器是数据的生产者</li> <li>协程则是数据的消费者</li></ul> <p>首先我们先来回顾下生成器的创建过程。我们可以这样去创建一个生成器:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">yield</span> a
            a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后我们经常在<code>for</code>循环中这样使用它:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">for</span> i <span class="token keyword">in</span> fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> i
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这样做不仅快而且不会给内存带来压力，因为我们所需要的值都是动态生成的而不是将他们存储在一个列表中。更概括的说如果现在我们在上面的例子中使用<code>yield</code>便可获得了一个协程。协程会消费掉发送给它的值。Python实现的<code>grep</code>就是个很好的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">grep</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Searching for&quot;</span><span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            line <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pattern <span class="token keyword">in</span> line<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>等等！<code>yield</code>返回了什么？啊哈，我们已经把它变成了一个协程。它将不再包含任何初始值，相反要从外部传值给它。我们可以通过<code>send()</code>方法向它传值。这有个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    search <span class="token operator">=</span> grep<span class="token punctuation">(</span><span class="token string">'coroutine'</span><span class="token punctuation">)</span>
    <span class="token builtin">next</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span>
    <span class="token comment">#output: Searching for coroutine</span>
    search<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;I love you&quot;</span><span class="token punctuation">)</span>
    search<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;Don't you love me?&quot;</span><span class="token punctuation">)</span>
    search<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;I love coroutine instead!&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">#output: I love coroutine instead!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>发送的值会被<code>yield</code>接收。我们为什么要运行<code>next()</code>方法呢？这样做正是为了启动一个协程。就像协程中包含的生成器并不是立刻执行，而是通过<code>next()</code>方法来响应<code>send()</code>方法。因此，你必须通过<code>next()</code>方法来执行<code>yield</code>表达式。</p> <p>我们可以通过调用<code>close()</code>方法来关闭一个协程。像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    search <span class="token operator">=</span> grep<span class="token punctuation">(</span><span class="token string">'coroutine'</span><span class="token punctuation">)</span>
    search<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="函数缓存"><a href="#函数缓存" class="header-anchor">#</a> 函数缓存</h2> <p>函数缓存允许我们将一个函数对于给定参数的返回值缓存起来。 当一个I/O密集的函数被频繁使用相同的参数调用的时候，函数缓存可以节约时间。 在Python 3.2版本以前我们只有写一个自定义的实现。在Python 3.2以后版本，有个<code>lru_cache</code>的装饰器，允许我们将一个函数的返回值快速地缓存或取消缓存。</p> <p>我们来看看，Python 3.2前后的版本分别如何使用它。</p> <h3 id="python-3-2"><a href="#python-3-2" class="header-anchor">#</a> Python 3.2+</h3> <p>我们来实现一个斐波那契计算器，并使用<code>lru_cache</code>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> lru_cache

@lru_cache<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> n
    <span class="token keyword">return</span> fib<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> fib<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fib<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># Output: [0, 1, 1, 2, 3, 5, 8, 13, 21, 34]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>那个<code>maxsize</code>参数是告诉<code>lru_cache</code>，最多缓存最近多少个返回值。</p> <p>我们也可以轻松地对返回值清空缓存，通过这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>fib<span class="token punctuation">.</span>cache_clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="python-2"><a href="#python-2" class="header-anchor">#</a> Python 2+</h3> <p>你可以创建任意种类的缓存机制，有若干种方式来达到相同的效果，这完全取决于你的需要。 这里是一个一般的缓存：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">def</span> <span class="token function">memoize</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">:</span>
    memo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    @wraps<span class="token punctuation">(</span>function<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> args <span class="token keyword">in</span> memo<span class="token punctuation">:</span>
            <span class="token keyword">return</span> memo<span class="token punctuation">[</span>args<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> function<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
            memo<span class="token punctuation">[</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> rv
            <span class="token keyword">return</span> rv
    <span class="token keyword">return</span> wrapper

@memoize
<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">return</span> n
    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>

fibonacci<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这里有一篇<a href="https://www.caktusgroup.com/blog/2015/06/08/testing-client-side-applications-django-post-mortem/" target="_self" rel="noopener noreferrer">Caktus Group的不错的文章</a>，在其中他们发现一个Django框架的由lru_cache导致的bug。读起来很有意思。一定要打开去看一下。</p> <h2 id="上下文管理器"><a href="#上下文管理器" class="header-anchor">#</a> 上下文管理器</h2> <p>上下文管理器允许你在有需要的时候，精确地分配和释放资源。</p> <p>使用上下文管理器最广泛的案例就是<code>with</code>语句了。 想象下你有两个需要结对执行的相关操作，然后还要在它们中间放置一段代码。 上下文管理器就是专门让你做这种事情的。举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'some_file'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'Hola!'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面这段代码打开了一个文件，往里面写入了一些数据，然后关闭该文件。如果在往文件写数据时发生异常，它也会尝试去关闭文件。上面那段代码与这一段是等价的：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'some_file'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'Hola!'</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当与第一个例子对比时，我们可以看到，通过使用<code>with</code>，许多样板代码(boilerplate code)被消掉了。 这就是<code>with</code>语句的主要优势，它确保我们的文件会被关闭，而不用关注嵌套代码如何退出。</p> <p>上下文管理器的一个常见用例，是资源的加锁和解锁，以及关闭已打开的文件（就像我已经展示给你看的）。让我们看看如何来实现我们自己的上下文管理器。这会让我们更完全地理解在这些场景背后都发生着什么。</p> <h3 id="基于类的实现"><a href="#基于类的实现" class="header-anchor">#</a> 基于类的实现</h3> <p>一个上下文管理器的类，最起码要定义<code>__enter__</code>和<code>__exit__</code>方法。 让我们来构造我们自己的开启文件的上下文管理器，并学习下基础知识。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过定义<code>__enter__</code>和<code>__exit__</code>方法，我们可以在<code>with</code>语句里使用它。我们来试试：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">'demo.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'Hola!'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们的<code>__exit__</code>函数接受三个参数。这些参数对于每个上下文管理器类中的<code>__exit__</code>方法都是必须的。我们来谈谈在底层都发生了什么。</p> <ol><li><code>with</code>语句先暂存了<code>File</code>类的<code>__exit__</code>方法</li> <li>然后它调用<code>File</code>类的<code>__enter__</code>方法</li> <li><code>__enter__</code>方法打开文件并返回给<code>with</code>语句</li> <li>打开的文件句柄被传递给<code>opened_file</code>参数</li> <li>我们使用<code>.write()</code>来写文件</li> <li><code>with</code>语句调用之前暂存的<code>__exit__</code>方法</li> <li><code>__exit__</code>方法关闭了文件</li></ol> <h3 id="处理异常"><a href="#处理异常" class="header-anchor">#</a> 处理异常</h3> <p>我们还没有谈到<code>__exit__</code>方法的这三个参数：<code>type</code>, <code>value</code>和<code>traceback</code>。 在第4步和第6步之间，如果发生异常，Python会将异常的<code>type</code>,<code>value</code>和<code>traceback</code>传递给<code>__exit__</code>方法。 它让<code>__exit__</code>方法来决定如何关闭文件以及是否需要其他步骤。在我们的案例中，我们并没有注意它们。</p> <p>那如果我们的文件对象抛出一个异常呢？万一我们尝试访问文件对象的一个不支持的方法。举个例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">'demo.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
    opened_file<span class="token punctuation">.</span>undefined_function<span class="token punctuation">(</span><span class="token string">'Hola!'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们来列一下，当异常发生时，<code>with</code>语句会采取哪些步骤。 1. 它把异常的<code>type</code>,<code>value</code>和<code>traceback</code>传递给<code>__exit__</code>方法 2. 它让<code>__exit__</code>方法来处理异常 3. 如果<code>__exit__</code>返回的是True，那么这个异常就被优雅地处理了。 4. 如果<code>__exit__</code>返回的是True以外的任何东西，那么这个异常将被<code>with</code>语句抛出。</p> <p>在我们的案例中，<code>__exit__</code>方法返回的是<code>None</code>(如果没有<code>return</code>语句那么方法会返回<code>None</code>)。因此，<code>with</code>语句抛出了那个异常。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">&quot;&lt;stdin&gt;&quot;</span><span class="token punctuation">,</span> line <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'file'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'undefined_function'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们尝试下在<code>__exit__</code>方法中处理异常：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Exception has been handled&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">'demo.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
    opened_file<span class="token punctuation">.</span>undefined_function<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Output: Exception has been handled</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们的<code>__exit__</code>方法返回了<code>True</code>,因此没有异常会被<code>with</code>语句抛出。</p> <p>这还不是实现上下文管理器的唯一方式。还有一种方式，我们会在下一节中一起看看。</p> <h3 id="基于生成器的实现"><a href="#基于生成器的实现" class="header-anchor">#</a> 基于生成器的实现</h3> <p>我们还可以用装饰器(decorators)和生成器(generators)来实现上下文管理器。 Python有个<code>contextlib</code>模块专门用于这个目的。我们可以使用一个生成器函数来实现一个上下文管理器，而不是使用一个类。 让我们看看一个基本的，没用的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager

@contextmanager
<span class="token keyword">def</span> <span class="token function">open_file</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> f
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>OK啦！这个实现方式看起来更加直观和简单。然而，这个方法需要关于生成器、<code>yield</code>和装饰器的一些知识。在这个例子中我们还没有捕捉可能产生的任何异常。它的工作方式和之前的方法大致相同。</p> <p>让我们小小地剖析下这个方法。 1. Python解释器遇到了<code>yield</code>关键字。因为这个缘故它创建了一个生成器而不是一个普通的函数。 2. 因为这个装饰器，<code>contextmanager</code>会被调用并传入函数名（<code>open_file</code>）作为参数。 3. <code>contextmanager</code>函数返回一个以<code>GeneratorContextManager</code>对象封装过的生成器。 4. 这个<code>GeneratorContextManager</code>被赋值给<code>open_file</code>函数，我们实际上是在调用<code>GeneratorContextManager</code>对象。</p> <p>那现在我们既然知道了所有这些，我们可以用这个新生成的上下文管理器了，像这样：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> open_file<span class="token punctuation">(</span><span class="token string">'some_file'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'hola!'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/DevLanguage/Python/PythonBasic.html" class="prev">Python 基础</a></span> <span class="next"><a href="/DevLanguage/Python/Spider/">Python 爬虫概述</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2ba1140b.js" defer></script><script src="/assets/js/2.858e58ff.js" defer></script><script src="/assets/js/152.b64ef399.js" defer></script>
  </body>
</html>
