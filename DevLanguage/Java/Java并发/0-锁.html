<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0 - 各种锁及Java实现 | Yan&#39;s Blog Home</title>
    <meta name="description" content="Personal blog site">
    
    
    <link rel="preload" href="/assets/css/0.styles.659f981c.css" as="style"><link rel="preload" href="/assets/js/app.2ba1140b.js" as="script"><link rel="preload" href="/assets/js/2.858e58ff.js" as="script"><link rel="preload" href="/assets/js/65.11535a8c.js" as="script"><link rel="prefetch" href="/assets/js/10.5dcc1f52.js"><link rel="prefetch" href="/assets/js/100.0327e00b.js"><link rel="prefetch" href="/assets/js/101.404f187c.js"><link rel="prefetch" href="/assets/js/102.d78878ec.js"><link rel="prefetch" href="/assets/js/103.a682f6f1.js"><link rel="prefetch" href="/assets/js/104.d831bcb5.js"><link rel="prefetch" href="/assets/js/105.afbf1884.js"><link rel="prefetch" href="/assets/js/106.8e9709d3.js"><link rel="prefetch" href="/assets/js/107.9712aa22.js"><link rel="prefetch" href="/assets/js/108.4158fdb6.js"><link rel="prefetch" href="/assets/js/109.ae61a303.js"><link rel="prefetch" href="/assets/js/11.34e3d90e.js"><link rel="prefetch" href="/assets/js/110.0abce6c9.js"><link rel="prefetch" href="/assets/js/111.b5c958e5.js"><link rel="prefetch" href="/assets/js/112.fdacfaf6.js"><link rel="prefetch" href="/assets/js/113.9d95243d.js"><link rel="prefetch" href="/assets/js/114.f759f9b9.js"><link rel="prefetch" href="/assets/js/115.1b1f9f3d.js"><link rel="prefetch" href="/assets/js/116.1e5e62e4.js"><link rel="prefetch" href="/assets/js/117.952db9d4.js"><link rel="prefetch" href="/assets/js/118.ed9df468.js"><link rel="prefetch" href="/assets/js/119.f19ee9e0.js"><link rel="prefetch" href="/assets/js/12.cd237cda.js"><link rel="prefetch" href="/assets/js/120.24dbecef.js"><link rel="prefetch" href="/assets/js/121.0aa2d47c.js"><link rel="prefetch" href="/assets/js/122.5205ca42.js"><link rel="prefetch" href="/assets/js/123.25aa20a6.js"><link rel="prefetch" href="/assets/js/124.420b2a92.js"><link rel="prefetch" href="/assets/js/125.091331f4.js"><link rel="prefetch" href="/assets/js/126.471b335f.js"><link rel="prefetch" href="/assets/js/127.60ffdb36.js"><link rel="prefetch" href="/assets/js/128.9c5c36ef.js"><link rel="prefetch" href="/assets/js/129.36fd802b.js"><link rel="prefetch" href="/assets/js/13.de2ffe9f.js"><link rel="prefetch" href="/assets/js/130.822de8a4.js"><link rel="prefetch" href="/assets/js/131.697750e2.js"><link rel="prefetch" href="/assets/js/132.fd5faa78.js"><link rel="prefetch" href="/assets/js/133.cf327ef4.js"><link rel="prefetch" href="/assets/js/134.6cdb8690.js"><link rel="prefetch" href="/assets/js/135.906c8800.js"><link rel="prefetch" href="/assets/js/136.43585d13.js"><link rel="prefetch" href="/assets/js/137.3c7ddb41.js"><link rel="prefetch" href="/assets/js/138.e3274ead.js"><link rel="prefetch" href="/assets/js/139.7fa38b58.js"><link rel="prefetch" href="/assets/js/14.9d6406e7.js"><link rel="prefetch" href="/assets/js/140.1b026dad.js"><link rel="prefetch" href="/assets/js/141.c1adfec5.js"><link rel="prefetch" href="/assets/js/142.ed2a4a22.js"><link rel="prefetch" href="/assets/js/143.af96e2f9.js"><link rel="prefetch" href="/assets/js/144.923a7d38.js"><link rel="prefetch" href="/assets/js/145.d88163de.js"><link rel="prefetch" href="/assets/js/146.2134dd3e.js"><link rel="prefetch" href="/assets/js/147.9925c468.js"><link rel="prefetch" href="/assets/js/148.109297cc.js"><link rel="prefetch" href="/assets/js/149.ae529d47.js"><link rel="prefetch" href="/assets/js/15.fe3428fa.js"><link rel="prefetch" href="/assets/js/150.6bf9657f.js"><link rel="prefetch" href="/assets/js/151.603cf1f9.js"><link rel="prefetch" href="/assets/js/152.b64ef399.js"><link rel="prefetch" href="/assets/js/153.fd5cde7c.js"><link rel="prefetch" href="/assets/js/154.8cedd5d3.js"><link rel="prefetch" href="/assets/js/155.042308eb.js"><link rel="prefetch" href="/assets/js/156.1f58dd5a.js"><link rel="prefetch" href="/assets/js/157.69e07481.js"><link rel="prefetch" href="/assets/js/158.40b656df.js"><link rel="prefetch" href="/assets/js/159.823c56a4.js"><link rel="prefetch" href="/assets/js/16.7976352c.js"><link rel="prefetch" href="/assets/js/160.93aba24e.js"><link rel="prefetch" href="/assets/js/161.3ae7729a.js"><link rel="prefetch" href="/assets/js/162.8092cc22.js"><link rel="prefetch" href="/assets/js/163.3c82e51b.js"><link rel="prefetch" href="/assets/js/164.d358ee7b.js"><link rel="prefetch" href="/assets/js/165.60d778eb.js"><link rel="prefetch" href="/assets/js/166.54d7340a.js"><link rel="prefetch" href="/assets/js/167.5fd6aaa3.js"><link rel="prefetch" href="/assets/js/168.205929f8.js"><link rel="prefetch" href="/assets/js/169.873b90b1.js"><link rel="prefetch" href="/assets/js/17.72e8ffa6.js"><link rel="prefetch" href="/assets/js/170.68c49359.js"><link rel="prefetch" href="/assets/js/171.d8f93304.js"><link rel="prefetch" href="/assets/js/172.6b496cc7.js"><link rel="prefetch" href="/assets/js/173.f276a0ce.js"><link rel="prefetch" href="/assets/js/174.09cb41e2.js"><link rel="prefetch" href="/assets/js/175.c77ce8d9.js"><link rel="prefetch" href="/assets/js/176.01ab9f3f.js"><link rel="prefetch" href="/assets/js/177.2f91a2a4.js"><link rel="prefetch" href="/assets/js/178.5f0a0527.js"><link rel="prefetch" href="/assets/js/179.0d14e948.js"><link rel="prefetch" href="/assets/js/18.8264b169.js"><link rel="prefetch" href="/assets/js/180.9a15f295.js"><link rel="prefetch" href="/assets/js/181.d5bcbada.js"><link rel="prefetch" href="/assets/js/182.571b87a8.js"><link rel="prefetch" href="/assets/js/183.b87f5a38.js"><link rel="prefetch" href="/assets/js/184.90ecbd35.js"><link rel="prefetch" href="/assets/js/185.3a38f733.js"><link rel="prefetch" href="/assets/js/186.881a0fab.js"><link rel="prefetch" href="/assets/js/187.17663dea.js"><link rel="prefetch" href="/assets/js/188.471fcd9b.js"><link rel="prefetch" href="/assets/js/189.6d486653.js"><link rel="prefetch" href="/assets/js/19.e6227b20.js"><link rel="prefetch" href="/assets/js/190.357b4cc8.js"><link rel="prefetch" href="/assets/js/191.ccf9ae83.js"><link rel="prefetch" href="/assets/js/192.3ee45cf5.js"><link rel="prefetch" href="/assets/js/193.2fbcbc68.js"><link rel="prefetch" href="/assets/js/194.61d0acd9.js"><link rel="prefetch" href="/assets/js/195.33b772c3.js"><link rel="prefetch" href="/assets/js/196.7d35848a.js"><link rel="prefetch" href="/assets/js/197.4b958d27.js"><link rel="prefetch" href="/assets/js/198.dfbfba98.js"><link rel="prefetch" href="/assets/js/199.f6c7aacb.js"><link rel="prefetch" href="/assets/js/20.65ad9b00.js"><link rel="prefetch" href="/assets/js/200.6a05302e.js"><link rel="prefetch" href="/assets/js/201.be446c97.js"><link rel="prefetch" href="/assets/js/202.d058ca1d.js"><link rel="prefetch" href="/assets/js/203.ef2b609c.js"><link rel="prefetch" href="/assets/js/204.dab38ee5.js"><link rel="prefetch" href="/assets/js/21.300f7dfb.js"><link rel="prefetch" href="/assets/js/22.0ed457bc.js"><link rel="prefetch" href="/assets/js/23.9cf0f43d.js"><link rel="prefetch" href="/assets/js/24.f151ffcb.js"><link rel="prefetch" href="/assets/js/25.680a763b.js"><link rel="prefetch" href="/assets/js/26.6a5f804d.js"><link rel="prefetch" href="/assets/js/27.98408441.js"><link rel="prefetch" href="/assets/js/28.acbefbd1.js"><link rel="prefetch" href="/assets/js/29.fbd2340a.js"><link rel="prefetch" href="/assets/js/3.753236a7.js"><link rel="prefetch" href="/assets/js/30.30b44255.js"><link rel="prefetch" href="/assets/js/31.510d262b.js"><link rel="prefetch" href="/assets/js/32.c204bc79.js"><link rel="prefetch" href="/assets/js/33.5fa66039.js"><link rel="prefetch" href="/assets/js/34.6db47b26.js"><link rel="prefetch" href="/assets/js/35.fcb88dd5.js"><link rel="prefetch" href="/assets/js/36.e294e99d.js"><link rel="prefetch" href="/assets/js/37.fe541556.js"><link rel="prefetch" href="/assets/js/38.94af8189.js"><link rel="prefetch" href="/assets/js/39.e7017f9b.js"><link rel="prefetch" href="/assets/js/4.1c3159e6.js"><link rel="prefetch" href="/assets/js/40.b7a1deeb.js"><link rel="prefetch" href="/assets/js/41.ae4d7d1e.js"><link rel="prefetch" href="/assets/js/42.5dc5c7f6.js"><link rel="prefetch" href="/assets/js/43.73610732.js"><link rel="prefetch" href="/assets/js/44.2b0e19f3.js"><link rel="prefetch" href="/assets/js/45.903efdc0.js"><link rel="prefetch" href="/assets/js/46.0684656f.js"><link rel="prefetch" href="/assets/js/47.6425b35e.js"><link rel="prefetch" href="/assets/js/48.43663ba9.js"><link rel="prefetch" href="/assets/js/49.34841bc0.js"><link rel="prefetch" href="/assets/js/5.d3774f5f.js"><link rel="prefetch" href="/assets/js/50.48ce1d7e.js"><link rel="prefetch" href="/assets/js/51.1820aa29.js"><link rel="prefetch" href="/assets/js/52.5317c537.js"><link rel="prefetch" href="/assets/js/53.71b86df9.js"><link rel="prefetch" href="/assets/js/54.31ed2a5e.js"><link rel="prefetch" href="/assets/js/55.4f9933ab.js"><link rel="prefetch" href="/assets/js/56.beb74e07.js"><link rel="prefetch" href="/assets/js/57.705bc19e.js"><link rel="prefetch" href="/assets/js/58.f5fd656b.js"><link rel="prefetch" href="/assets/js/59.cc8ae217.js"><link rel="prefetch" href="/assets/js/6.f082ca37.js"><link rel="prefetch" href="/assets/js/60.fc3cf484.js"><link rel="prefetch" href="/assets/js/61.b5032b43.js"><link rel="prefetch" href="/assets/js/62.64d7637a.js"><link rel="prefetch" href="/assets/js/63.2a71075b.js"><link rel="prefetch" href="/assets/js/64.21eb4820.js"><link rel="prefetch" href="/assets/js/66.d9c62638.js"><link rel="prefetch" href="/assets/js/67.5782c958.js"><link rel="prefetch" href="/assets/js/68.35886dae.js"><link rel="prefetch" href="/assets/js/69.934aa057.js"><link rel="prefetch" href="/assets/js/7.9a79fd87.js"><link rel="prefetch" href="/assets/js/70.53c7c7a2.js"><link rel="prefetch" href="/assets/js/71.0e82b1c6.js"><link rel="prefetch" href="/assets/js/72.1da0eaf9.js"><link rel="prefetch" href="/assets/js/73.3dabc9cd.js"><link rel="prefetch" href="/assets/js/74.b2ae43f6.js"><link rel="prefetch" href="/assets/js/75.55bf2044.js"><link rel="prefetch" href="/assets/js/76.2f88e50b.js"><link rel="prefetch" href="/assets/js/77.d916e87e.js"><link rel="prefetch" href="/assets/js/78.0e80a77d.js"><link rel="prefetch" href="/assets/js/79.03bce65e.js"><link rel="prefetch" href="/assets/js/8.60d5a8a9.js"><link rel="prefetch" href="/assets/js/80.96678f59.js"><link rel="prefetch" href="/assets/js/81.75ffa4d3.js"><link rel="prefetch" href="/assets/js/82.41c1aeb7.js"><link rel="prefetch" href="/assets/js/83.16d5e455.js"><link rel="prefetch" href="/assets/js/84.195ca01f.js"><link rel="prefetch" href="/assets/js/85.d850d4dd.js"><link rel="prefetch" href="/assets/js/86.32d87d56.js"><link rel="prefetch" href="/assets/js/87.5f97a4f6.js"><link rel="prefetch" href="/assets/js/88.f5b0bbdb.js"><link rel="prefetch" href="/assets/js/89.9f9150f5.js"><link rel="prefetch" href="/assets/js/9.74db15a0.js"><link rel="prefetch" href="/assets/js/90.f69286ce.js"><link rel="prefetch" href="/assets/js/91.c9995055.js"><link rel="prefetch" href="/assets/js/92.e992da4f.js"><link rel="prefetch" href="/assets/js/93.14137340.js"><link rel="prefetch" href="/assets/js/94.c8228a63.js"><link rel="prefetch" href="/assets/js/95.bbb7ce03.js"><link rel="prefetch" href="/assets/js/96.ce87793d.js"><link rel="prefetch" href="/assets/js/97.4fdd8a0b.js"><link rel="prefetch" href="/assets/js/98.74cfc635.js"><link rel="prefetch" href="/assets/js/99.abdd1b46.js">
    <link rel="stylesheet" href="/assets/css/0.styles.659f981c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yan's Blog Home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java Basic</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java NIO</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 并发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DevLanguage/Java/Java%E5%B9%B6%E5%8F%91/" class="sidebar-link">Java并发</a></li><li><a href="/DevLanguage/Java/Java并发/0-多线程相关.html" class="sidebar-link">0 - 多线程相关概念</a></li><li><a href="/DevLanguage/Java/Java并发/0-什么是线程安全.html" class="sidebar-link">0 - 什么是线程安全</a></li><li><a href="/DevLanguage/Java/Java并发/0-并发相关.html" class="sidebar-link">0 - 并发相关概念</a></li><li><a href="/DevLanguage/Java/Java并发/0-JMM.html" class="sidebar-link">0 - JMM(Java内存模型)概念</a></li><li><a href="/DevLanguage/Java/Java并发/0-锁.html" class="active sidebar-link">0 - 各种锁及Java实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#synchronized与lock" class="sidebar-link">synchronized与Lock</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#悲观锁与乐观锁" class="sidebar-link">悲观锁与乐观锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#乐观锁的基础——cas" class="sidebar-link">乐观锁的基础——CAS</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#自旋锁" class="sidebar-link">自旋锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#synchronized锁升级：偏向锁-→-轻量级锁-→-重量级锁" class="sidebar-link">synchronized锁升级：偏向锁 → 轻量级锁 → 重量级锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#可重入锁（递归锁）" class="sidebar-link">可重入锁（递归锁）</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#公平锁、非公平锁" class="sidebar-link">公平锁、非公平锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#可中断锁" class="sidebar-link">可中断锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#读写锁、共享锁、互斥锁" class="sidebar-link">读写锁、共享锁、互斥锁</a></li><li class="sidebar-sub-header"><a href="/DevLanguage/Java/Java并发/0-锁.html#回到悲观锁和乐观锁" class="sidebar-link">回到悲观锁和乐观锁</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 常用框架</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/index/" class="sidebar-link">&lt; 首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_0-各种锁及java实现"><a href="#_0-各种锁及java实现" class="header-anchor">#</a> 0 - 各种锁及Java实现</h1> <div class="custom-block tip"><p class="custom-block-title">转</p> <p><font color="orange"><strong>理解文章1</strong>（<em>仅供参考，待深入理解</em>）</font></p> <ul><li><a href="https://zhuanlan.zhihu.com/p/71156910" target="_self" rel="noopener noreferrer">通俗易懂 悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量/重量级锁、读写锁、各种锁及其Java实现！</a></li></ul></div> <p>网上关于Java中锁的话题可以说资料相当丰富，但相关内容总感觉是一大串术语的罗列，让人云里雾里，读完就忘。本文希望能为Java新人做一篇通俗易懂的整合，旨在消除对各种各样锁的术语的恐惧感，对每种锁的底层实现浅尝辄止，但是在需要时能够知道去查什么。</p> <p>首先要打消一种想法，就是一个锁只能属于一种分类。其实并不是这样，比如一个锁可以同时是悲观锁、可重入锁、公平锁、可中断锁等等，就像一个人可以是男人、医生、健身爱好者、游戏玩家，这并不矛盾。OK，国际惯例，上干货。</p> <h2 id="synchronized与lock"><a href="#synchronized与lock" class="header-anchor">#</a> synchronized与Lock</h2> <p>Java中有两种加锁的方式：一种是用<strong>synchronized关键字</strong>，另一种是用<strong>Lock接口</strong>的实现类。</p> <p>形象地说，synchronized关键字是<strong>自动档</strong>，可以满足一切日常驾驶需求。但是如果你想要玩漂移或者各种骚操作，就需要<strong>手动档</strong>了——各种Lock的实现类。</p> <p>所以如果你只是想要简单的加个锁，对性能也没什么特别的要求，用synchronized关键字就足够了。自Java 5之后，才在java.util.concurrent.locks包下有了另外一种方式来实现锁，那就是Lock。也就是说**，synchronized是Java语言内置的关键字，而Lock是一个接口**，这个接口的实现类在代码层面实现了锁的功能，具体细节不在本文展开，有兴趣可以研究下AbstractQueuedSynchronizer类，写得可以说是牛逼爆了。</p> <div style="display:flex;"><img src="data:image/png;base64,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" alt="" align="left" style="display:block;"></div> <blockquote><p>其实只需要关注三个类就可以了：ReentrantLock类、ReadLock类、WriteLock类。</p></blockquote> <p><strong>ReentrantLock、ReadLock、WriteLock</strong> 是Lock接口最重要的三个实现类。对应了“可重入锁”、“读锁”和“写锁”，后面会讲它们的用途。</p> <p>ReadWriteLock其实是一个工厂接口，而ReentrantReadWriteLock是ReadWriteLock的实现类，它包含两个静态内部类ReadLock和WriteLock。这两个静态内部类又分别实现了Lock接口。</p> <p>我们停止深究源码，仅从使用的角度看，Lock与synchronized的区别是什么？在接下来的几个小节中，我将梳理各种锁分类的概念，以及synchronized关键字、各种Lock实现类之间的区别与联系。</p> <h2 id="悲观锁与乐观锁"><a href="#悲观锁与乐观锁" class="header-anchor">#</a> 悲观锁与乐观锁</h2> <p>锁的一种宏观分类方式是<strong>悲观锁</strong>和<strong>乐观锁</strong>。悲观锁与乐观锁<strong>并不是特指某个锁</strong>（Java中没有哪个Lock实现类就叫PessimisticLock或OptimisticLock），而是在并发情况下的两种不同策略。</p> <p>悲观锁（Pessimistic Lock）, 就是很悲观，每次去拿数据的时候都认为别人会修改。所以每次在拿数据的时候都会上锁。这样别人想拿数据就被挡住，直到悲观锁被释放。</p> <p>乐观锁（Optimistic Lock）, 就是很乐观，每次去拿数据的时候都认为别人不会修改。所以<strong>不会上锁，不会上锁！<strong>但是如果想要更新数据，则会在</strong>更新前检查在读取至更新这段时间别人有没有修改过这个数据</strong>。如果修改过，则重新读取，再次尝试更新，循环上述步骤直到更新成功（当然也允许更新失败的线程放弃操作）。</p> <p><strong>悲观锁阻塞事务，乐观锁回滚重试</strong>，它们各有优缺点，不要认为一种一定好于另一种。像乐观锁适用于写比较少的情况下，即冲突真的很少发生的时候，这样可以省去锁的开销，加大了系统的整个吞吐量。但如果经常产生冲突，上层应用会不断的进行重试，这样反倒是降低了性能，所以这种情况下用悲观锁就比较合适。</p> <h2 id="乐观锁的基础——cas"><a href="#乐观锁的基础——cas" class="header-anchor">#</a> 乐观锁的基础——CAS</h2> <p>说到乐观锁，就必须提到一个概念：<strong>CAS</strong></p> <p>什么是CAS呢？Compare-and-Swap，即<strong>比较并替换</strong>，也有叫做Compare-and-Set的**，比较并设置**。</p> <ol><li>比较：读取到了一个值A，在将其更新为B之前，检查原值是否仍为A（未被其他线程改动）。</li> <li>设置：如果是，将A更新为B，结束。[<a href="https://zhuanlan.zhihu.com/p/71156910#ref_1" target="_self" rel="noopener noreferrer">1]</a>如果不是，则什么都不做。</li></ol> <p>上面的两步操作是原子性的，可以简单地理解为瞬间完成，在CPU看来就是一步操作。</p> <p>有了CAS，就可以实现一个<strong>乐观锁</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>data <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">// 共享数据</span>

<span class="token comment">/* 更新数据的线程会进行如下操作 */</span>
flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldValue <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token comment">// 保存原始数据</span>
    newValue <span class="token operator">=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">// 下面的部分为CAS操作，尝试更新data的值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 比较</span>
        data <span class="token operator">=</span> newValue<span class="token punctuation">;</span> <span class="token comment">// 设置</span>
        flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 结束</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">// 啥也不干，循环重试</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 
   很明显，这样的代码根本不是原子性的，
   因为真正的CAS利用了CPU指令，
   这里只是为了展示执行流程，本意是一样的。
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这是一个简单直观的乐观锁实现，它允许多个线程同时读取（因为根本没有加锁操作），但是只有一个线程可以成功更新数据，并导致其他要更新数据的线程回滚重试。 CAS利用CPU指令，从硬件层面保证了操作的原子性，以达到类似于锁的效果。</p> <div style="display:flex;"><img src="/assets/img/lock-02.7e0e1b0d.jpg" alt="" align="left" style="display:block;"></div> <blockquote><p>Java中真正的CAS操作调用的native方法</p></blockquote> <p>因为整个过程中并没有“加锁”和“解锁”操作，因此乐观锁策略也被称为<strong>无锁编程</strong>。换句话说，乐观锁其实不是“锁”，它仅仅是一个循环重试CAS的算法而已！</p> <h2 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h2> <p>有一种锁叫<strong>自旋锁</strong>。所谓自旋，说白了就是一个 while(true) 无限循环。<br>刚刚的乐观锁就有类似的无限循环操作，那么它是自旋锁吗？<br>不是。尽管自旋与 while(true) 的操作是一样的，但还是应该将这两个术语分开。“自旋”这两个字，特指自旋锁的自旋。<br>然而在JDK中并没有自旋锁（SpinLock）这个类，那什么才是自旋锁呢？读完下个小节就知道了。</p> <h2 id="synchronized锁升级：偏向锁-→-轻量级锁-→-重量级锁"><a href="#synchronized锁升级：偏向锁-→-轻量级锁-→-重量级锁" class="header-anchor">#</a> synchronized锁升级：偏向锁 → 轻量级锁 → 重量级锁</h2> <p>前面提到，synchronized关键字就像是汽车的<strong>自动档</strong>，现在详细讲这个过程。一脚油门踩下去，synchronized会从<strong>无锁</strong>升级为<strong>偏向锁</strong>，再升级为<strong>轻量级锁</strong>，最后升级为<strong>重量级锁</strong>，就像自动换挡一样。那么自旋锁在哪里呢？这里的轻量级锁就是一种<strong>自旋锁</strong>。</p> <p>初次执行到synchronized代码块的时候，锁对象变成<strong>偏向锁</strong>（通过CAS修改对象头里的锁标志位），字面意思是“偏向于第一个获得它的线程”的锁。执行完同步代码块后，线程并<strong>不会主动释放偏向锁</strong>。当第二次到达同步代码块时，线程会判断此时持有锁的线程是否就是自己（持有锁的线程ID也在对象头里），如果是则正常往下执行**。由于之前没有释放锁，这里也就不需要重新加锁**。如果自始至终使用锁的线程只有一个，很明显偏向锁几乎没有额外开销，性能极高。</p> <p>一旦有第二个线程加入<strong>锁竞争</strong>，偏向锁就升级为<strong>轻量级锁（自旋锁）</strong>。这里要明确一下什么是锁竞争：如果多个线程轮流获取一个锁，但是每次获取锁的时候都很顺利，没有发生阻塞，那么就不存在锁竞争。只有当某线程尝试获取锁的时候，发现该锁已经被占用，只能等待其释放，这才发生了锁竞争。</p> <p>在轻量级锁状态下继续锁竞争，没有抢到锁的线程将<strong>自旋</strong>，即不停地循环判断锁是否能够被成功获取。获取锁的操作，其实就是通过CAS修改对象头里的锁标志位。先<strong>比较</strong>当前锁标志位是否为“释放”，如果是则将其<strong>设置</strong>为“锁定”，比较并设置是<strong>原子性</strong>发生的。这就算抢到锁了，然后线程将当前锁的持有者信息修改为自己。</p> <p>长时间的自旋操作是非常消耗资源的，一个线程持有锁，其他线程就只能在原地空耗CPU，执行不了任何有效的任务，这种现象叫做<strong>忙等（busy-waiting）</strong>。如果多个线程用一个锁，但是没有发生锁竞争，或者发生了很轻微的锁竞争，那么synchronized就用轻量级锁，允许短时间的忙等现象。这是一种折衷的想法**，短时间的忙等，换取线程在用户态和内核态之间切换的开销**。</p> <p>显然，此忙等是有限度的（有个计数器记录自旋次数，默认允许循环10次，可以通过虚拟机参数更改）。如果锁竞争情况严重，某个达到最大自旋次数的线程，会将轻量级锁升级为<strong>重量级锁</strong>（依然是CAS修改锁标志位，但不修改持有锁的线程ID）。当后续线程尝试获取锁时，发现被占用的锁是重量级锁，则直接将自己挂起（而不是忙等），等待将来被唤醒。在JDK1.6之前，synchronized直接加重量级锁，很明显现在得到了很好的优化。</p> <p>一个锁只能按照 偏向锁、轻量级锁、重量级锁的顺序逐渐升级（也有叫<strong>锁膨胀</strong>的），不允许降级。</p> <blockquote><p>偏向锁的一个特性是，持有锁的线程在执行完同步代码块时不会释放锁。那么当第二个线程执行到这个synchronized代码块时是否一定会发生锁竞争然后升级为轻量级锁呢？
线程A第一次执行完同步代码块后，当线程B尝试获取锁的时候，发现是偏向锁，会判断线程A是否仍然存活**。如果线程A仍然存活**，将线程A暂停，此时偏向锁升级为轻量级锁，之后线程A继续执行，线程B自旋。但是<strong>如果判断结果是线程A不存在了</strong>，则线程B持有此偏向锁，锁不升级。
还有人对此有疑惑，我之前确实没有描述清楚，但如果要展开讲，涉及到太多新概念，可以新开一篇了。更何况有些太底层的东西，我没读过源码，没有自信说自己一定是对的。其实在升级为轻量级锁之前，虚拟机会让线程A尽快在安全点挂起，然后在它的栈中“伪造”一些信息，让线程A在被唤醒之后，认为自己一直持有的是轻量级锁。如果线程A之前正在同步代码块中，那么线程B自旋等待即可。如果线程A之前不在同步代码块中，它会在被唤醒后检查到这一情况并立即释放锁，让线程B可以拿到。这部分内容我之前也没有深入研究过，如果有说的不对的，请多多指教啊！</p></blockquote> <h2 id="可重入锁（递归锁）"><a href="#可重入锁（递归锁）" class="header-anchor">#</a> 可重入锁（递归锁）</h2> <p>可重入锁的字面意思是“可以重新进入的锁”，即<strong>允许同一个线程多次获取同一把锁</strong>。比如一个递归函数里有加锁操作，递归过程中这个锁会阻塞自己吗？如果不会，那么这个锁就是<strong>可重入锁</strong>（因为这个原因可重入锁也叫做<strong>递归锁</strong>）****。</p> <p>Java里只要以Reentrant开头命名的锁都是可重入锁，而且<strong>JDK提供的所有现成的Lock实现类，包括synchronized关键字锁都是可重入的</strong>。如果你需要不可重入锁，只能自己去实现了。网上不可重入锁的实现真的很多，就不在这里贴代码了。99%的业务场景用可重入锁就可以了，剩下的1%是什么呢？我也不知道，谁可以在评论里告诉我？</p> <h2 id="公平锁、非公平锁"><a href="#公平锁、非公平锁" class="header-anchor">#</a> 公平锁、非公平锁</h2> <p>如果多个线程申请一把<strong>公平锁</strong>，那么当锁释放的时候，先申请的先得到，非常公平。显然如果是<strong>非公平锁</strong>，后申请的线程可能先获取到锁，是随机或者按照其他优先级排序的。</p> <p>对ReentrantLock类而言，通过构造函数传参<strong>可以指定该锁是否是公平锁，默认是非公平锁</strong>。一般情况下，非公平锁的吞吐量比公平锁大，如果没有特殊要求，优先使用非公平锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Creates an instance of {@code ReentrantLock} with the
* given fairness policy.
*
* @param fair {@code true} if this lock should use a fair ordering policy
*/</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>ReentrantLock构造器可以指定为公平或非公平</p></blockquote> <p>对于synchronized而言，它也是一种<strong>非公平锁</strong>，但是并没有任何办法使其变成公平锁。</p> <h2 id="可中断锁"><a href="#可中断锁" class="header-anchor">#</a> 可中断锁</h2> <p>可中断锁，字面意思是“可以<strong>响应中断</strong>的锁”。</p> <p>这里的关键是理解什么是<strong>中断</strong>。Java并没有提供任何直接中断某线程的方法，只提供了<strong>中断机制</strong>。何谓“中断机制”？线程A向线程B发出“请你停止运行”的请求（线程B也可以自己给自己发送此请求），但线程B并不会立刻停止运行，而是自行选择合适的时机以自己的方式响应中断，也可以直接忽略此中断。也就是说，Java的<strong>中断不能直接终止线程</strong>，而是需要被中断的线程自己决定怎么处理。这好比是父母叮嘱在外的子女要注意身体，但子女是否注意身体，怎么注意身体则完全取决于自己。</p> <p>回到锁的话题上来，如果线程A持有锁，线程B等待获取该锁。由于线程A持有锁的时间过长，线程B不想继续等待了，我们可以让线程B中断自己或者在别的线程里中断它，这种就是<strong>可中断锁</strong>。</p> <p>在Java中，synchronized就是<strong>不可中断锁</strong>，而Lock的实现类都是<strong>可中断锁</strong>，可以简单看下Lock接口。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/* Lock接口 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拿不到锁就一直等，拿到马上返回。</span>

    <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 拿不到锁就一直等，如果等待时收到中断请求，则需要处理InterruptedException。</span>

    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无论拿不拿得到锁，都马上返回。拿到返回true，拿不到返回false。</span>

    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 同上，可以自定义等待的时间。</span>

    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="读写锁、共享锁、互斥锁"><a href="#读写锁、共享锁、互斥锁" class="header-anchor">#</a> 读写锁、共享锁、互斥锁</h2> <p>读写锁其实是一对锁，一个读锁（共享锁）和一个写锁（互斥锁、排他锁）。</p> <p>看下Java里的ReadWriteLock接口，它只规定了两个方法，一个返回读锁，一个返回写锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReadWriteLock</span> <span class="token punctuation">{</span>
  	<span class="token comment">/**
  	* Returns the lock used for reading.
  	*
  	* @return the lock used for reading
  	*/</span>
  	<span class="token class-name">Lock</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  	<span class="token comment">/**
  	* Returns the lock used for writing.
  	*
  	* @return the lock used for writing
  	*/</span>
  	<span class="token class-name">Lock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>记得之前的乐观锁策略吗？所有线程随时都可以读，仅在写之前判断值有没有被更改。</p> <p>读写锁其实做的事情是一样的，但是策略稍有不同。很多情况下，线程知道自己读取数据后，是否是为了更新它。那么何不在加锁的时候直接明确这一点呢？如果我读取值是为了更新它（SQL的for update就是这个意思），那么加锁的时候就直接加<strong>写锁</strong>，我持有写锁的时候别的线程无论读还是写都需要等待；如果我读取数据仅为了前端展示，那么加锁时就明确地加一个<strong>读锁</strong>，其他线程如果也要加读锁，不需要等待，可以直接获取（读锁计数器+1）。</p> <p>虽然读写锁感觉与乐观锁有点像，但是<strong>读写锁是悲观锁策略</strong>。因为读写锁并没有在<strong>更新前</strong>判断值有没有被修改过，而是在<strong>加锁前</strong>决定应该用读锁还是写锁。乐观锁特指无锁编程，如果仍有疑惑可以再回到第一、二小节，看一下什么是“乐观锁”。</p> <p>JDK提供的唯一一个ReadWriteLock接口实现类是ReentrantReadWriteLock。看名字就知道，它不仅提供了读写锁，而是都是可重入锁。 除了两个接口方法以外，ReentrantReadWriteLock还提供了一些便于外界监控其内部工作状态的方法，这里就不一一展开。</p> <h2 id="回到悲观锁和乐观锁"><a href="#回到悲观锁和乐观锁" class="header-anchor">#</a> 回到悲观锁和乐观锁</h2> <blockquote><p>这篇文章经历过一次修改，我之前认为偏向锁和轻量级锁是乐观锁，重量级锁和Lock实现类为悲观锁，网上很多资料对这些概念的表述也很模糊，各执一词。</p></blockquote> <p>先抛出我的结论：</p> <p>我们在Java里使用的各种锁**，几乎全都是悲观锁**。synchronized从偏向锁、轻量级锁到重量级锁，全是悲观锁。JDK提供的Lock实现类全是悲观锁。其实只要有“锁对象”出现，那么就一定是悲观锁。因为<strong>乐观锁不是锁，而是一个在循环里尝试CAS的算法</strong>。</p> <p>那JDK并发包里到底有没有乐观锁呢？<br>有。java.util.concurrent.atomic包里面的<strong>原子类</strong>都是利用乐观锁实现的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
          	<span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>原子类AtomicInteger的自增方法为乐观锁策略</p></blockquote> <p>为什么网上有些资料认为偏向锁、轻量级锁是乐观锁？理由是它们底层用到了CAS？或者是把“乐观/悲观”与“轻量/重量”搞混了？其实，线程在抢占这些锁的时候，确实是循环+CAS的操作，感觉好像是乐观锁。但问题的关键是，我们说一个锁是悲观锁还是乐观锁，总是应该站在应用层，看它们是如何锁住应用数据的，而不是站在底层看抢占锁的过程。如果一个线程尝试获取锁时，发现已经被占用，它是否继续读取数据，等后续要更新时再决定要不要重试？对于偏向锁、轻量级锁来说，显然答案是否定的。无论是挂起还是忙等，对应用数据的读取操作都被“挡住”了。从这个角度看，它们确实是悲观锁。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/DevLanguage/Java/Java并发/0-JMM.html" class="prev">0 - JMM(Java内存模型)概念</a></span> <span class="next"><a href="/DevLanguage/Java/Spring/">Spring</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2ba1140b.js" defer></script><script src="/assets/js/2.858e58ff.js" defer></script><script src="/assets/js/65.11535a8c.js" defer></script>
  </body>
</html>
