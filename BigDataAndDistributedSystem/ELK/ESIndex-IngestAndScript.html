<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES Index-Ingest|Script | Yan&#39;s Blog Home</title>
    <meta name="description" content="Personal blog site">
    
    
    <link rel="preload" href="/assets/css/0.styles.659f981c.css" as="style"><link rel="preload" href="/assets/js/app.29af2d6c.js" as="script"><link rel="preload" href="/assets/js/2.858e58ff.js" as="script"><link rel="preload" href="/assets/js/45.903efdc0.js" as="script"><link rel="prefetch" href="/assets/js/10.5dcc1f52.js"><link rel="prefetch" href="/assets/js/100.0327e00b.js"><link rel="prefetch" href="/assets/js/101.404f187c.js"><link rel="prefetch" href="/assets/js/102.d78878ec.js"><link rel="prefetch" href="/assets/js/103.ec9aedef.js"><link rel="prefetch" href="/assets/js/104.39309514.js"><link rel="prefetch" href="/assets/js/105.afbf1884.js"><link rel="prefetch" href="/assets/js/106.8e9709d3.js"><link rel="prefetch" href="/assets/js/107.9712aa22.js"><link rel="prefetch" href="/assets/js/108.4158fdb6.js"><link rel="prefetch" href="/assets/js/109.ae61a303.js"><link rel="prefetch" href="/assets/js/11.34e3d90e.js"><link rel="prefetch" href="/assets/js/110.0abce6c9.js"><link rel="prefetch" href="/assets/js/111.b5c958e5.js"><link rel="prefetch" href="/assets/js/112.9b07d6a0.js"><link rel="prefetch" href="/assets/js/113.9d95243d.js"><link rel="prefetch" href="/assets/js/114.f759f9b9.js"><link rel="prefetch" href="/assets/js/115.fd833a74.js"><link rel="prefetch" href="/assets/js/116.1e5e62e4.js"><link rel="prefetch" href="/assets/js/117.952db9d4.js"><link rel="prefetch" href="/assets/js/118.ed9df468.js"><link rel="prefetch" href="/assets/js/119.f19ee9e0.js"><link rel="prefetch" href="/assets/js/12.cd237cda.js"><link rel="prefetch" href="/assets/js/120.24dbecef.js"><link rel="prefetch" href="/assets/js/121.41c70ddb.js"><link rel="prefetch" href="/assets/js/122.5205ca42.js"><link rel="prefetch" href="/assets/js/123.25aa20a6.js"><link rel="prefetch" href="/assets/js/124.11cc8c85.js"><link rel="prefetch" href="/assets/js/125.091331f4.js"><link rel="prefetch" href="/assets/js/126.471b335f.js"><link rel="prefetch" href="/assets/js/127.60ffdb36.js"><link rel="prefetch" href="/assets/js/128.9c5c36ef.js"><link rel="prefetch" href="/assets/js/129.36fd802b.js"><link rel="prefetch" href="/assets/js/13.de2ffe9f.js"><link rel="prefetch" href="/assets/js/130.822de8a4.js"><link rel="prefetch" href="/assets/js/131.697750e2.js"><link rel="prefetch" href="/assets/js/132.fd5faa78.js"><link rel="prefetch" href="/assets/js/133.cf327ef4.js"><link rel="prefetch" href="/assets/js/134.6cdb8690.js"><link rel="prefetch" href="/assets/js/135.906c8800.js"><link rel="prefetch" href="/assets/js/136.43585d13.js"><link rel="prefetch" href="/assets/js/137.3c7ddb41.js"><link rel="prefetch" href="/assets/js/138.e3274ead.js"><link rel="prefetch" href="/assets/js/139.7fa38b58.js"><link rel="prefetch" href="/assets/js/14.9d6406e7.js"><link rel="prefetch" href="/assets/js/140.1b026dad.js"><link rel="prefetch" href="/assets/js/141.c1adfec5.js"><link rel="prefetch" href="/assets/js/142.2810013c.js"><link rel="prefetch" href="/assets/js/143.af96e2f9.js"><link rel="prefetch" href="/assets/js/144.923a7d38.js"><link rel="prefetch" href="/assets/js/145.d88163de.js"><link rel="prefetch" href="/assets/js/146.2134dd3e.js"><link rel="prefetch" href="/assets/js/147.9925c468.js"><link rel="prefetch" href="/assets/js/148.109297cc.js"><link rel="prefetch" href="/assets/js/149.ae529d47.js"><link rel="prefetch" href="/assets/js/15.fe3428fa.js"><link rel="prefetch" href="/assets/js/150.705297ac.js"><link rel="prefetch" href="/assets/js/151.a715116f.js"><link rel="prefetch" href="/assets/js/152.57feb7ad.js"><link rel="prefetch" href="/assets/js/153.fd5cde7c.js"><link rel="prefetch" href="/assets/js/154.8cedd5d3.js"><link rel="prefetch" href="/assets/js/155.042308eb.js"><link rel="prefetch" href="/assets/js/156.54044f43.js"><link rel="prefetch" href="/assets/js/157.69e07481.js"><link rel="prefetch" href="/assets/js/158.5b91c0e7.js"><link rel="prefetch" href="/assets/js/159.ccb310d2.js"><link rel="prefetch" href="/assets/js/16.7976352c.js"><link rel="prefetch" href="/assets/js/160.08c90bea.js"><link rel="prefetch" href="/assets/js/161.943b1e4b.js"><link rel="prefetch" href="/assets/js/162.8092cc22.js"><link rel="prefetch" href="/assets/js/163.3c82e51b.js"><link rel="prefetch" href="/assets/js/164.0fd751fe.js"><link rel="prefetch" href="/assets/js/165.60d778eb.js"><link rel="prefetch" href="/assets/js/166.54d7340a.js"><link rel="prefetch" href="/assets/js/167.5fd6aaa3.js"><link rel="prefetch" href="/assets/js/168.205929f8.js"><link rel="prefetch" href="/assets/js/169.873b90b1.js"><link rel="prefetch" href="/assets/js/17.4a461074.js"><link rel="prefetch" href="/assets/js/170.68c49359.js"><link rel="prefetch" href="/assets/js/171.d8f93304.js"><link rel="prefetch" href="/assets/js/172.6b496cc7.js"><link rel="prefetch" href="/assets/js/173.f276a0ce.js"><link rel="prefetch" href="/assets/js/174.09cb41e2.js"><link rel="prefetch" href="/assets/js/175.c77ce8d9.js"><link rel="prefetch" href="/assets/js/176.01ab9f3f.js"><link rel="prefetch" href="/assets/js/177.e9733435.js"><link rel="prefetch" href="/assets/js/178.02e78943.js"><link rel="prefetch" href="/assets/js/179.0d14e948.js"><link rel="prefetch" href="/assets/js/18.8264b169.js"><link rel="prefetch" href="/assets/js/180.9a15f295.js"><link rel="prefetch" href="/assets/js/181.d5bcbada.js"><link rel="prefetch" href="/assets/js/182.571b87a8.js"><link rel="prefetch" href="/assets/js/183.0ce45547.js"><link rel="prefetch" href="/assets/js/184.8397e2fe.js"><link rel="prefetch" href="/assets/js/185.3a38f733.js"><link rel="prefetch" href="/assets/js/186.881a0fab.js"><link rel="prefetch" href="/assets/js/187.17663dea.js"><link rel="prefetch" href="/assets/js/188.471fcd9b.js"><link rel="prefetch" href="/assets/js/189.69430297.js"><link rel="prefetch" href="/assets/js/19.e6227b20.js"><link rel="prefetch" href="/assets/js/190.357b4cc8.js"><link rel="prefetch" href="/assets/js/191.f2d049a7.js"><link rel="prefetch" href="/assets/js/192.e2d30cca.js"><link rel="prefetch" href="/assets/js/193.2fbcbc68.js"><link rel="prefetch" href="/assets/js/194.61d0acd9.js"><link rel="prefetch" href="/assets/js/195.33b772c3.js"><link rel="prefetch" href="/assets/js/196.7d35848a.js"><link rel="prefetch" href="/assets/js/197.4b958d27.js"><link rel="prefetch" href="/assets/js/198.dfbfba98.js"><link rel="prefetch" href="/assets/js/199.f6c7aacb.js"><link rel="prefetch" href="/assets/js/20.65ad9b00.js"><link rel="prefetch" href="/assets/js/200.6a05302e.js"><link rel="prefetch" href="/assets/js/201.be446c97.js"><link rel="prefetch" href="/assets/js/202.d058ca1d.js"><link rel="prefetch" href="/assets/js/203.ef2b609c.js"><link rel="prefetch" href="/assets/js/204.dab38ee5.js"><link rel="prefetch" href="/assets/js/21.bf0f72d4.js"><link rel="prefetch" href="/assets/js/22.0ed457bc.js"><link rel="prefetch" href="/assets/js/23.789f7b2b.js"><link rel="prefetch" href="/assets/js/24.f151ffcb.js"><link rel="prefetch" href="/assets/js/25.1edb28e8.js"><link rel="prefetch" href="/assets/js/26.6a5f804d.js"><link rel="prefetch" href="/assets/js/27.98408441.js"><link rel="prefetch" href="/assets/js/28.fe24662a.js"><link rel="prefetch" href="/assets/js/29.fbd2340a.js"><link rel="prefetch" href="/assets/js/3.753236a7.js"><link rel="prefetch" href="/assets/js/30.30b44255.js"><link rel="prefetch" href="/assets/js/31.510d262b.js"><link rel="prefetch" href="/assets/js/32.c204bc79.js"><link rel="prefetch" href="/assets/js/33.5fa66039.js"><link rel="prefetch" href="/assets/js/34.6db47b26.js"><link rel="prefetch" href="/assets/js/35.fcb88dd5.js"><link rel="prefetch" href="/assets/js/36.e294e99d.js"><link rel="prefetch" href="/assets/js/37.0a98cae2.js"><link rel="prefetch" href="/assets/js/38.94af8189.js"><link rel="prefetch" href="/assets/js/39.e7017f9b.js"><link rel="prefetch" href="/assets/js/4.efbefbf5.js"><link rel="prefetch" href="/assets/js/40.b7a1deeb.js"><link rel="prefetch" href="/assets/js/41.ae4d7d1e.js"><link rel="prefetch" href="/assets/js/42.5dc5c7f6.js"><link rel="prefetch" href="/assets/js/43.1abeab08.js"><link rel="prefetch" href="/assets/js/44.2b0e19f3.js"><link rel="prefetch" href="/assets/js/46.0684656f.js"><link rel="prefetch" href="/assets/js/47.6425b35e.js"><link rel="prefetch" href="/assets/js/48.551e2caa.js"><link rel="prefetch" href="/assets/js/49.34841bc0.js"><link rel="prefetch" href="/assets/js/5.d3774f5f.js"><link rel="prefetch" href="/assets/js/50.48ce1d7e.js"><link rel="prefetch" href="/assets/js/51.1820aa29.js"><link rel="prefetch" href="/assets/js/52.5317c537.js"><link rel="prefetch" href="/assets/js/53.65c5ef62.js"><link rel="prefetch" href="/assets/js/54.31ed2a5e.js"><link rel="prefetch" href="/assets/js/55.4f9933ab.js"><link rel="prefetch" href="/assets/js/56.beb74e07.js"><link rel="prefetch" href="/assets/js/57.705bc19e.js"><link rel="prefetch" href="/assets/js/58.f5fd656b.js"><link rel="prefetch" href="/assets/js/59.4f21d836.js"><link rel="prefetch" href="/assets/js/6.f082ca37.js"><link rel="prefetch" href="/assets/js/60.fc3cf484.js"><link rel="prefetch" href="/assets/js/61.b5032b43.js"><link rel="prefetch" href="/assets/js/62.64d7637a.js"><link rel="prefetch" href="/assets/js/63.2a71075b.js"><link rel="prefetch" href="/assets/js/64.21eb4820.js"><link rel="prefetch" href="/assets/js/65.11535a8c.js"><link rel="prefetch" href="/assets/js/66.cc057448.js"><link rel="prefetch" href="/assets/js/67.5782c958.js"><link rel="prefetch" href="/assets/js/68.35886dae.js"><link rel="prefetch" href="/assets/js/69.934aa057.js"><link rel="prefetch" href="/assets/js/7.9a79fd87.js"><link rel="prefetch" href="/assets/js/70.53c7c7a2.js"><link rel="prefetch" href="/assets/js/71.0e82b1c6.js"><link rel="prefetch" href="/assets/js/72.0f5ba0b4.js"><link rel="prefetch" href="/assets/js/73.3dabc9cd.js"><link rel="prefetch" href="/assets/js/74.b2ae43f6.js"><link rel="prefetch" href="/assets/js/75.482aa6b4.js"><link rel="prefetch" href="/assets/js/76.2f88e50b.js"><link rel="prefetch" href="/assets/js/77.d916e87e.js"><link rel="prefetch" href="/assets/js/78.35465388.js"><link rel="prefetch" href="/assets/js/79.03bce65e.js"><link rel="prefetch" href="/assets/js/8.60d5a8a9.js"><link rel="prefetch" href="/assets/js/80.96678f59.js"><link rel="prefetch" href="/assets/js/81.631a8496.js"><link rel="prefetch" href="/assets/js/82.41c1aeb7.js"><link rel="prefetch" href="/assets/js/83.16d5e455.js"><link rel="prefetch" href="/assets/js/84.195ca01f.js"><link rel="prefetch" href="/assets/js/85.d850d4dd.js"><link rel="prefetch" href="/assets/js/86.32d87d56.js"><link rel="prefetch" href="/assets/js/87.5f97a4f6.js"><link rel="prefetch" href="/assets/js/88.f5b0bbdb.js"><link rel="prefetch" href="/assets/js/89.9f9150f5.js"><link rel="prefetch" href="/assets/js/9.b09584f6.js"><link rel="prefetch" href="/assets/js/90.81e868a0.js"><link rel="prefetch" href="/assets/js/91.a4a66d6f.js"><link rel="prefetch" href="/assets/js/92.e992da4f.js"><link rel="prefetch" href="/assets/js/93.8f0f273c.js"><link rel="prefetch" href="/assets/js/94.7c76483d.js"><link rel="prefetch" href="/assets/js/95.448f049a.js"><link rel="prefetch" href="/assets/js/96.29982e03.js"><link rel="prefetch" href="/assets/js/97.4fdd8a0b.js"><link rel="prefetch" href="/assets/js/98.74cfc635.js"><link rel="prefetch" href="/assets/js/99.abdd1b46.js">
    <link rel="stylesheet" href="/assets/css/0.styles.659f981c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yan's Blog Home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据和分布式系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式系统理论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式协调服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据摄取 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据流 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据处理 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据分析 Layer (OLAP)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式系统基础框架Hadoop</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Data Platform - Splunk</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Data Platform - ELK</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BigDataAndDistributedSystem/ELK/" class="sidebar-link">Data Platform - ELK</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-base.html" class="sidebar-link">ES 概念与总结</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-cluster.html" class="sidebar-link">ES 原理-分布式特性</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-index.html" class="sidebar-link">ES 原理-倒排索引</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-AnalysisAndRelated.html" class="sidebar-link">ES 原理-分词器 &amp; 搜索相关性</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html" class="sidebar-link">ES Index-基本操作与并发</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-mapping.html" class="sidebar-link">ES Index-Mapping &amp; Setting</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IndexTemplate.html" class="sidebar-link">ES Index-Index Template</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-TextAnalysis.html" class="sidebar-link">ES Index-Text Analysis</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html" class="active sidebar-link">ES Index-Ingest|Script</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#使用ingest-pipeline进行数据预处理" class="sidebar-link">使用Ingest Pipeline进行数据预处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_1-ingest-node-预处理节点" class="sidebar-link">1. Ingest Node 预处理节点</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_2-pipeline-processor" class="sidebar-link">2. Pipeline &amp; Processor</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_2-2-simulate-pipeline-api" class="sidebar-link">2.2 Simulate Pipeline API</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_2-3-pipeline-api" class="sidebar-link">2.3 Pipeline API</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_2-3-processors-详解" class="sidebar-link">2.3 Processors 详解</a></li></ul></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#使用script加工数据" class="sidebar-link">使用Script加工数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_1-介绍" class="sidebar-link">1. 介绍</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html#_2-基本使用" class="sidebar-link">2. 基本使用</a></li></ul></li></ul></li><li><a href="/BigDataAndDistributedSystem/ELK/ESUsage-crud.html" class="sidebar-link">ES 使用-基本CRUD</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-search.html" class="sidebar-link">ES 搜索-搜索相关</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-queryDSL.html" class="sidebar-link">ES 搜索-查询DSL</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-aggregation.html" class="sidebar-link">ES 搜索-聚合</a></li></ul></section></li><li><a href="/index/" class="sidebar-link">&lt; 首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es-index-ingest-script"><a href="#es-index-ingest-script" class="header-anchor">#</a> ES Index-Ingest|Script</h1> <div class="custom-block tip"><p class="custom-block-title">转载</p> <ul><li><a href="https://www.yuque.com/xiongsanxiansheng/qfvqxo/hgfsk5" target="_self" rel="noopener noreferrer">https://www.yuque.com/xiongsanxiansheng/qfvqxo/hgfsk5</a></li> <li><a href="https://www.yuque.com/xiongsanxiansheng/qfvqxo/egqcvg" target="_self" rel="noopener noreferrer">https://www.yuque.com/xiongsanxiansheng/qfvqxo/egqcvg</a></li> <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/ingest.html" target="_self" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/ingest.html</a></li> <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting.html" target="_self" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting.html</a></li></ul></div> <p><em><strong>为什么把Ingest和Script放在一起？</strong></em></p> <p>在ES中，这两种方式都是对数据进行处理。Ingest Node(Pipeline)可以实现对数据进行预处理，功能类似ELK中的logstash。而Script则使可以写在脚本中，对数据进行加工处理。</p> <h2 id="使用ingest-pipeline进行数据预处理"><a href="#使用ingest-pipeline进行数据预处理" class="header-anchor">#</a> <strong>使用Ingest Pipeline进行数据预处理</strong></h2> <p>Elasticsearch 可以使用自身的 Ingest Pipeline 功能进行数据预处理, 无须借助 Logstash。</p> <p>举例，有一个需求，修复与增强写入的数据：</p> <ul><li>Tags 字段中，逗号分隔的文本应该是数组，而不是一个字符串</li> <li>需求：后期需要对 Tags 进行 Aggregation 分析</li></ul> <h3 id="_1-ingest-node-预处理节点"><a href="#_1-ingest-node-预处理节点" class="header-anchor">#</a> 1. Ingest Node 预处理节点</h3> <ul><li>ES 5.0 后，引入的一种新的节点类型。默认配置下，每个节点都是 Ingest Node。
<ul><li>具有预处理数据的能力，可拦截 Index 或 Bulk API 的请求；</li> <li>对数据进行转换，并重新返回给 Index 或 Bulk API；</li></ul></li> <li>Ingest Node v.s Logstash</li></ul> <div style="display:flex;"><img src="/assets/img/es-ingest-1.95966f3a.png" alt="" align="left" style="display:block;"></div> <ul><li><p>控制节点的 ingest 开关在其 elasticsearch.yml 中的参数：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>## 关闭ingest
node.ingest<span class="token operator">:</span> <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>无需 Logstash，就可以进行数据的预处理，例如:</p> <ul><li>为某个字段设置默认值、重命名某个字段的字段名、对字段值进行 Split 操作</li> <li>支持设置 Painless 脚本，对数据进行更加复杂的加工</li></ul></li> <li><p>Ingest 节点对数据的处理主要是通过管道（pipeline），在索引和请求中指定 Pipeling Uid，这样 Ingest 节点在拦截请求后就指定使用哪条管道进行处理。</p></li></ul> <div style="display:flex;"><img src="/assets/img/es-ingest-2.6971ef4c.png" alt="" align="left" style="display:block;"></div> <ul><li>使用场景
<ul><li>通过上图我们很容易看到 Ingest Node 可以在数据被索引前，通过预定义好的处理管道对其进行治理；</li> <li>存在一个局限性：只能通过一条管道；</li></ul></li></ul> <blockquote><p>为了应对这个局限性，一直以来的应对方案就是把所有需要的处理器和细节全部配置到当前管道下。</p> <p>这个方案带来的问题也很明显：</p> <ol><li>复制、粘贴很多相同的管道配置在不同数据管道里；</li> <li>非常难管理、维护冗长的管道；</li> <li>如果要更新一个处理细节的话要找到定位所有使用过这个逻辑的管道；</li></ol> <p>这个问题最合适的解决办法就是，使用管道处理器，它提供了一个允许在一个管道内调用其他管道的方案。（具体内容参考：<strong>管道委托</strong>，或者 <strong>Pipeline Processor</strong>）</p></blockquote> <h3 id="_2-pipeline-processor"><a href="#_2-pipeline-processor" class="header-anchor">#</a> 2. Pipeline &amp; Processor</h3> <h4 id="_2-1-介绍"><a href="#_2-1-介绍" class="header-anchor">#</a> 2.1 介绍</h4> <ul><li>Pipeline：管道会对通过的数据（文档），按照顺序进行加工，比如：修改文档的某个字段值、修改某个字段的类型等；</li> <li>Processor：Elasticsearch 对该加工行为进行的抽象包装
<ul><li>ES 有很多内置的 Processors；</li> <li>也支持通过插件的方式，实现自己的 Processor；</li></ul></li></ul> <br> <div style="display:flex;"><img src="/assets/img/es-ingest-3.053dc42a.png" alt="" align="left" style="display:block;"></div> <br> <h3 id="_2-2-simulate-pipeline-api"><a href="#_2-2-simulate-pipeline-api" class="header-anchor">#</a> 2.2 Simulate Pipeline API</h3> <ul><li>ES 提供了相关的 API，来让我们对这些预处理操作进行测试。</li> <li>Simulate API 可以模拟 Pipeline，辅助我们深入理解 pipeline 和 processors 的使用。</li> <li>下面是一个比较简单的 Simulate Pipeline API 的例子，使用 pipeline 切分字符串：</li></ul> <br> <div style="display:flex;"><img src="/assets/img/es-ingest-4.5c2be331.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>也可以在 URL 中指定 pipeline ID：</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST _ingest/pipeline/my-pipeline-id/_simulate
<span class="token punctuation">{</span>
  <span class="token property">&quot;docs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/** first document **/</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/** second document **/</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-3-pipeline-api"><a href="#_2-3-pipeline-api" class="header-anchor">#</a> 2.3 Pipeline API</h3> <h4 id="_1-创建一个-pipeline："><a href="#_1-创建一个-pipeline：" class="header-anchor">#</a> 1) 创建一个 pipeline：</h4> <ul><li>对文档中的 tags 字段切分字符串；</li> <li>为文档增加一个 views 字段，默认值 0；</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code># 为ES添加一个 Pipeline，blog_pipeline 为 Pipeline Uid
PUT _ingest/pipeline/blog_pipeline
<span class="token punctuation">{</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a blog pipeline&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;split&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;separator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;,&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;set&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_2-获取某个-pipleline-内容："><a href="#_2-获取某个-pipleline-内容：" class="header-anchor">#</a> 2) 获取某个 pipleline 内容：</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#根据 Pipleline Uid 查看
GET _ingest/pipeline/blog_pipeline
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_3-删除某个-pipeline："><a href="#_3-删除某个-pipeline：" class="header-anchor">#</a> 3) 删除某个 pipeline：</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#清楚指定的 Pipeline
DELETE _ingest/pipeline/blog_pipeline

#清楚所有的 Pipeline
DELETE _ingest/pipeline<span class="token comment">/*
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-写入数据时，pipeline-预处理："><a href="#_4-写入数据时，pipeline-预处理：" class="header-anchor">#</a> 4) 写入数据时，pipeline 预处理：</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#使用 pipeline 预处理数据
PUT tech_blogs/_doc/<span class="token number">2</span>?pipeline=blog_pipeline
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Introducing cloud computering&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;openstack,k8s&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;You konw, for cloud&quot;</span>
<span class="token punctuation">}</span>
#####返回结果的部分内容
<span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;tech_blogs&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Introducing cloud computering&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;content&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;You konw, for cloud&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;views&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;openstack&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;k8s&quot;</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_5-对已有数据，使用-pipeline-进行处理："><a href="#_5-对已有数据，使用-pipeline-进行处理：" class="header-anchor">#</a> 5) 对已有数据，使用 pipeline 进行处理：</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#update_by_query 会导致错误
POST tech_blogs/_update_by_query?pipeline=blog_pipeline
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>

#增加update_by_query的条件
POST tech_blogs/_update_by_query?pipeline=blog_pipeline
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;exists&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;views&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_6-访问引用文档中元数据"><a href="#_6-访问引用文档中元数据" class="header-anchor">#</a> 6) 访问引用文档中元数据</h4> <ul><li>经过 pipeline 的返回结果中，ES 会增加一个 _ingest 属性，可以使用 _ingest.timestamp 来提取其时间戳；</li> <li>如果我们需要获取到文档或 ES 的元素进行操作，可以使用  的方式进行访问；</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code># 获取_ingest中的时间戳赋值给received
<span class="token punctuation">{</span>
  <span class="token property">&quot;set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;received&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{_ingest.timestamp}}&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# 简单的文档中字段拼接
<span class="token punctuation">{</span>
  <span class="token property">&quot;set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field_c&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{field_a}} {{field_b}}&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_7-添加执行条件"><a href="#_7-添加执行条件" class="header-anchor">#</a> 7) 添加执行条件</h4> <ul><li>简单条件：每个处理器都允许一个可选的if条件来决定应该执行还是跳过该处理器。if 的值需要将其计算为 true 或 false。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#创建一个管道<span class="token punctuation">,</span> 当遇见area为中国华东的数据时就不进行操作
PUT _ingest/pipeline/not_save
<span class="token punctuation">{</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;drop&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx.area=='中国华东'&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

#然后尝试保存下面数据，并且使用not_save管道
POST city_info/_doc/<span class="token number">1</span>?pipeline=not_save
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;无锡&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;大城市&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;江苏&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;gdp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1143800000000&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国华东&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;carNumPrefix&quot;</span><span class="token operator">:</span> <span class="token string">&quot;苏B&quot;</span>
<span class="token punctuation">}</span>

#尝试查询ID为<span class="token number">1</span>的文档<span class="token punctuation">,</span>此时会发现数据并没有插入。
GET city_info/_doc/<span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>复杂条件：除了简单条件，ES 也支持多个 if 操作，比如下面是官方提供的一个复杂条件 Demo。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT _ingest/pipeline/not_prod_dropper
<span class="token punctuation">{</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;drop&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Collection tags = ctx.tags;if(tags != null){for (String tag : tags) {if (tag.toLowerCase().contains('prod')) { return false;}}} return true;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>因为受限制于 JSON 解析的原因执行条件被写在了一行之中，把条件单独拿出来是下面的样子，其实本质就是 JAVA 代码中的循环判断。</p></blockquote> <div class="language-json line-numbers-mode"><pre class="language-json"><code>Collection tags = ctx.tags;
if(tags != <span class="token null keyword">null</span>)<span class="token punctuation">{</span>
    for (String tag <span class="token operator">:</span> tags) <span class="token punctuation">{</span>
        if (tag.toLowerCase().contains('prod')) <span class="token punctuation">{</span>
            return <span class="token boolean">false</span>;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
return <span class="token boolean">true</span>;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>假如使用 Postman 进行接口调试的时候因为限制无法将判断内容格式化，这对于开发调试来说是非常难受的。但是使用 Kibana 可以使用其<code>&quot;&quot;&quot;</code>语法，在其内部可以显示格式化后的条件代码。</p></blockquote> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT _ingest/pipeline/not_prod_dropper
<span class="token punctuation">{</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;drop&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>&quot;
            Collection tags = ctx.tags;
            if(tags != <span class="token null keyword">null</span>)<span class="token punctuation">{</span>
              for (String tag <span class="token operator">:</span> tags) <span class="token punctuation">{</span>
                  if (tag.toLowerCase().contains('prod')) <span class="token punctuation">{</span>
                      return <span class="token boolean">false</span>;
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            return <span class="token boolean">true</span>;
        <span class="token string">&quot;&quot;</span>&quot;
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_8-管道委托"><a href="#_8-管道委托" class="header-anchor">#</a> 8) 管道委托</h4> <ul><li>之前操作都是通过管道设置其中数据的值，而使用下面操作可以将数据的操作转移到另外一个管道中：</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;pipeline&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx.foo == 'foo1'&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;last_pipeline&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

############ 管道委托 demo ###########
# <span class="token number">1.</span> 下面例子中创建了一个last_pipeline的管道，其将foo参数设置为last_foo_value
PUT _ingest/pipeline/last_pipeline
<span class="token punctuation">{</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;last_foo_value&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
# <span class="token number">2.</span> 然后使用_simulate来模拟数据操作被转移的行为
# 下面请求中当&quot;ctx.foo == 'foo<span class="token number">1</span>'条件被满足后，将用last_pipeline来处理数据
POST _ingest/pipeline/_simulate
<span class="token punctuation">{</span>
  <span class="token property">&quot;pipeline&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_description&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;pipeline&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx.foo == 'foo1'&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;last_pipeline&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;docs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;boo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boo1&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;boo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boo2&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h4 id="_9-条件中的嵌套数据"><a href="#_9-条件中的嵌套数据" class="header-anchor">#</a> 9) 条件中的嵌套数据</h4> <ul><li>当需要访问的字段是文档的嵌套字段，如果父级对象不存在的时候去调用其子对象，在 JAVA 中会抛出 NullPointerException，而对于 ES 同样存在此风险，所以为了应对此类问题 ES 提供了 ? 符号，使用此符号可以安全的进行子集访问。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code># 如果network字段不曾存在，则不进行子字段name值的比较
PUT _ingest/pipeline/drop_guests_network
<span class="token punctuation">{</span>
  <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;drop&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;if&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx.network?.name == 'Guest'&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_10-处理管道异常"><a href="#_10-处理管道异常" class="header-anchor">#</a> 10) 处理管道异常</h4> <ul><li>正常使用中，管道定义的处理列表是按照顺序执行的，当处理过程中存在异常时处理便会停止。让异常直接终止处理的方法显然不合理。当我们预期到某些异常的存在时，我们应该有另外一种方式去处理而不是停止程序。</li> <li><code>on_failure</code>参数定义了在发生故障的处理器之后立即执行的处理器列表。<code>on_failure</code> 参数可以设置在管道中也可以设置在管道内的处理器中。</li> <li>如果处理器指定了 <code>on_failure</code> 配置，不管它是否为空，处理器抛出的任何异常都会被捕获。</li> <li>如果管道指定了 <code>on_failure</code> 配置，而管道将继续执行其余的处理器。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code># <span class="token number">1.</span>将foo字段修改为bar字段，但是当foo的字段不存在的时候会发生异常，这个时候会执行on_failure内部的逻辑
POST _ingest/pipeline/_simulate
<span class="token punctuation">{</span>
  <span class="token property">&quot;pipeline&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_description&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;processors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;rename&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;target_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;on_failure&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field \&quot;foo\&quot; does not exist, cannot rename to \&quot;bar\&quot;&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;docs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;boo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boo1&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;boo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boo2&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

#其执行后的结果，可以看到第一条数据已经存在error的信息
<span class="token punctuation">{</span>
  <span class="token property">&quot;doc&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;boo&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;boo1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;error&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token string">&quot;field &quot;</span>foo<span class="token string">&quot; does not exist, cannot rename to &quot;</span>bar<span class="token string">&quot;&quot;</span><span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_ingest&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;timestamp&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2020-06-28T02:59:34.544Z&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><ul><li>**指向新的索引：**这是官方提供的一个异常处理的应用方式。将错误数据指向到一个新的索引中是个非常好的处理方式，当我们批量执行操作遇见错误的数据被保存到一个错误索引表中，我们就可以专门针对这张索引进行分析和处理。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code># 修改这条数据的索引名字段值，将错误数据导入新的索引中
<span class="token property">&quot;on_failure&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;set&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_index&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;failed-{{ _index }}&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>**忽略异常：**有的时候我们可能并不关系异常的内容和原因，仅仅是想完成一些操作，这个时候可以使用 <code>&quot;ignore_failure&quot; : true</code> 配置来让系统忽略掉所有异常。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my first pipeline with handled exceptions&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;processors&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;rename&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;target_field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ignore_failure&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>**获取异常信息：**类似 try-catch 中的逻辑，我们可以获取异常中的信息，而 ES 也提供了获取异常信息的方式。其异常信息放在 <code>_ingest</code>，此参数可以获取的内容为 <code>on_failure_message</code>、<code>on_failure_processor_type</code> 和 <code>on_failure_processor_tag</code> 的元数据字段。需要注意的上面的内容只能在on_failure 代码块中访问；</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;on_failure&quot; : [
  {
    &quot;set&quot; : {
      &quot;field&quot; : &quot;error&quot;,
      &quot;value&quot; : &quot;{{ _ingest.on_failure_message }}&quot;
    }
  }
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-3-processors-详解"><a href="#_2-3-processors-详解" class="header-anchor">#</a> 2.3 Processors 详解</h3> <p>目前在 7.x 版本中一共存在 32 个不同的处理器，除去两个属于 X-Pack 的一共是 30 个。</p> <p>具体查看参考文档/官网文档：</p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/ingest-processors.html" target="_self" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/ingest-processors.html</a></p> <p><a href="https://www.yuque.com/xiongsanxiansheng/qfvqxo/hgfsk5" target="_self" rel="noopener noreferrer">https://www.yuque.com/xiongsanxiansheng/qfvqxo/hgfsk5</a></p> <h2 id="使用script加工数据"><a href="#使用script加工数据" class="header-anchor">#</a> 使用Script加工数据</h2> <h3 id="_1-介绍"><a href="#_1-介绍" class="header-anchor">#</a> 1. 介绍</h3> <p>With scripting, you can evaluate custom expressions in Elasticsearch. For example, you could use a script to return &quot;script fields&quot; as part of a search request or evaluate a custom score for a query.</p> <p>默认语言是：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-painless.html" target="_self" rel="noopener noreferrer"><code>Painless</code></a>.</p> <p><strong>其他语言</strong></p> <p>These languages are less flexible, but typically have higher performance for certain tasks.</p> <table><thead><tr><th>Language</th> <th>Sandboxed</th> <th>Required plugin</th> <th>Purpose</th></tr></thead> <tbody><tr><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-expression.html" target="_self" rel="noopener noreferrer"><code>expression</code></a></td> <td>yes</td> <td>built-in</td> <td>fast custom ranking and sorting</td></tr> <tr><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/search-template.html" target="_self" rel="noopener noreferrer"><code>mustache</code></a></td> <td>yes</td> <td>built-in</td> <td>templates</td></tr> <tr><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-engine.html" target="_self" rel="noopener noreferrer"><code>java</code></a></td> <td>n/a</td> <td>you write it!</td> <td>expert API</td></tr></tbody></table> <h3 id="_2-基本使用"><a href="#_2-基本使用" class="header-anchor">#</a> 2. 基本使用</h3> <h4 id="_2-1-脚本语法"><a href="#_2-1-脚本语法" class="header-anchor">#</a> 2.1 脚本语法</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;lang&quot;</span><span class="token operator">:</span>   <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span>  					
  <span class="token string">&quot;source&quot;</span> | <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span> 		
  <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span> 				
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>解释</p> <ul><li><strong><code>lang</code></strong> <ul><li>Specifies the language the script is written in. Defaults to <code>painless</code>.</li></ul></li> <li><strong><code>source</code>, <code>id</code></strong> <ul><li>Specifies the source of the script. An <code>inline</code> script is specified <code>source</code> as in the example above. A <code>stored</code> script is specified <code>id</code> and is retrieved from the cluster state (see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-using.html#modules-scripting-stored-scripts" target="_self" rel="noopener noreferrer">Stored Scripts</a>).</li></ul></li> <li><strong><code>params</code></strong> <ul><li>Specifies any named parameters that are passed into the script as variables.</li></ul></li></ul> <p>例：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT my-index<span class="token number">-000001</span>/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;my_field&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

#返回结果中会对索引下的所有文档进行 my_field*<span class="token number">2</span> 的计算，返回结果保存在 _source.my_doubled_field 中
GET my-index<span class="token number">-000001</span>/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;script_fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;my_doubled_field&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;lang&quot;</span><span class="token operator">:</span>   <span class="token string">&quot;expression&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;doc['my_field'] * multiplier&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;multiplier&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

#####返回结果的部分内容
<span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;my_doubled_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token number">10.0</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><blockquote><p>ES 遇到一个新脚本时，将对其进行编译并将编译后的版本存储在缓存中。编译可能是一个繁重的过程。如果我们有相同逻辑的脚本只是参数不一样的时候，应该将它们以参数的形式传入脚本，而不是将值硬编码到脚本本身中。</p></blockquote> <ul><li>例如，如果你想让一个字段值乘以不同的乘数，不要在脚本中硬编码乘数，每一次乘数的改变都必须重新编译；</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;doc['my_field'] * 2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>更推荐的方式是，命名一个参数，在 params 选项中以参数的形式传递进脚本，这样脚本只会编译一次，然后保存在 Script Cache 中；
<ul><li>ES 默认一分钟最多编译 15 个脚本，如果在短时间内编译了太多的脚本，ES 会抛出 circuit_breaking_exception 错误，并拒绝编译新的脚本；</li> <li>可以通过修改 script.max_compilations_rate 配置，改变每分钟最大允许编译的脚本个数；</li></ul></li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;doc['my_field'] * multiplier&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;multiplier&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="short-script-form"><a href="#short-script-form" class="header-anchor">#</a> Short script form</h4> <h4 id="stored-scripts"><a href="#stored-scripts" class="header-anchor">#</a> Stored scripts</h4> <h4 id="search-template"><a href="#search-template" class="header-anchor">#</a> Search Template</h4> <h4 id="script-caching"><a href="#script-caching" class="header-anchor">#</a> Script caching</h4> <p>... ...</p> <p><em><strong>&lt;其他相关内容，参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-using.html" target="_self" rel="noopener noreferrer">官网</a>&gt;</strong></em></p> <p>​</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/BigDataAndDistributedSystem/ELK/ESIndex-TextAnalysis.html" class="prev">ES Index-Text Analysis</a></span> <span class="next"><a href="/BigDataAndDistributedSystem/ELK/ESUsage-crud.html">ES 使用-基本CRUD</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.29af2d6c.js" defer></script><script src="/assets/js/2.858e58ff.js" defer></script><script src="/assets/js/45.903efdc0.js" defer></script>
  </body>
</html>
