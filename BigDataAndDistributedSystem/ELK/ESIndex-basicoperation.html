<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES Index-基本操作与并发 | Yan&#39;s Blog Home</title>
    <meta name="description" content="Personal blog site">
    
    
    <link rel="preload" href="/assets/css/0.styles.659f981c.css" as="style"><link rel="preload" href="/assets/js/app.2ba1140b.js" as="script"><link rel="preload" href="/assets/js/2.858e58ff.js" as="script"><link rel="preload" href="/assets/js/17.72e8ffa6.js" as="script"><link rel="prefetch" href="/assets/js/10.5dcc1f52.js"><link rel="prefetch" href="/assets/js/100.0327e00b.js"><link rel="prefetch" href="/assets/js/101.404f187c.js"><link rel="prefetch" href="/assets/js/102.d78878ec.js"><link rel="prefetch" href="/assets/js/103.a682f6f1.js"><link rel="prefetch" href="/assets/js/104.d831bcb5.js"><link rel="prefetch" href="/assets/js/105.afbf1884.js"><link rel="prefetch" href="/assets/js/106.8e9709d3.js"><link rel="prefetch" href="/assets/js/107.9712aa22.js"><link rel="prefetch" href="/assets/js/108.4158fdb6.js"><link rel="prefetch" href="/assets/js/109.ae61a303.js"><link rel="prefetch" href="/assets/js/11.34e3d90e.js"><link rel="prefetch" href="/assets/js/110.0abce6c9.js"><link rel="prefetch" href="/assets/js/111.b5c958e5.js"><link rel="prefetch" href="/assets/js/112.fdacfaf6.js"><link rel="prefetch" href="/assets/js/113.9d95243d.js"><link rel="prefetch" href="/assets/js/114.f759f9b9.js"><link rel="prefetch" href="/assets/js/115.1b1f9f3d.js"><link rel="prefetch" href="/assets/js/116.1e5e62e4.js"><link rel="prefetch" href="/assets/js/117.952db9d4.js"><link rel="prefetch" href="/assets/js/118.ed9df468.js"><link rel="prefetch" href="/assets/js/119.f19ee9e0.js"><link rel="prefetch" href="/assets/js/12.cd237cda.js"><link rel="prefetch" href="/assets/js/120.24dbecef.js"><link rel="prefetch" href="/assets/js/121.0aa2d47c.js"><link rel="prefetch" href="/assets/js/122.5205ca42.js"><link rel="prefetch" href="/assets/js/123.25aa20a6.js"><link rel="prefetch" href="/assets/js/124.420b2a92.js"><link rel="prefetch" href="/assets/js/125.091331f4.js"><link rel="prefetch" href="/assets/js/126.471b335f.js"><link rel="prefetch" href="/assets/js/127.60ffdb36.js"><link rel="prefetch" href="/assets/js/128.9c5c36ef.js"><link rel="prefetch" href="/assets/js/129.36fd802b.js"><link rel="prefetch" href="/assets/js/13.de2ffe9f.js"><link rel="prefetch" href="/assets/js/130.822de8a4.js"><link rel="prefetch" href="/assets/js/131.697750e2.js"><link rel="prefetch" href="/assets/js/132.fd5faa78.js"><link rel="prefetch" href="/assets/js/133.cf327ef4.js"><link rel="prefetch" href="/assets/js/134.6cdb8690.js"><link rel="prefetch" href="/assets/js/135.906c8800.js"><link rel="prefetch" href="/assets/js/136.43585d13.js"><link rel="prefetch" href="/assets/js/137.3c7ddb41.js"><link rel="prefetch" href="/assets/js/138.e3274ead.js"><link rel="prefetch" href="/assets/js/139.7fa38b58.js"><link rel="prefetch" href="/assets/js/14.9d6406e7.js"><link rel="prefetch" href="/assets/js/140.1b026dad.js"><link rel="prefetch" href="/assets/js/141.c1adfec5.js"><link rel="prefetch" href="/assets/js/142.ed2a4a22.js"><link rel="prefetch" href="/assets/js/143.af96e2f9.js"><link rel="prefetch" href="/assets/js/144.923a7d38.js"><link rel="prefetch" href="/assets/js/145.d88163de.js"><link rel="prefetch" href="/assets/js/146.2134dd3e.js"><link rel="prefetch" href="/assets/js/147.9925c468.js"><link rel="prefetch" href="/assets/js/148.109297cc.js"><link rel="prefetch" href="/assets/js/149.ae529d47.js"><link rel="prefetch" href="/assets/js/15.fe3428fa.js"><link rel="prefetch" href="/assets/js/150.6bf9657f.js"><link rel="prefetch" href="/assets/js/151.603cf1f9.js"><link rel="prefetch" href="/assets/js/152.b64ef399.js"><link rel="prefetch" href="/assets/js/153.fd5cde7c.js"><link rel="prefetch" href="/assets/js/154.8cedd5d3.js"><link rel="prefetch" href="/assets/js/155.042308eb.js"><link rel="prefetch" href="/assets/js/156.1f58dd5a.js"><link rel="prefetch" href="/assets/js/157.69e07481.js"><link rel="prefetch" href="/assets/js/158.40b656df.js"><link rel="prefetch" href="/assets/js/159.823c56a4.js"><link rel="prefetch" href="/assets/js/16.7976352c.js"><link rel="prefetch" href="/assets/js/160.93aba24e.js"><link rel="prefetch" href="/assets/js/161.3ae7729a.js"><link rel="prefetch" href="/assets/js/162.8092cc22.js"><link rel="prefetch" href="/assets/js/163.3c82e51b.js"><link rel="prefetch" href="/assets/js/164.d358ee7b.js"><link rel="prefetch" href="/assets/js/165.60d778eb.js"><link rel="prefetch" href="/assets/js/166.54d7340a.js"><link rel="prefetch" href="/assets/js/167.5fd6aaa3.js"><link rel="prefetch" href="/assets/js/168.205929f8.js"><link rel="prefetch" href="/assets/js/169.873b90b1.js"><link rel="prefetch" href="/assets/js/170.68c49359.js"><link rel="prefetch" href="/assets/js/171.d8f93304.js"><link rel="prefetch" href="/assets/js/172.6b496cc7.js"><link rel="prefetch" href="/assets/js/173.f276a0ce.js"><link rel="prefetch" href="/assets/js/174.09cb41e2.js"><link rel="prefetch" href="/assets/js/175.c77ce8d9.js"><link rel="prefetch" href="/assets/js/176.01ab9f3f.js"><link rel="prefetch" href="/assets/js/177.2f91a2a4.js"><link rel="prefetch" href="/assets/js/178.5f0a0527.js"><link rel="prefetch" href="/assets/js/179.0d14e948.js"><link rel="prefetch" href="/assets/js/18.8264b169.js"><link rel="prefetch" href="/assets/js/180.9a15f295.js"><link rel="prefetch" href="/assets/js/181.d5bcbada.js"><link rel="prefetch" href="/assets/js/182.571b87a8.js"><link rel="prefetch" href="/assets/js/183.b87f5a38.js"><link rel="prefetch" href="/assets/js/184.90ecbd35.js"><link rel="prefetch" href="/assets/js/185.3a38f733.js"><link rel="prefetch" href="/assets/js/186.881a0fab.js"><link rel="prefetch" href="/assets/js/187.17663dea.js"><link rel="prefetch" href="/assets/js/188.471fcd9b.js"><link rel="prefetch" href="/assets/js/189.6d486653.js"><link rel="prefetch" href="/assets/js/19.e6227b20.js"><link rel="prefetch" href="/assets/js/190.357b4cc8.js"><link rel="prefetch" href="/assets/js/191.ccf9ae83.js"><link rel="prefetch" href="/assets/js/192.3ee45cf5.js"><link rel="prefetch" href="/assets/js/193.2fbcbc68.js"><link rel="prefetch" href="/assets/js/194.61d0acd9.js"><link rel="prefetch" href="/assets/js/195.33b772c3.js"><link rel="prefetch" href="/assets/js/196.7d35848a.js"><link rel="prefetch" href="/assets/js/197.4b958d27.js"><link rel="prefetch" href="/assets/js/198.dfbfba98.js"><link rel="prefetch" href="/assets/js/199.f6c7aacb.js"><link rel="prefetch" href="/assets/js/20.65ad9b00.js"><link rel="prefetch" href="/assets/js/200.6a05302e.js"><link rel="prefetch" href="/assets/js/201.be446c97.js"><link rel="prefetch" href="/assets/js/202.d058ca1d.js"><link rel="prefetch" href="/assets/js/203.ef2b609c.js"><link rel="prefetch" href="/assets/js/204.dab38ee5.js"><link rel="prefetch" href="/assets/js/21.300f7dfb.js"><link rel="prefetch" href="/assets/js/22.0ed457bc.js"><link rel="prefetch" href="/assets/js/23.9cf0f43d.js"><link rel="prefetch" href="/assets/js/24.f151ffcb.js"><link rel="prefetch" href="/assets/js/25.680a763b.js"><link rel="prefetch" href="/assets/js/26.6a5f804d.js"><link rel="prefetch" href="/assets/js/27.98408441.js"><link rel="prefetch" href="/assets/js/28.acbefbd1.js"><link rel="prefetch" href="/assets/js/29.fbd2340a.js"><link rel="prefetch" href="/assets/js/3.753236a7.js"><link rel="prefetch" href="/assets/js/30.30b44255.js"><link rel="prefetch" href="/assets/js/31.510d262b.js"><link rel="prefetch" href="/assets/js/32.c204bc79.js"><link rel="prefetch" href="/assets/js/33.5fa66039.js"><link rel="prefetch" href="/assets/js/34.6db47b26.js"><link rel="prefetch" href="/assets/js/35.fcb88dd5.js"><link rel="prefetch" href="/assets/js/36.e294e99d.js"><link rel="prefetch" href="/assets/js/37.fe541556.js"><link rel="prefetch" href="/assets/js/38.94af8189.js"><link rel="prefetch" href="/assets/js/39.e7017f9b.js"><link rel="prefetch" href="/assets/js/4.1c3159e6.js"><link rel="prefetch" href="/assets/js/40.b7a1deeb.js"><link rel="prefetch" href="/assets/js/41.ae4d7d1e.js"><link rel="prefetch" href="/assets/js/42.5dc5c7f6.js"><link rel="prefetch" href="/assets/js/43.73610732.js"><link rel="prefetch" href="/assets/js/44.2b0e19f3.js"><link rel="prefetch" href="/assets/js/45.903efdc0.js"><link rel="prefetch" href="/assets/js/46.0684656f.js"><link rel="prefetch" href="/assets/js/47.6425b35e.js"><link rel="prefetch" href="/assets/js/48.43663ba9.js"><link rel="prefetch" href="/assets/js/49.34841bc0.js"><link rel="prefetch" href="/assets/js/5.d3774f5f.js"><link rel="prefetch" href="/assets/js/50.48ce1d7e.js"><link rel="prefetch" href="/assets/js/51.1820aa29.js"><link rel="prefetch" href="/assets/js/52.5317c537.js"><link rel="prefetch" href="/assets/js/53.71b86df9.js"><link rel="prefetch" href="/assets/js/54.31ed2a5e.js"><link rel="prefetch" href="/assets/js/55.4f9933ab.js"><link rel="prefetch" href="/assets/js/56.beb74e07.js"><link rel="prefetch" href="/assets/js/57.705bc19e.js"><link rel="prefetch" href="/assets/js/58.f5fd656b.js"><link rel="prefetch" href="/assets/js/59.cc8ae217.js"><link rel="prefetch" href="/assets/js/6.f082ca37.js"><link rel="prefetch" href="/assets/js/60.fc3cf484.js"><link rel="prefetch" href="/assets/js/61.b5032b43.js"><link rel="prefetch" href="/assets/js/62.64d7637a.js"><link rel="prefetch" href="/assets/js/63.2a71075b.js"><link rel="prefetch" href="/assets/js/64.21eb4820.js"><link rel="prefetch" href="/assets/js/65.11535a8c.js"><link rel="prefetch" href="/assets/js/66.d9c62638.js"><link rel="prefetch" href="/assets/js/67.5782c958.js"><link rel="prefetch" href="/assets/js/68.35886dae.js"><link rel="prefetch" href="/assets/js/69.934aa057.js"><link rel="prefetch" href="/assets/js/7.9a79fd87.js"><link rel="prefetch" href="/assets/js/70.53c7c7a2.js"><link rel="prefetch" href="/assets/js/71.0e82b1c6.js"><link rel="prefetch" href="/assets/js/72.1da0eaf9.js"><link rel="prefetch" href="/assets/js/73.3dabc9cd.js"><link rel="prefetch" href="/assets/js/74.b2ae43f6.js"><link rel="prefetch" href="/assets/js/75.55bf2044.js"><link rel="prefetch" href="/assets/js/76.2f88e50b.js"><link rel="prefetch" href="/assets/js/77.d916e87e.js"><link rel="prefetch" href="/assets/js/78.0e80a77d.js"><link rel="prefetch" href="/assets/js/79.03bce65e.js"><link rel="prefetch" href="/assets/js/8.60d5a8a9.js"><link rel="prefetch" href="/assets/js/80.96678f59.js"><link rel="prefetch" href="/assets/js/81.75ffa4d3.js"><link rel="prefetch" href="/assets/js/82.41c1aeb7.js"><link rel="prefetch" href="/assets/js/83.16d5e455.js"><link rel="prefetch" href="/assets/js/84.195ca01f.js"><link rel="prefetch" href="/assets/js/85.d850d4dd.js"><link rel="prefetch" href="/assets/js/86.32d87d56.js"><link rel="prefetch" href="/assets/js/87.5f97a4f6.js"><link rel="prefetch" href="/assets/js/88.f5b0bbdb.js"><link rel="prefetch" href="/assets/js/89.9f9150f5.js"><link rel="prefetch" href="/assets/js/9.74db15a0.js"><link rel="prefetch" href="/assets/js/90.f69286ce.js"><link rel="prefetch" href="/assets/js/91.c9995055.js"><link rel="prefetch" href="/assets/js/92.e992da4f.js"><link rel="prefetch" href="/assets/js/93.14137340.js"><link rel="prefetch" href="/assets/js/94.c8228a63.js"><link rel="prefetch" href="/assets/js/95.bbb7ce03.js"><link rel="prefetch" href="/assets/js/96.ce87793d.js"><link rel="prefetch" href="/assets/js/97.4fdd8a0b.js"><link rel="prefetch" href="/assets/js/98.74cfc635.js"><link rel="prefetch" href="/assets/js/99.abdd1b46.js">
    <link rel="stylesheet" href="/assets/css/0.styles.659f981c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yan's Blog Home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Blog Home</a></div><div class="nav-item"><a href="/index/" class="nav-link">Technical Blog Home</a></div><div class="nav-item"><a href="https://heyan.site:8003/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Other Blog Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/comments.html" class="nav-link">留言</a></div><div class="nav-item"><a href="http://heyan.site/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Site Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据和分布式系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式系统理论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式协调服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据摄取 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据流 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据处理 Layer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据分析 Layer (OLAP)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式系统基础框架Hadoop</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Data Platform - Splunk</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Data Platform - ELK</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BigDataAndDistributedSystem/ELK/" class="sidebar-link">Data Platform - ELK</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-base.html" class="sidebar-link">ES 概念与总结</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-cluster.html" class="sidebar-link">ES 原理-分布式特性</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-index.html" class="sidebar-link">ES 原理-倒排索引</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESConcepts-AnalysisAndRelated.html" class="sidebar-link">ES 原理-分词器 &amp; 搜索相关性</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html" class="active sidebar-link">ES Index-基本操作与并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#数据的基本操作" class="sidebar-link">数据的基本操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_1-文档的-curd" class="sidebar-link">1. 文档的 CURD</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_2-bulk-api-批量增、删、改" class="sidebar-link">2. Bulk API 批量增、删、改</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_3-mget-批量读取" class="sidebar-link">3. mget 批量读取</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_4-msearch-批量条件查询" class="sidebar-link">4. msearch 批量条件查询</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_5-常见的错误返回" class="sidebar-link">5. 常见的错误返回</a></li></ul></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#读写文档的并发操作" class="sidebar-link">读写文档的并发操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_1-图解elasticsearch并发冲突问题" class="sidebar-link">1. 图解ElasticSearch并发冲突问题</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_2-图解悲观锁和乐观锁两种并发控制方案" class="sidebar-link">2. 图解悲观锁和乐观锁两种并发控制方案</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_3-图解elasticsearch内部如何基于-version进行乐观锁并发控制" class="sidebar-link">3. 图解ElasticSearch内部如何基于_version进行乐观锁并发控制</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_4-es基于-version进行乐观锁并发控制" class="sidebar-link">4. ES基于_version进行乐观锁并发控制</a></li><li class="sidebar-sub-header"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-basicoperation.html#_5-es基于external-version进行乐观锁并发控制" class="sidebar-link">5. ES基于external version进行乐观锁并发控制</a></li></ul></li></ul></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-mapping.html" class="sidebar-link">ES Index-Mapping &amp; Setting</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IndexTemplate.html" class="sidebar-link">ES Index-Index Template</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-TextAnalysis.html" class="sidebar-link">ES Index-Text Analysis</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESIndex-IngestAndScript.html" class="sidebar-link">ES Index-Ingest|Script</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESUsage-crud.html" class="sidebar-link">ES 使用-基本CRUD</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-search.html" class="sidebar-link">ES 搜索-搜索相关</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-queryDSL.html" class="sidebar-link">ES 搜索-查询DSL</a></li><li><a href="/BigDataAndDistributedSystem/ELK/ESSearch-aggregation.html" class="sidebar-link">ES 搜索-聚合</a></li></ul></section></li><li><a href="/index/" class="sidebar-link">&lt; 首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es-index-基本操作与并发"><a href="#es-index-基本操作与并发" class="header-anchor">#</a> ES Index-基本操作与并发</h1> <div class="custom-block tip"><p class="custom-block-title">转载</p> <ul><li><a href="https://www.yuque.com/xiongsanxiansheng/qfvqxo/asntd2" target="_self" rel="noopener noreferrer">https://www.yuque.com/xiongsanxiansheng/qfvqxo/asntd2</a></li></ul></div> <h2 id="数据的基本操作"><a href="#数据的基本操作" class="header-anchor">#</a> <strong>数据的基本操作</strong></h2> <h3 id="_1-文档的-curd"><a href="#_1-文档的-curd" class="header-anchor">#</a> 1. 文档的 CURD</h3> <table><thead><tr><th style="text-align:left;"><strong>Index</strong></th> <th style="text-align:left;"><strong>PUT my_index/_doc/1</strong>{&quot;user&quot;: &quot;mike&quot;, &quot;comment&quot;: &quot;You know, for search&quot;}</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>Create</strong></td> <td style="text-align:left;"><strong>PUT my_index/_create/1</strong>{&quot;user&quot;: &quot;mike&quot;, &quot;comment&quot;: &quot;You know, for search&quot;} <strong>POST</strong> <strong>my_index/_doc （不指定 ID，自动生成）</strong>{&quot;user&quot;: &quot;mike&quot;, &quot;comment&quot;: &quot;You know, for search&quot;}</td></tr> <tr><td style="text-align:left;"><strong>Read</strong></td> <td style="text-align:left;"><strong>GET</strong> <strong>my_index/_doc/1</strong></td></tr> <tr><td style="text-align:left;"><strong>Update</strong></td> <td style="text-align:left;"><strong>POST</strong> <strong>my_index/_update/1</strong>{ &quot;doc&quot;: {&quot;user&quot;: &quot;mike&quot;, &quot;comment&quot;: &quot;You know, ElasticSearch&quot;} }</td></tr> <tr><td style="text-align:left;"><strong>Delete</strong></td> <td style="text-align:left;"><strong>DELETE</strong> <strong>my_index/_doc/1</strong></td></tr></tbody></table> <ul><li>Type 名，7.x 以后，约定都用 _doc；</li> <li>Create，如果 ID 已经存在，会失败；</li> <li>Index，如果 ID 不存在，创建新的文档。否则，先删除现有文档，再创建新的文档，版本会增加；</li> <li>Update，文档必须已经存在，更新只会对相应字段做增量修改；</li> <li>Delete，不会立刻物理删除，只会将其标记为 deleted 状态，当数据越来越多的时候，在后台自动删除（细节内容参考：“<em>分片内部原理</em>”）</li></ul> <h4 id="_1-1-create-一个文档"><a href="#_1-1-create-一个文档" class="header-anchor">#</a> 1.1 Create 一个文档</h4> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-1.c242664f.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>支持自动生成文档 ID 和指定文档 ID 两种方式；</li> <li>通过调用 &quot;POST my_index/_doc&quot;，系统会自动生成 document id；</li> <li>使用 PUT my_index/<strong>_create</strong>/1 创建时，URI 中显示指定 _create，此时如果该 id 的文档已经存在，操作失败；</li></ul> <h4 id="_1-2-index-一个文档"><a href="#_1-2-index-一个文档" class="header-anchor">#</a> 1.2 Index 一个文档</h4> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-2.2bd69224.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>Index 和 Create 不一样的地方：如果文档不存在，就索引新的文档。否则现有文档会被删除，新的文档被索引。版本信息+1</li> <li>document 一旦被索引是不可变的，如果要修改 document 的内容，可以使用 Index 对 document 重新建立索引，相当于全量替换，旧的 document 被标记为 deleted，ES 会在后台适当的时候自动删除；</li> <li>Index 全量替换修改 document，每次的执行流程是这样的：
<ul><li>应用程序先发起一个 get 请求，获取到 document，展示到前台界面，供用户查看和修改；</li> <li>用户在前台界面修改数据，发送到后台；</li> <li>后台代码，会将用户修改的数据在内存中进行执行，然后封装好修改后的全量数据；</li> <li>然后发送 PUT 请求，到 es 中，进行全量替换；</li> <li>es 将老的 document 标记为 deleted，然后重新创建一个新的 document；</li></ul></li></ul> <h4 id="_1-3-update-一个文档"><a href="#_1-3-update-一个文档" class="header-anchor">#</a> 1.3 Update 一个文档</h4> <br> <div style="display:flex;"><img src="data:image/png;base64,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" alt="" align="left" style="display:block;"></div> <br> <ul><li>Update，文档必须已经存在，更新只会对相应字段做增量修改；</li> <li>Update 方法不会删除原来的文档，而是实现真正的数据更新；</li> <li>POST 方法 / Payload 需要包含在 &quot;doc&quot; 中；</li> <li>Update 可以在原文档的基础上增加字段；</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST users/_update/<span class="token number">1</span>/
<span class="token punctuation">{</span>
   <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
       <span class="token property">&quot;post_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-05-15T14:12:12&quot;</span><span class="token punctuation">,</span>
       <span class="token property">&quot;message&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;trying out Elasticsearch&quot;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>看起来，好像比较方便，每次就传递少数几个发生修改的 field 即可，不需要将全量的 document 数据发过去；</p> <blockquote><p>那么 <strong>Partial Update</strong> 的实际内部原理是怎样的，它的优点是什么呢？</p></blockquote> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-4.461e9512.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>Partial Update 相较于全量替换的优点：
<ul><li>所有的查询、修改和写回操作，都发生在 ES 中的一个 shard 内部，避免了所有的网路数据传输的开销（减少了2次网络请求），大大提升了性能；</li> <li>减少了查找和修改中的时间间隔，可以有效减少并发冲突的情况；</li></ul></li></ul> <h4 id="_1-4-get-一个文档"><a href="#_1-4-get-一个文档" class="header-anchor">#</a> 1.4 Get 一个文档</h4> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-5.05955a7e.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>找到文档，返回 HTTP 200
<ul><li>文档源信息
<ul><li>_index / _type /</li> <li>版本信息，同一个 ID 的文档，即使被删除，Version 号也会不断增加；</li> <li>_source 中默认包含了文档的所有原始信息；</li></ul></li></ul></li> <li>找不到文档，返回 HTTP 404；</li></ul> <h3 id="_2-bulk-api-批量增、删、改"><a href="#_2-bulk-api-批量增、删、改" class="header-anchor">#</a> 2. Bulk API 批量增、删、改</h3> <ul><li>支持再一次 API 调用中，对不同的索引进行操作；</li> <li>支持四种类型操作
<ul><li>Index，普通的 put 操作，可以是创建文档，也可以是全量替换文档；</li> <li>Create，PUT /index/_create/id 操作，强制创建文档；</li> <li>Update，执行的 partial update 部分更新操作；</li> <li>Delete，删除一个文档，只要一个 json 串就可以了；</li></ul></li> <li>可以在 URI 中指定 Index，也可以在请求的 Payload 中进行；</li> <li>操作中单挑操作失败，并不会影响其他操作；</li> <li>返回结果包括了每一条操作执行的结果</li></ul> <p><strong>POST</strong> <strong>_bulk</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span> <span class="token punctuation">}</span>

<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test2&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value3&quot;</span> <span class="token punctuation">}</span>

<span class="token punctuation">{</span> <span class="token property">&quot;update&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test2&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;doc&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field2&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token punctuation">{</span> <span class="token property">&quot;delete&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test2&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>除了 delete 操作，其他每一个操作需要两行，要两个 JSON 串，语法如下：
<ul><li>元素据：{ &quot;action&quot; : { &quot;metadata&quot; }}</li> <li>document 中的真实数据：{ &quot;data&quot; }</li></ul></li> <li>Bulk API 对 JSON 的语法，有严格的要求：
<ul><li>每个 JSON 不能像 JSON 对象那样进行格式换行，一个 JSON 只能作为一个字符串只能放在一行；</li> <li>同时一个 JSON 串和一个 JSON 串之间，必须有一个换行；</li></ul></li> <li>Bulk Size 最佳大小
<ul><li>bulk request 会加载到内存里，如果太大的话，性能反而会下降，因此需要反复尝试一个最佳的 bulk size；</li> <li>一般从 1000~5000 条数据开始，尝试逐渐增加。</li> <li>另外，如果看大小的话，最好是在 5~15 MB 之间；</li></ul></li></ul> <h3 id="_3-mget-批量读取"><a href="#_3-mget-批量读取" class="header-anchor">#</a> 3. mget 批量读取</h3> <ul><li><p>批量查询的好处：</p> <ul><li>就是一条一条的查询，比如说要查询100条数据，那么就要发送100次网络请求，这个开销还是很大的；</li> <li>如果进行批量查询的话，查询100条数据，就只要发送1次网络请求，网络请求的性能开销缩减100倍；</li></ul></li> <li><p>GET 请求进行查询，在 Body 中的 docs 数组里面，用 _index、_id 来定位 document；</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET _mget
<span class="token punctuation">{</span>
  <span class="token property">&quot;docs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

#URI中指定index
GET /test/_mget
<span class="token punctuation">{</span>
    <span class="token property">&quot;docs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

#指定返回的document内容部分
GET /_mget
<span class="token punctuation">{</span>
    <span class="token property">&quot;docs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;field3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;field4&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">&quot;exclude&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;user.location&quot;</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div></li> <li><p>mget 的重要性</p> <ul><li>一般来说，在进行查询的时候，如果一次性要查询多条数据的话，那么一定要用 batch 批量操作的 api；</li> <li>尽可能减少网络开销次数，可能可以将性能提升数倍，甚至数十倍，非常非常之重要；</li></ul></li></ul> <h3 id="_4-msearch-批量条件查询"><a href="#_4-msearch-批量条件查询" class="header-anchor">#</a> 4. msearch 批量条件查询</h3> <div class="language-json line-numbers-mode"><pre class="language-json"><code>### msearch 操作
POST kibana_sample_data_ecommerce/_msearch
<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match_all&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;kibana_sample_data_flights&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match_all&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_5-常见的错误返回"><a href="#_5-常见的错误返回" class="header-anchor">#</a> 5. 常见的错误返回</h3> <table><thead><tr><th><strong>问题</strong></th> <th><strong>原因</strong></th></tr></thead> <tbody><tr><td>无法连接</td> <td>网络故障或集群挂了</td></tr> <tr><td>连接无法关闭</td> <td>网络故障或节点出错</td></tr> <tr><td>429</td> <td>集群过于繁忙</td></tr> <tr><td>4xx</td> <td>请求体格式有错</td></tr> <tr><td>500</td> <td>集群内部错误</td></tr></tbody></table> <br> <br> <h2 id="读写文档的并发操作"><a href="#读写文档的并发操作" class="header-anchor">#</a> <strong>读写文档的并发操作</strong></h2> <h3 id="_1-图解elasticsearch并发冲突问题"><a href="#_1-图解elasticsearch并发冲突问题" class="header-anchor">#</a> 1. 图解ElasticSearch并发冲突问题</h3> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-6.4e8a5e04.png" alt="" align="left" style="display:block;"></div> <p>上面说的这个过程，其实就是 ES 中的并发冲突问题，会导致数据不准确：</p> <ul><li>有些场景下，其实是无所谓的，不关注这个数据不准确的事情，比如说，我们如果就只是简单的将数据写入ES，无论数据是什么样的，都可以；还有些情况下，即使是算错了，也可以；（比如文章阅读数量统计，评论数量统计）</li> <li>当并发操作 ES 的线程越来越多，或者并发请求越多；或者是读取一份数据，供用户查阅和操作的时间越长，因为这段时间里很可能数据在 ES 中已经被修改了，那么我们拿到的就是旧数据，基于旧数据去操作，后面结果肯定就错了；</li></ul> <h3 id="_2-图解悲观锁和乐观锁两种并发控制方案"><a href="#_2-图解悲观锁和乐观锁两种并发控制方案" class="header-anchor">#</a> 2. 图解悲观锁和乐观锁两种并发控制方案</h3> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-7.431ebe4a.png" alt="" align="left" style="display:block;"></div> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-8.1c21adea.png" alt="" align="left" style="display:block;"></div> <br> <p><font color="blue"> --&gt; ES 使用乐观锁并发控制方案；</font></p> <p><strong>总结：</strong></p> <ul><li><strong>悲观锁并发控制</strong> <ul><li>悲观锁的含义：我认为每次更新都有冲突的可能，并发更新这种操作特别不靠谱，我只相信只有严格按我定义的粒度进行串行更新，才是最安全的，一个线程更新时，其他的线程等着，前一个线程更新完成后，下一个线程再上。</li> <li>关系型数据库中广泛使用该方案，常见的表锁、行锁、读锁、写锁，依赖redis或memcache等实现的分布式锁，都属于悲观锁的范畴。明显的特征是后续的线程会被挂起等待，性能一般来说比较低，不过自行实现的分布式锁，粒度可以自行控制（按行记录、按客户、按业务类型等），在数据正确性与并发性能方面也能找到很好的折衷点。</li></ul></li> <li><strong>乐观锁并发控制</strong> <ul><li>乐观锁的含义：我认为冲突不经常发生，我想提高并发的性能，如果真有冲突，被冲突的线程重新再尝试几次就好了。</li> <li>Elasticsearch 默认使用的是乐观锁方案，前面介绍的 _version 字段，记录的就是每次更新的版本号，只有拿到最新版本号的更新操作，才能更新成功，其他拿到过期数据的更新失败，由客户端程序决定失败后的处理方案，一般是重试。</li></ul></li></ul> <h3 id="_3-图解elasticsearch内部如何基于-version进行乐观锁并发控制"><a href="#_3-图解elasticsearch内部如何基于-version进行乐观锁并发控制" class="header-anchor">#</a> 3. 图解ElasticSearch内部如何基于_version进行乐观锁并发控制</h3> <h4 id="_3-1-replica-shard-数据同步并发控制"><a href="#_3-1-replica-shard-数据同步并发控制" class="header-anchor">#</a> 3.1 Replica Shard 数据同步并发控制</h4> <p>在 Elasticsearch 内部，每当 primary shard 收到新的数据时，都需要向 replica shard 进行数据同步，这种同步请求特别多，并且是异步的。如果同一个 document 进行了多次修改，Shard 同步的请求是无序的，可能会出现&quot;后发先至&quot;的情况，如果没有任何的并发控制机制，那结果将无法相像。</p> <p>Shard 的数据同步也是基于内置的 _version 进行乐观锁并发控制的。</p> <p>例如 Java 客户端向 Elasticsearch 某条 document 发起更新请求，共发出3次，Java 端有严谨的并发请求控制，在 ElasticSearch 的 primary shard 中写入的结果是正确的，但 Elasticsearch 内部数据启动同步时，顺序不能保证都是先到先得，情况可能是这样，第三次更新请求比第二次更新请求先到，如下图：</p> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-9.064fd4d7.png" alt="" align="left" style="display:block;"></div> <p>如果 Elasticsearch 内部没有并发的控制，这个 document 在 replica 的结果可能是 test2，并且与 primary shard 的值不一致，这样肯定错了。<br>预期的更新顺序应该是 test1--&gt;test2--&gt;test3，最终的正确结果是 test3。那 Elasticsearch 内部是如何做的呢？<br>Elasticsearch 内部在更新 document 时，会比较一下 version，如果请求的 version 与 document 的 version 相等，就做更新，如果 document 的 version 已经大于请求的 version，说明此数据已经被后到的线程更新过了，此时会丢弃当前的请求，最终的结果为 test3。<br>此时的更新顺序为 test1--&gt;test2，最终结果也是对的。</p> <h4 id="_3-2-partial-update-乐观锁并发控制"><a href="#_3-2-partial-update-乐观锁并发控制" class="header-anchor">#</a> 3.2 Partial Update 乐观锁并发控制</h4> <br> <div style="display:flex;"><img src="/assets/img/es-index-basicoperation-10.cf15e313.png" alt="" align="left" style="display:block;"></div> <br> <ul><li>partial update 内置乐观锁并发控制
<ul><li>如果拿到的  _version 低于 partial update 操作时现有 document 的 _version，那么 es 会自动把此次 partial update fail 掉，让 partial update 失效；</li></ul></li> <li>retry_on_conflict
<ul><li>partial update 并发冲突时，如果 _version 低于现有的 document 的 _version，默认内置乐观锁会让此操作不生效；</li> <li>如果要保证此次 partial update 操作尽可能的执行成功，可以添加 retry_on_conflict 参数，进行多次更新尝试；</li> <li>retry 策略：
<ul><li>再次获取 document 数据和最新版本号；</li> <li>基于最新版本号再次去更新，如果成功那么就 ok 了；</li> <li>如果失败，重复1和2两个步骤，最多重复几次呢？可以通过 retry 那个参数的值指定，比如5次；</li></ul></li></ul></li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST myindex/_update/<span class="token number">1</span>?retry_on_conflict=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test==2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
#也可以指定_version，如果于我们要求的version不一致，就会返回错误，再根据需求自己决定下一步操作
POST myindex/_update/<span class="token number">1</span>?version=<span class="token number">2</span>&amp;retry_on_conflict=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test==2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-es基于-version进行乐观锁并发控制"><a href="#_4-es基于-version进行乐观锁并发控制" class="header-anchor">#</a> 4. ES基于_version进行乐观锁并发控制</h3> <p><strong>旧版本</strong>的 elasticsearch 是用 version 来解决并发问题，采用乐观锁的方式，比较更新时的 version 是否相同来决定能不能更新。但是在新版本 elasticsearch <strong>7.x</strong> 再使用 version 就会报上述问题；</p> <blockquote><p><strong>新版本</strong>用的是 _seq_no 和 _primary_term 两个字段来代替 version 处理并发问题，在查询文档时，这两个字段会返回。</p></blockquote> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET myindex/_doc/<span class="token number">1</span>
#返回结果
<span class="token punctuation">{</span>
  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;myindex&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;found&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test_field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test==2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
#新版本使用 if_seq_no、if_primary_term 参数来代替version做版本控制
PUT myindex/_doc/<span class="token number">1</span>?if_seq_no=<span class="token number">3</span>&amp;if_primary_term=<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test test333&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_5-es基于external-version进行乐观锁并发控制"><a href="#_5-es基于external-version进行乐观锁并发控制" class="header-anchor">#</a> 5. ES基于external version进行乐观锁并发控制</h3> <ul><li>external version：
<ul><li>es 提供了一个 feature，就是说，你可以不用它提供的内部 _version 版本号来进行并发控制，可以基于你自己维护的一个版本号来进行并发控制。</li> <li>举个列子，假如你的数据在 mysql 里也有一份，然后你的应用系统本身就维护了一个版本号，无论是什么，如自己生成的、或程序控制的。这个时候，你进行乐观锁并发控制的时候，可能并不是想要用 es 内部的 _version 来进行控制，而是用你自己维护的那个 version 来进行控制。</li></ul></li></ul> <p><strong>基于 _version</strong>：<code>?version=1</code><br><strong>基于 external version</strong>：<code>?version=1&amp;version_type=external</code></p> <ul><li>两者的区别在
<ul><li>_version：只有当你提供的 version 与 es 中的 _version 一模一样的时候，才可以进行修改，只要不一样，就报错；</li> <li>当 version_type=external 的时候，只有当你提供的 version 比 es 中的 _version 大的时候，才能完成修改；</li></ul></li></ul> <p>es，_version=1，?version=1，才能更新成功；<br>es，_version=1，?version&gt;1&amp;version_type=external，才能成功，比如 version=2；</p> <blockquote><p>经过测试，external version 版本控制方案在新老版本中都可以使用。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/BigDataAndDistributedSystem/ELK/ESConcepts-AnalysisAndRelated.html" class="prev">ES 原理-分词器 &amp; 搜索相关性</a></span> <span class="next"><a href="/BigDataAndDistributedSystem/ELK/ESIndex-mapping.html">ES Index-Mapping &amp; Setting</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2ba1140b.js" defer></script><script src="/assets/js/2.858e58ff.js" defer></script><script src="/assets/js/17.72e8ffa6.js" defer></script>
  </body>
</html>
